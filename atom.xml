<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>蒙珣的博客</title>
  
  <subtitle>上帝为锤炼生命，将布设下一个残酷的谜语。</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-01-17T14:22:23.359Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>蒙珣</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>反馈与触发器</title>
    <link href="http://example.com/2025/01/17/%E5%8F%8D%E9%A6%88%E4%B8%8E%E8%A7%A6%E5%8F%91%E5%99%A8/"/>
    <id>http://example.com/2025/01/17/%E5%8F%8D%E9%A6%88%E4%B8%8E%E8%A7%A6%E5%8F%91%E5%99%A8/</id>
    <published>2025-01-17T09:55:40.000Z</published>
    <updated>2025-01-17T14:22:23.359Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><p>非常重要的一章内容，相对之前章节也要更难一些。可以参考b站视频辅助学习</p><p><a href="https://www.bilibili.com/video/BV1oL411D77D?spm_id_from=333.788.videopod.sections&vd_source=7edae3cd790e850cc7836ab5c5d9ac4b">锁存器与触发器详解合集</a></p><span id="more"></span><h3><span id="2-1选择器">2-1选择器</span></h3><p>2-1选择器使用了8个如下所示的电路。</p><p><img src="00.png"></p><p>如果选择端(Select)输入是1，那么或门的输出和B端的输入就是一致的。这是因为上面与门的输出和B端输入是一样的，而下面与门的输出是0。类似的，如果选择端的输入是0，那么或门的输出则和A端输入一致。总结起来如下表所示。</p><p><img src="000.png"></p><h3><span id="反馈与触发器feedback-amp-flip-flop">反馈与触发器（feedback &amp; Flip-Flop）</span></h3><h4><span id="振荡器oscillator">振荡器（oscillator）</span></h4><p>我们可以下图这个继电器来实现一个蜂鸣器。当继电器开关闭合后，金属簧片就会上下跳动——电路也会随之连通或断开——声音也就会随之发出。</p><p><img src="01.png"></p><br><p><img src="02.png"></p><br><p><img src="03.png"></p><p>闭合开关导致，导致电磁铁产生磁性，将金属簧片拉下来。当金属簧片断开时，电路也就不联通了。此时，因为物理结构，金属簧片又会弹回原位，导致电路再次连通。即我们就形成了一个蜂鸣器（需要你在簧片上绑一个小锤子，旁边再放一个锣）</p><p>此电路可以简化为一个反向器。</p><p><img src="04.png"></p><p>当反向器输入0时，他就输出1；当输入1时，输出就为0。电路中的开关一旦闭合，反向器中的继电器就会在连通与断开这两种状态之间反复交替。你也可以将电路中的开关省去，这样就可以使反向器连续地工作，如下所示。</p><p><img src="05.png"></p><p>电路的输出是什么呢？其实就是要么提供电压，要么不提供电压，在两者之间切换。我们也可以换种方式来表达——输出结果要么是0，要么是1。</p><p>我们把这种电路称为振荡器(oscillator)，振荡器却在不需要人干涉的情况下，可以完全自发地工作。振荡器有着举足轻重的作用。<strong>为了使不同组件同步工作，所有计算机都配备着某种振荡器。</strong></p><p><img src="06.png"></p><p>这幅图表示随着时间的推移，振荡器的输出在0和1之间按照固有的规律交替变化。正因为这一点，<strong>振荡器又经常被称为时钟(clock)，通过振荡进行计数也是一种计时方式。</strong></p><p><img src="07.png"></p><p>周期的倒数就是振荡器的频率(frequency)。在这个例子中振荡器的周期是0.05s，那么其频率就是1÷0.05s，即振荡器每秒钟产生20次循环，而相应的输出每秒钟也变化20次。<strong>因此振荡器的频率就是20赫兹，记做20 Hz</strong></p><h4><span id="反馈与触发器feedback-amp-flip-flop">反馈与触发器（feedback &amp; Flip-Flop）</span></h4><p>让我们来回顾一下或非门的逻辑。只有在两端输入都没有电压时输出才有电压</p><table><thead><tr><th align="center">NOR</th><th align="center">0</th><th align="center">1</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">1</td><td align="center">0</td></tr><tr><td align="center">1</td><td align="center">0</td><td align="center">0</td></tr></tbody></table><p>下面是一个包含两个或非门、两个开关和一个灯泡的电路。</p><p><img src="08.png"></p><p>值得注意的是这种特殊的弯曲的连线方式：<font color="orange"><strong>左边或非门的输出是右边或非门的输入，而右边或非门的输出是左边或非门的输入。这种连接方式我们称之为反馈(feedback)。</strong></font>系统的输出返回给输入这种形式和我们在振荡器中讨论的情况很相似</p><p>初始情况下，两个输入都是0。当我们闭合上面的开关时，左边的或非门立刻输出0，右边的或非门输出也会变为1，这时灯泡被点亮。</p><p><img src="09.png"></p><p>但是当我们在打开上面的开关时，灯泡依然点亮。并且，无论我们怎么<strong>调整上面的开关</strong>灯泡依然点亮，究其原因可以发现这是由于左边或非门的输出一直为0。</p><p><img src="10.png"></p><p>当我们闭合下面的开关时，右边或非门的输入中有一个立刻变为1，其输出就相应地变为0，灯泡随之熄灭。左边或非门的输出此刻变为1。这时你再去断开下面的开关就会发现，灯泡一直处在熄灭状态。</p><p>在两个开关都断开的状态下，灯泡有时亮着，有时却不亮。<font color="orange">两个开关都断开时，电路有两个稳定态，这类电路统称为触发器(Flip-Flop)</font></p><p><strong>触发器电路可以保持信息，它可以“记住”某些信息</strong>。特别地，对于本章先前所讲述的触发器，<strong>它可以记住最近一次是哪个开关先闭合</strong>。如果你遇到这样一种触发器，如果它的灯泡是亮着的，你就可以推测出最后一次连通的是上面的开关；而如果灯泡不亮则可推测出最后一次连通的是下面的开关。</p><p><strong>它们可以让电路“记住”之前发生了什么事情。一个能计数的电路（本章后面要讲到）必定需要触发器。</strong></p><h3><span id="r-sreset-set复位置位触发器">R-S(Reset-Set，复位/置位)触发器</span></h3><p>我们通常把两个非或门绘制成另一种形式，加上标识符就得到了下面这幅图。</p><p><img src="12.png"></p><p>我们通常用Q来表示用于点亮灯泡的输出的状态。另一个输出 $\overline{Q}$（读做Q反）是对 Q 的取反。Q是0，$$\overline{Q}$$ 就是1，反之亦然。输入端S(Set)用来置位，R(Reset)用来复位。你可以把“置位”理解为把Q设为1，而“复位”是把Q设为0。当状态S为1时（对应于先前触发器中上面的开关闭合的情况），此时Q变为1而 $$\overline{Q}$$ 变为0；当R状态为1时（对应于前面图中闭合下面的开关的情况），此时Q变为0而 $$\overline{Q}$$ 变为1。当S和R均为0时，输出保持Q原来的状态不变。我们把结论总结如下表所示。</p><table><thead><tr><th align="center">输入</th><th align="center"></th><th align="center">输出</th><th align="center"></th></tr></thead><tbody><tr><td align="center">S</td><td align="center">R</td><td align="center">Q</td><td align="center">$$\overline{Q}$$</td></tr><tr><td align="center">1</td><td align="center">0</td><td align="center">1</td><td align="center">0</td></tr><tr><td align="center">0</td><td align="center">1</td><td align="center">0</td><td align="center">1</td></tr><tr><td align="center">0</td><td align="center">0</td><td align="center">Q</td><td align="center">$$\overline{Q}$$</td></tr><tr><td align="center">1</td><td align="center">1</td><td align="center">禁止</td><td align="center">禁止</td></tr></tbody></table><p>如果S、R状态同时为1时，Q和 $$\overline{Q}$$ 均会为零，这与Q和 $$\overline{Q}$$ 互反的假设关系相矛盾。所以当使用R-S触发器进行电路设计时，R、S输入同时为1的情况一定要避免。</p><p>R-S触发器可以简化为带有输入和输出标志的小框图，就像下面画的这样</p><p><img src="13.png"></p><p><font color="orange">R-S触发器最突出的特点在于，它可以记住哪个输入端的最终状态为1</font>。但是有时候我们需要一种记忆能力更加强大的电路，例如能记住在某个特定时间点上的一个信号是0还是1。</p><h3><span id="d型触发器">D型触发器</span></h3><p>在构造具备这种功能的电路之前，让我们先来思考一下它的具体行为。这个电路存在两个输入。其中一个我们称之为数据端(Data)。与所有数字信号一样，数据端取值为0或1；另一个输入被称为保持位(Hold That Bit)，保持位的作用就是使当前的状态被“记住”，通常情况下保持位被设置为0，在这种情况下数据端对电路不产生影响。当保持位置1时，数据端的值就会在电路系统中被“记住”。随后保持位又置为0，这时电路已经“记住”了数据端的最后一次输入，而之后数据端的输入无论如何变化都不会对电路产生影响。</p><p>我们可以把状态转化的过程以真值表的形式表示如下。</p><table><thead><tr><th align="center">输入</th><th align="center"></th><th align="center">输出</th></tr></thead><tbody><tr><td align="center">数据</td><td align="center">保持位</td><td align="center">Q</td></tr><tr><td align="center">0</td><td align="center">1</td><td align="center">0</td></tr><tr><td align="center">1</td><td align="center">1</td><td align="center">1</td></tr><tr><td align="center">X</td><td align="center">0</td><td align="center">Q</td></tr></tbody></table><p>X表示“其取值情况与结果无关”，只要保持位的值为0，那么数据位对电路的输出没有影响，电路的输出和其前一个状态相同</p><p>我们的电路需要在输入端增加两个与门，下图所给出了该系统的实现电路。</p><p><img src="14.png"></p><p>当保持位信号为1时，这套电路系统就和先前讲过的R-S触发器功能一致。</p><p>但我们需要改造一下这个触发器，我们只想要两个输入，而非三个输入。真正有意义的输入可以是S为0, R为1或者是R为0, S为1的情形。如果把数据端信号看做置位信号，把它取反后的值看做复位端信号，我们可以画出相应的电路图如下所示。</p><p><img src="15.png"></p><p>这个电路称为电平触发的D型触发器，D(Data)表示数据端输入。所谓电平触发是指当保持位输入为某一特定电平（本例中为“1”）时，触发器才保存数据端的输入值（很快，我们将看到另一种形式的触发器）</p><h3><span id="电平触发的d型锁存器">电平触发的D型锁存器</span></h3><p>通常情况下，输入端不会被标记为保持为，而是被标记为时钟（clock）。现在这个时钟仅仅用来指示什么时候保存数据。</p><p><img src="16.png"></p><p>通常把数据端简写为D，时钟端简写为Clk，其功能表如下所示。</p><p><img src="17.png"></p><p>这个电路也就是所谓的电平触发的D型锁存器，它表示电路锁存住一位数据并保持它，以便将来使用。这个电路也可以被称为1位存储器。</p><p>我们在一个小盒子里布置8个锁存器，如前所述，每个锁存器包括两个或非门、两个与门以及一个反相器。所有的时钟输入端都互相连在一起。结果如下图所示。</p><p><img src="18.png"></p><p>这个锁存器可以一次保存8位数。上面的8个输入端依次标记为D0～D7，下面的8个输出端被标记为Q0～Q7。左边的输入是时钟(Clk)，时钟信号通常为0。当时钟信号为1时，D端输入的8位值被送到Q端输出。当时钟信号为0时，这8位值将保持不变，直到时钟信号再次被置1。</p><p>也可以将8位锁存器的8个数据输入端和8个Q输出端画为两组线，如下图所示</p><p><img src="19.png"></p><p>我们可以改进我们的加法器（暂不考虑减法），8位加法器的8个S输出端既与灯泡相连，又连接到8位锁存器的数据(D)输入端。标记为“保存”(Save)的开关是锁存器的时钟输入，用来存放加法器的运算结果。</p><p><img src="20.png"></p><p>改进后的加法器包含了8个2-1选择器。但是加法器不能很好地处理进位输出(CO)信号。如果两个数的相加使得进位输出信号为1，那么当下个数被加进来的时候，这个信号将被忽略掉。一个可能的解决方案是将加法器、锁存器、选择器均设置为16位宽，或者至少应该比你可能遇到的最大的和的位数多一位。这个问题留到第17章具体讲述。</p><p>对于加法器而言，我们有一个更好的改进方法，就是去掉一整排的8个开关。但是我们需要先对D触发器做一些修改，为它加一个或门和一个称为清零(Clear)的输入信号。清零信号通常为0，但当它为1时，Q输出为0，如下图所示。</p><p><img src="21.png"></p><p>无论其他信号是什么，清零信号总是强制使Q输出为0，以达到使触发器清零的目的。</p><p><font color="orange">注意，标识为“相加”(Add)的开关现在控制着锁存器的时钟输入。</font></p><p>你可能会发现这个加法器比前面的那个好用，特别是当你需要加上一长串数字时。首先按下清零开关，这个操作会使锁存器的输出为0，并且熄灭了所有的灯泡，同时使8位加法器的第2行输入全为0。然后，通过开关输入第一个加数，并且闭合“相加”开关，这个加数的值就反映在灯泡上。再输入第二个加数并再次闭合“相加”开关。由开关输入的8位操作数加到前面的结果上，所得的和体现到灯泡上。反复如此操作，可以连续进行很多次加运算。</p><p><img src="22.png"></p><h3><span id="边沿触发器edge-triggered">边沿触发器（edge-triggered）</span></h3>]]></content>
    
    
    <summary type="html">&lt;script type=&quot;text/javascript&quot; src=&quot;https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js&quot;&gt;&lt;/script&gt;

&lt;p&gt;非常重要的一章内容，相对之前章节也要更难一些。可以参考b站视频辅助学习&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.bilibili.com/video/BV1oL411D77D?spm_id_from=333.788.videopod.sections&amp;vd_source=7edae3cd790e850cc7836ab5c5d9ac4b&quot;&gt;锁存器与触发器详解合集&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="编码——隐匿在计算机软硬件背后的语言" scheme="http://example.com/tags/%E7%BC%96%E7%A0%81%E2%80%94%E2%80%94%E9%9A%90%E5%8C%BF%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%BD%AF%E7%A1%AC%E4%BB%B6%E8%83%8C%E5%90%8E%E7%9A%84%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>如何实现减法——求补器</title>
    <link href="http://example.com/2025/01/17/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%87%8F%E6%B3%95%E2%80%94%E2%80%94%E6%B1%82%E8%A1%A5%E5%99%A8/"/>
    <id>http://example.com/2025/01/17/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%87%8F%E6%B3%95%E2%80%94%E2%80%94%E6%B1%82%E8%A1%A5%E5%99%A8/</id>
    <published>2025-01-17T06:47:14.000Z</published>
    <updated>2025-01-17T08:17:16.989Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h4><span id="改进加法器实现减法操作">改进加法器，实现减法操作</span></h4><p>减法没有进位机制，而是使用到了借位。但是通过一连串逻辑电路实现借位机制比较麻烦，那么我们如何避免发生借位，而有能实现减法呢？</p><blockquote><p>例如：计算 253 - 176</p></blockquote><p>我们可以先加上1000，再减去1000来实现。但是1000-176还是有借位，于是我们可以拆分为999+1的形式。即：</p><blockquote><p>253 - 176 = 253 + (999 - 176) +1 - 1000 = 77</p></blockquote><p>其实上面这个例子就是在求补码，通过补码来计算减法</p><blockquote><p>两数相减=被减数 + 减数求补码</p></blockquote><span id="more"></span><p><strong>如果被减数小于减数呢？</strong></p><blockquote><p>例如：计算 176 - 253</p></blockquote><p>还是同样的操作，即：</p><blockquote><p>176 - 253 = 176 + (999 - 253) + 1 - 1000 = -77</p></blockquote><p>当然，在计算机中我们需要用二进制来表示他们，可以自行转换成二进制计算。需要注意的是我们目前没办法表示负数，所以二进制得到的结果为77，即 01001101</p><p>这样我们就能改进上一章的加法器了，<font color="orange"><strong>为了避免问题太复杂，这个新的加/减法器只执行减数小于被减数的减法操作，即结果为正数的操作。</strong></font></p><p>下图为我们之前的加法器：</p><p><img src="./01.png"></p><p>而<strong>新的加/减法器可以设计为当计算减法时：减数求反码，CI(进位输入)+1，得到补码的操作</strong>。当计算加法时：CI 为0，也不求减数的反码。</p><p>对于求反，我们可以使用8个反相器来实现。</p><p><img src="./02.png"></p><p>而当运行加法运算时，我们不希望反相器工作。所以，我们还需要改进下电路。通过八个异或门来代替反相器。</p><p>当计算减法时，“取反”输出信号1。当计算加法时，“取反”输出信号0。</p><p><img src="03.png"></p><p>回想一下异或门的工作方式，如下表所示。</p><table><thead><tr><th align="center">XOR</th><th align="center">0</th><th align="center">1</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">0</td><td align="center">1</td></tr><tr><td align="center">1</td><td align="center">1</td><td align="center">0</td></tr></tbody></table><p>如果“取反”信号为1，则输出信号反置。例如，如果输入为01100001，输出则为10011110。</p><p>将8个异或门合并起来画成一个器件，称为求补器(Ones’ Complement)，如下所示</p><p><img src="04.png"></p><p>现在还需要我们的加/减法器的CO(进位输出)输出问题。</p><ol><li>当计算加法时，即出现上位溢出的情况，我们需要将CO位输出1，即计算结果大于255，该结果需要舍弃</li><li>当计算减法时。当被减数大于减数，我们可以正常得出结果。当被<strong>减数小于减数</strong>，我们的结果会出现下溢的情况，该结果也需要舍弃。</li></ol><p>所以我们需要一个异或门来实现。</p><br><p>将一个求补器，一个8位二进制加法器和一个异或门做如下连接。</p><p><img src="05.png"></p><p>注意，这里三个信号都标识为“SUB”，这就是加/减法转换开关。当该信号为0的时候，其进行的是加法运算，为1时进行的则是减法运算。在减法中，输入B（第二排开关）在送入加法器之前，需先通过求补电路进行取反。此外，在做减法时，我们通过设定CI（进位输入）为1来使得结果加1。而在加法中，求补电路将不起作用，且输入CI为0。</p><hr><p>我们可以试着模拟一下这个加/减法器。</p><ol><li><p>模拟计算：253 - 176</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">253</span>的二进制码是：<span class="number">1111</span> <span class="number">1101</span></span><br><span class="line"><span class="number">176</span>的二进制码是：<span class="number">1011</span> <span class="number">0000</span></span><br><span class="line"></span><br><span class="line"><span class="number">253</span>的补码是：<span class="number">0000</span> <span class="number">0011</span></span><br><span class="line"><span class="number">176</span>的补码是：<span class="number">0101</span> <span class="number">0000</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> B输入为<span class="number">176</span>，即<span class="number">1011</span> <span class="number">0000</span>。经过求补器后（求补器中的SUB输出为<span class="number">1</span>），为<span class="number">0100</span> <span class="number">1111</span></span><br><span class="line"><span class="number">2.</span> 在加法器中，CI为<span class="number">1</span>（SUB输出<span class="number">1</span>）。</span><br><span class="line">  即<span class="number">253</span>+<span class="number">176</span>的反码+<span class="number">1</span> = <span class="number">253</span> + <span class="number">176</span>的补码 = <span class="number">253</span> - <span class="number">176</span></span><br><span class="line"></span><br><span class="line"><span class="number">253</span> - <span class="number">176</span> = <span class="number">253</span> + <span class="number">176</span>的补码</span><br><span class="line">= <span class="number">1111</span> <span class="number">1101</span> + <span class="number">0101</span> <span class="number">0000</span></span><br><span class="line">= <span class="number">1</span> <span class="number">0100</span> <span class="number">1101</span> </span><br><span class="line"></span><br><span class="line">此时CO为<span class="number">1</span>，SUB为<span class="number">1</span>（减法为<span class="number">1</span>），经过异或门输出为<span class="number">0</span>。</span><br><span class="line">最后结果为：<span class="number">0100</span> <span class="number">1101</span>，即：<span class="number">77</span></span><br></pre></td></tr></table></figure></li><li><p>模拟计算：176 - 253</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">253</span>的二进制码是：<span class="number">1111</span> <span class="number">1101</span></span><br><span class="line"><span class="number">176</span>的二进制码是：<span class="number">1011</span> <span class="number">0000</span></span><br><span class="line"></span><br><span class="line"><span class="number">253</span>的补码是：<span class="number">0000</span> <span class="number">0011</span></span><br><span class="line"><span class="number">176</span>的补码是：<span class="number">0101</span> <span class="number">0000</span></span><br><span class="line">  </span><br><span class="line"><span class="number">1.</span> A输入为<span class="number">176</span>，即：<span class="number">1011</span> <span class="number">0000</span>。B输入为<span class="number">253</span>，即：<span class="number">1111</span> <span class="number">1101</span></span><br><span class="line"><span class="number">2.</span> 减法运算，SUB输出<span class="number">1</span>，对B求反码。即：<span class="number">0000</span> <span class="number">0010.</span></span><br><span class="line"><span class="number">3.</span> <span class="number">8</span>位加法器中，SUB输出为<span class="number">1</span>，即CI为<span class="number">1</span>，<span class="number">176</span>+<span class="number">253</span>的反码+<span class="number">1</span>。</span><br><span class="line">  即<span class="number">176</span>+<span class="number">253</span>的补码 = <span class="number">1011</span> <span class="number">0000</span> + <span class="number">0000</span> <span class="number">0011</span></span><br><span class="line">  = <span class="number">1011</span> <span class="number">0011</span> = <span class="number">128</span>+<span class="number">77</span> = <span class="number">205</span></span><br><span class="line"><span class="number">4.</span> CO为<span class="number">0</span>，SUB为<span class="number">1</span>，经过XOR后，结果为<span class="number">1</span>，出现下溢。舍弃当前结果</span><br></pre></td></tr></table></figure></li></ol><h4><span id="如何表示负数">如何表示负数</span></h4><p>详细内容可以看原文，这里只简单介绍</p><p>在8位二进制中，我们可以用1开头来表示负数。</p><p><font color="orange">对于无符号的8位二进制数，表示的范围为：0 ~ 255。对于有符号的二进制数表示的范围为：-128 ~ 127</font></p><table><thead><tr><th align="center">二进制数</th><th align="center">十进制数</th></tr></thead><tbody><tr><td align="center">1000 0000</td><td align="center">-128</td></tr><tr><td align="center">1000 0001</td><td align="center">-127</td></tr><tr><td align="center">1000 0010</td><td align="center">-126</td></tr><tr><td align="center">1000 0011</td><td align="center">-125</td></tr><tr><td align="center">…</td><td align="center">…</td></tr><tr><td align="center">1111 1101</td><td align="center">-3</td></tr><tr><td align="center">1111 1110</td><td align="center">-2</td></tr><tr><td align="center">1111 1111</td><td align="center">-1</td></tr><tr><td align="center">0000 0000</td><td align="center">0</td></tr><tr><td align="center">0000 0001</td><td align="center">1</td></tr><tr><td align="center">0000 0002</td><td align="center">2</td></tr><tr><td align="center">…</td><td align="center">…</td></tr><tr><td align="center">0111 1100</td><td align="center">124</td></tr><tr><td align="center">0111 1101</td><td align="center">125</td></tr><tr><td align="center">0111 1110</td><td align="center">126</td></tr><tr><td align="center">0111 1111</td><td align="center">127</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;改进加法器，实现减法操作&quot;&gt;&lt;a href=&quot;#改进加法器，实现减法操作&quot; class=&quot;headerlink&quot; title=&quot;改进加法器，实现减法操作&quot;&gt;&lt;/a&gt;改进加法器，实现减法操作&lt;/h4&gt;&lt;p&gt;减法没有进位机制，而是使用到了借位。但是通过一连串逻辑电路实现借位机制比较麻烦，那么我们如何避免发生借位，而有能实现减法呢？&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;例如：计算 253 - 176&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们可以先加上1000，再减去1000来实现。但是1000-176还是有借位，于是我们可以拆分为999+1的形式。即：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;253 - 176 = 253 + (999 - 176) +1 - 1000 = 77&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;其实上面这个例子就是在求补码，通过补码来计算减法&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;两数相减=被减数 + 减数求补码&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="编码——隐匿在计算机软硬件背后的语言" scheme="http://example.com/tags/%E7%BC%96%E7%A0%81%E2%80%94%E2%80%94%E9%9A%90%E5%8C%BF%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%BD%AF%E7%A1%AC%E4%BB%B6%E8%83%8C%E5%90%8E%E7%9A%84%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>二进制加法器</title>
    <link href="http://example.com/2025/01/14/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8A%A0%E6%B3%95%E5%99%A8/"/>
    <id>http://example.com/2025/01/14/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8A%A0%E6%B3%95%E5%99%A8/</id>
    <published>2025-01-14T03:57:33.000Z</published>
    <updated>2025-01-17T09:54:59.125Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>关于《编码——隐匿在计算机软硬件背后的语言》这本书的一些小笔记</p><p>图片比较大，img标签有点麻烦了，谁能给我写个js哈哈哈🤦🏻‍♀️</p><p>拓展阅读：<a href="https://github.com/test-wsl/Computer-Organization/blob/master/Computer-Organization.md">https://github.com/test-wsl/Computer-Organization/blob/master/Computer-Organization.md</a></p><span id="more"></span><h3><span id="二进制加法器">二进制加法器</span></h3><p>为了实现加法器，两数操作即如下图：</p><p><img src="01.png"></p><p>我们需要一个或门和一个与非门的输出，并将结果用一个与门连接起来，这样我们就得到了两数相加的正确结果</p><p><img src="02.png"></p><p><img src="03.png"></p><p>这个电路有一个专门的名字：异或门，简称：XOR</p><table><thead><tr><th>XOR</th><th>0</th><th>1</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>0</td></tr></tbody></table><p>它的符号为</p><p><img src="04.png"></p><p>当我们把异或门和进位电路（与门）连在一起时就得到了一个半加器å</p><p><img src="05.png"></p><p>为了简化，我们将其画成如下形式</p><p><img src="06.png"></p><p>之所以叫半加器，是因为它只能做两个数相加的操作，无法将进位数加入其中进行运算。也是由其物理特性决定，只有两个输入位，以及加和输出和进位输出。</p><p>为了对三个二进制数进行加法运算，我们需要将两个半加器和一个或门做如下连接。</p><p><img src="07.png"></p><p>简化图形如下：</p><p><img src="08.png"></p><p>下面，我们将8个全加器连接起来，每个全加器的进位输出都作为下一个全加器的进位输入</p><p><img src="09.png"></p><p>下面画成一个盒子的完整的8位二进制加法器，输入标记为A<del>0</del> ~ A<del>7</del>和B<del>0</del> ~ B<del>7</del>，输出标记为S<del>0</del> ~ S<del>7</del></p><p><img src="10.png"></p><p><font color="orange">其中A<del>0</del>、B<del>0</del>、S<del>0</del> 都是最低有效位，而A<del>7</del>、B<del>7</del>、S<del>7</del>都是最高有效位</font></p><p>如果把下面一排的每个二进制位和其对应的2的幂相乘再依次相加，你就会得到0110-1001的十进制数表示64+32+8+1，即105。</p><p>当然，我们也可以把8位加法器用下图表示</p><p><img src="11.png"></p><p>一旦你搭建起了8位二进制加法器，你就可以再搭建另外一个加法器。把它们级联起来就可以很容易地扩展出一个16位加法器。</p><p><img src="12.png"></p><p>回顾一下我们所有学过的加法器：</p><p><img src="13.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;关于《编码——隐匿在计算机软硬件背后的语言》这本书的一些小笔记&lt;/p&gt;
&lt;p&gt;图片比较大，img标签有点麻烦了，谁能给我写个js哈哈哈🤦🏻‍♀️&lt;/p&gt;
&lt;p&gt;拓展阅读：&lt;a href=&quot;https://github.com/test-wsl/Computer-Organization/blob/master/Computer-Organization.md&quot;&gt;https://github.com/test-wsl/Computer-Organization/blob/master/Computer-Organization.md&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="编码——隐匿在计算机软硬件背后的语言" scheme="http://example.com/tags/%E7%BC%96%E7%A0%81%E2%80%94%E2%80%94%E9%9A%90%E5%8C%BF%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%BD%AF%E7%A1%AC%E4%BB%B6%E8%83%8C%E5%90%8E%E7%9A%84%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>构建之法——00.概论</title>
    <link href="http://example.com/2025/01/09/%E6%9E%84%E5%BB%BA%E4%B9%8B%E6%B3%95%E2%80%94%E2%80%9400-%E6%A6%82%E8%AE%BA/"/>
    <id>http://example.com/2025/01/09/%E6%9E%84%E5%BB%BA%E4%B9%8B%E6%B3%95%E2%80%94%E2%80%9400-%E6%A6%82%E8%AE%BA/</id>
    <published>2025-01-09T10:57:41.000Z</published>
    <updated>2025-01-09T11:49:45.583Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>最近试读《构建之法—现代软件工程》这本书，不知道有没有时间能看完，也不知道有没有时间能写完这本书的笔记，先记录下来吧</p><h3><span id="软件程序软件工程">软件=程序+软件工程</span></h3><p>作者通过一个很生动的实际需求例子，为我们引入了软件工程的概念。基于“<code>程序=数据结构+算法</code>”的这句名言，作者通过这个例子，给了我们两个推论：</p><center><strong>软件 = 程序 + 软件工程</strong></center><p>正式因为有了构建管理、源代码管理、软件设计、软件测试、项目管理这些软件工程的内容，才能把程序转化成一个可靠的软件。</p><center><strong>软件企业 = 软件 + 商业模式</strong></center><span id="more"></span><h4><span id="软件开发的不同阶段">软件开发的不同阶段</span></h4><p>“软件工程”自1968年被首次提出后，经历了不同的发展阶段。</p><p>作者用航空产业的阶段为我们做了一次类比：</p><ol><li>玩具阶段</li><li>业余爱好者阶段</li><li>探索阶段</li><li>成熟的产业阶段</li></ol><p>在成熟的航空工业中，一个飞机发动机从构思到最后运行，不知道要经历多少人、多少工序、多少流程、多少相关知识的验证，其实一款大型软件的开发同样如此。</p><h3><span id="软件工程是什么">软件工程是什么</span></h3><p>软件工程是把系统的、有序的、可量化的方法应用到软件的开发、运营和维护上的过程</p><p>软件工程包括下列领域：软件需求分析、软件设计、软件构建、软件测试和软件维护</p><p>软件工程和下列的学科相关：计算机科学、计算机工程、管理学、数学、项目管理学、质量管理、软件人体工学、系统工程、工业设计和用户体验设计</p><h4><span id="软件开发的难点">软件开发的难点</span></h4><ol><li><strong>复杂性（Complexity）</strong></li><li><strong>不可见性（Invisibility）</strong>：软件如何运行，bug难以排查</li><li><strong>易变性（Changeability）</strong>：用户需求不断变更，还要保证软件正常稳定运行</li><li><strong>服从性（Conformity）</strong>：软件不仅要服从操作系统、硬件、还要考虑到用户需求以及行业系统要求</li><li><strong>非连续性（Discontinuity）</strong>：软件的行为或结果对某些输入或环境条件的微小变化非常敏感，可能导致显著的输出变化或系统行为的重大改变</li></ol><h4><span id="软件工程与计算机科学的关系">软件工程与计算机科学的关系</span></h4><p>很多学校开设了软件工程专业以及计算机科学与技术专业，但他们的区别很多人都不太清楚。简单来说他们是理论与实践的关系</p><p><img src="./00/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%8E%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E4%BE%A7%E9%87%8D%E7%82%B9.png" alt="计算机科学与软件工程侧重点不同"></p><h4><span id="软件工程的知识领域">软件工程的知识领域</span></h4><ol><li><p><strong>Software Requirements</strong> - <strong>软件需求</strong></p></li><li><p><strong>Software Design</strong> - <strong>软件设计</strong></p></li><li><p><strong>Software Construction</strong> - <strong>软件构建</strong></p></li><li><p><strong>Software Testing</strong> - <strong>软件测试</strong></p></li><li><p><strong>Software Maintenance</strong> - <strong>软件维护</strong></p></li><li><p><strong>Software Configuration Management</strong> - <strong>软件配置管理</strong></p></li><li><p><strong>Software Engineering Management</strong> - <strong>软件工程管理</strong></p></li><li><p><strong>Software Engineering Process</strong> - <strong>软件工程过程</strong></p></li><li><p><strong>Software Engineering Models and Methods</strong> - <strong>软件工程模型与方法</strong></p></li><li><p><strong>Software Quality</strong> - <strong>软件质量</strong></p></li><li><p><strong>Software Engineering Professional Practice</strong> - <strong>软件工程职业实践</strong></p></li><li><p><strong>Software Engineering Economics</strong> - <strong>软件工程经济学</strong></p></li><li><p><strong>Computing Foundations</strong> - <strong>计算基础</strong></p></li><li><p><strong>Mathematical Foundations</strong> - <strong>数学基础</strong></p></li><li><p><strong>Engineering Foundations</strong> - <strong>工程基础</strong></p></li></ol><h4><span id="软件工程的目标创建足够好的软件">软件工程的目标——创建“足够好”的软件</span></h4><ol><li>用户满意度高</li><li>可靠</li><li>软件流程质量高</li><li>可维护</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近试读《构建之法—现代软件工程》这本书，不知道有没有时间能看完，也不知道有没有时间能写完这本书的笔记，先记录下来吧&lt;/p&gt;
&lt;h3 id=&quot;软件-程序-软件工程&quot;&gt;&lt;a href=&quot;#软件-程序-软件工程&quot; class=&quot;headerlink&quot; title=&quot;软件=程序+软件工程&quot;&gt;&lt;/a&gt;软件=程序+软件工程&lt;/h3&gt;&lt;p&gt;作者通过一个很生动的实际需求例子，为我们引入了软件工程的概念。基于“&lt;code&gt;程序=数据结构+算法&lt;/code&gt;”的这句名言，作者通过这个例子，给了我们两个推论：&lt;/p&gt;
&lt;center&gt;&lt;strong&gt;软件 = 程序 + 软件工程&lt;/strong&gt;&lt;/center&gt;

&lt;p&gt;正式因为有了构建管理、源代码管理、软件设计、软件测试、项目管理这些软件工程的内容，才能把程序转化成一个可靠的软件。&lt;/p&gt;
&lt;center&gt;&lt;strong&gt;软件企业 = 软件 + 商业模式&lt;/strong&gt;&lt;/center&gt;</summary>
    
    
    
    
    <category term="构建之法" scheme="http://example.com/tags/%E6%9E%84%E5%BB%BA%E4%B9%8B%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>何必缅怀</title>
    <link href="http://example.com/2025/01/09/%E4%BD%95%E5%BF%85%E7%BC%85%E6%80%80/"/>
    <id>http://example.com/2025/01/09/%E4%BD%95%E5%BF%85%E7%BC%85%E6%80%80/</id>
    <published>2025-01-09T06:10:46.000Z</published>
    <updated>2025-01-09T06:28:17.294Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>最近看到一位up在自己的blog上更新日常，那些枯燥的文章，或许也需要一些随笔的润色吧。</p><p>但，我希望我的内容没有人能看见，仅仅是记录生活而已。</p><span id="more"></span>    <div id="aplayer-RjsegcgX" class="aplayer aplayer-tag-marker meting-tag-marker" data-id="16951277" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ad7a86"></div><p><small><center>这首歌只能试听…</center></small></p><hr><p>我发现自从我只关注自我后，好像变得有点自私和素质低下了[捂脸]。对很多身边的事情也变得无所谓起来，不凑热闹，也不参与讨论，任凭命运摆布。对看不惯的人也说起了脏字，这在以前可以说从未有过</p><p>我妈妈也是这样的人，她有了自己的事业后，对于不懂她的我爸，有时候也会带一些脏字，虽然这种情况很少出现，但在我的记忆中，从来没有</p><p>今天，做了两个奇怪的梦。两个都是老生常谈的恐惧。一个是新样式的中式恐怖，还是追逐，我一如既往的逃跑，醒来后，当阳光透过窗纱，照亮我的房间，一切烟消云散，不再记得了。</p><p>另一个是怅然若失的瞬间。我梦见，我和大学室友一起去了济南。我抛下他们，与游客们一同等待，在傍晚无光的日落时分，等待一个绚丽的开场。没有得到想要的照片，当我再回头寻找，他们已不在我身旁。这一切并不难以预料，心中的失落在所难免，只得独自坐上火车离开这里。</p><p>回到寝室，已然是黄昏之时。阳光透过窗帘，为寝室添上了一层暖色。我站在窗前，看着少坤，穿着还未来得及撕下价签的西装，看见躺在被窝里有说有笑的朱和亚亚。他们好像都有着自己已定的生活轨迹与目标，看着他们，内心却难免有些失落。</p><p>大学其实是一段美好的时光，不知为何在梦中也添上了一层薄薄的雾霭。从前的梦，总是回到高中，回到考场，回到被挨骂的瞬间。从前，我一直想拯救那个时候的自己，从前，我一直想如果我能回到过去，我想拯救那个无助的自己。</p><p>可现在我并不想回到过去，他如何如何，好像与我无关。我只是静待命运到来，如同对待他人一般。</p><p>人生好像总是充满了遗憾与未知。不管当下拥有了何总资源，又站在了何种高度，总是会回想从前，总是在回望过去，总是在迷惘中不断徘徊，总是做着相同的梦。</p><p>如同以往，晨曦洒满房间。静静呆坐，回望自己。</p><p>end.</p><hr><p>我把这些都说给了一个朋友，他很有耐心的看完，或许是时机不对，他不想当情绪的垃圾桶，无可厚非。生活的压力何其重啊，向来不缺苦难与忧伤，不然短视频也不会那么爆火，需要它来麻痹神经，去碰浅显的快乐。</p><p>回想起来，自己有何尝不是如此。或许当有人能把苦难分享给你，也是对你的认可吧，但其实说起来也无足轻重啦，请过好自己的人生。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近看到一位up在自己的blog上更新日常，那些枯燥的文章，或许也需要一些随笔的润色吧。&lt;/p&gt;
&lt;p&gt;但，我希望我的内容没有人能看见，仅仅是记录生活而已。&lt;/p&gt;</summary>
    
    
    
    <category term="随笔" scheme="http://example.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="2025" scheme="http://example.com/tags/2025/"/>
    
  </entry>
  
  <entry>
    <title>2024年终总结</title>
    <link href="http://example.com/2025/01/02/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <id>http://example.com/2025/01/02/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</id>
    <published>2025-01-02T04:14:34.000Z</published>
    <updated>2025-01-02T07:02:46.709Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script>    <div id="aplayer-ScZYpSwJ" class="aplayer aplayer-tag-marker meting-tag-marker" data-id="504025917" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ad7a86"></div><br><p>回忆如潮水，过往似流波。</p><p>时常发呆，内心似死水，思绪毫无尽头。还是会梦见高中生活，惊恐万分而又怅然若失。还是会羡慕美好的爱情，可友情，亲情与爱情，纯粹的渴望，或许那只是一个乌托邦。</p><p>我所能看见的便是冷漠——我的冷漠。独行于世界之外，自私而又没有礼貌，在自我搭建的幻梦中，躲避着一切。</p><p>越是成长，道德边界与底线也越是模糊不清。关于人性的复杂争论永无休止，毫无头绪。</p><p>这一年谈论其他都有些虚假，能写下的也仅此而已。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="随笔" scheme="http://example.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="2024" scheme="http://example.com/tags/2024/"/>
    
  </entry>
  
  <entry>
    <title>穆旦诗集</title>
    <link href="http://example.com/2024/06/20/%E7%A9%86%E6%97%A6%E8%AF%97%E9%9B%86/"/>
    <id>http://example.com/2024/06/20/%E7%A9%86%E6%97%A6%E8%AF%97%E9%9B%86/</id>
    <published>2024-06-20T14:35:57.000Z</published>
    <updated>2024-06-20T15:26:19.734Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>穆旦诗集部分摘抄，或许找个时间能给通读一遍呢？</p><br><h4><span id="诗八首节选">《诗八首——节选》</span></h4><p>风暴，远路，寂寞的夜晚，</p><p>丢失，记忆，永续的时间，</p><p>所有科学不能祛除的恐惧</p><p>让我在你的怀里得到安憩</p><br><span id="more"></span><h4><span id="冥想">《冥想》</span></h4><p>1</p><p>为什么万物之灵的我们，</p><p> 遭遇还比不上一棵小树？</p><p> 今天你摇摇它，优越地微笑，</p><p> 明天就化为根下的泥土。</p><p> 为什么由手写出的这些字， </p><p>竟比这只手更长久，健壮？</p><p> 它们会把腐烂的手抛开，</p><p> 而默默生存在一张破纸上。</p><p>因此，我傲然生活了几十年，</p><p>仿佛曾做着万物的导演，</p><p>实则在它们长久的秩序下</p><p>我只当一会小小的演员。  </p><p>2</p><p>把生命的突泉捧在我手里，</p><p>我只觉得它来得新鲜，</p><p>是浓烈的酒，清新的泡沫</p><p>注入我的奔波、劳作、冒险。</p><p>仿佛前人从未经临的园地</p><p>就要展现在我的面前。</p><p>但如今，突然面对着坟墓，</p><p>我冷眼向过去稍稍回顾，</p><p>只见它曲折灌溉的悲喜</p><p>都消失在一片亘古的荒漠， </p><p>这才知道我的全部努力</p><p>不过完成了普通的生活。</p><br><h4><span id="园">《园》</span></h4><p>从温馨的泥土里伸出来的 </p><p>以嫩枝举在高空中的树丛， </p><p>沐浴着转移的金色的阳光。</p><p>水彩未干的深蓝的天穹 </p><p>紧接着蔓绿的低矮的石墙， </p><p>静静兜住了一个凉夏的清晨。</p><p>全都盛在这小小的方圆中： </p><p>那沾有雨意的白色卷云， </p><p>远栖于西山下的烦嚣小城。</p><p>如同我匆匆地来又匆匆而去， </p><p>躲在密叶里的陌生的燕子 </p><p>永远鸣啭着同样的歌声。</p><p>当我踏出这芜杂的门径， </p><p>关在里面的是过去的日子， </p><p>青草样的忧郁，红花样的青春。</p><br><h4><span id="森林之魅祭胡康河上的白骨">《森林之魅——祭胡康河上的白骨》</span></h4><p>穆旦的《森林之魅——祭胡康河上的白骨》是一首现代诗，创作于1946年。这首诗是穆旦以自身参加远征军并亲身经历”滇缅大撤退”后的深刻印象所作，抒发了诗人强烈的情感。诗中，穆旦通过对森林的拟人化描述，展现了一种原始、野性而又神秘的力量，同时也表达了对逝去生命的哀悼和对战争残酷的反思。</p><p>《森林之魅》这首诗通过戏剧化的表达手法，构建了人与森林之间的对话，揭示了自然与人类之间复杂的关系。森林在诗中既是生命的源泉，又是死亡的象征，它以一种几乎诱惑的方式，欢迎人类的到来，却又在无形中吞噬着人类的生命。诗中的”人”则代表了那些在战争中逝去的战士，他们在森林中经历了极端的饥饿、疾病和绝望，最终成为了森林的一部分。</p><p>这首诗不仅是对胡康河谷战役中牺牲烈士的纪念，也是对战争、生命和自然的深刻思考。穆旦以其独特的文学才华，将个人经历与广阔的历史背景相结合，创作出了这首充满力量和深度的诗歌作品。</p><br><p><strong>森林：</strong></p><p>没有人知道我，我站在世界的一方。</p><p>我的容量大如海，随微风而起舞，</p><p>张开绿色肥大的叶子，我的牙齿。</p><p>没有人看见我笑，我笑而无声，</p><p>我又自己倒下来，长久的腐烂，</p><p>仍旧是滋养了自己的内心。</p><p>从山坡到河谷，从河谷到群山，</p><p>仙子早死去，人也不再来，</p><p>那幽深的小径埋在榛莽下，</p><p>我出自原始，重把秘密的原始展开</p><p>那毒烈的太阳，那深厚的雨，</p><p>那飘来飘去的白云在我头顶，</p><p>全不过来遮盖，多种掩盖下的我</p><p>是一个生命，隐藏而不能移动。</p><p><strong>人：</strong></p><p>离开文明，是离开了众多的敌人，</p><p>在青苔藤蔓间，在百年的枯叶上，</p><p>死去了世间的声音。这青青杂草，</p><p>这红色小花，和花丛里的嗡营，</p><p>这不知名的虫类，爬行或飞走，</p><p>和跳跃的猿鸣，鸟叫，和水中的</p><p>游鱼，蟒和象和更大的畏惧，</p><p>以自然之名，全得到自然的崇奉，</p><p>无始无终，窒息在难懂的梦里，</p><p>我不合谐的旅程把一切惊动。</p><p><strong>森林：</strong></p><p>欢迎你来，把血肉脱尽。</p><p><strong>人：</strong></p><p>是什么声音呼唤？有什么东西</p><p>忽然躲避我？在绿叶后面</p><p>它露出眼睛，向我注视，我移动</p><p>它轻轻跟随。黑夜带来它嫉妒的沉默</p><p>贴近我全身。而树和树织成的网</p><p>压住我的呼吸，隔去我享有的天空！</p><p>是饥饿的空间，低语又飞旋，</p><p>像多智的灵魅，使我渐渐明白</p><p>它的要求温柔而邪恶，它散布</p><p>疾病和绝望，和憩静，要我依从。</p><p>在横倒的大树旁，在腐烂的叶上，</p><p>绿色的毒，你瘫患了我的血肉和深心！</p><p><strong>森林：</strong></p><p>这不过是我，设法朝你走近，</p><p>我要把你领过黑暗的门径；</p><p>美丽的一切，由我无形的掌握，</p><p>全在这一边，等你枯萎后来临。</p><p>美丽的将是你无目的眼，</p><p>一个梦去了，另一个梦来代替，</p><p>无言的牙齿，它有更好听的声音。</p><p>从此我们一起，在空幻的世界游走，</p><p>空幻的是所有你血液里的纷争；</p><p>一个长久的生命就要拥有你，</p><p>你的花，你的叶，你的幼虫。</p><p><strong>祭歌：</strong></p><p>在阴暗的树下，在急流的水边，</p><p>逝去的六月和七月，在无人的山间，</p><p>你们的身体还挣扎着想要回返，</p><p>而无名的野花已在头上开满。</p><p>那刻骨的饥饿，那山洪的冲激，</p><p>那毒虫的啮咬和痛楚的夜晚，</p><p>你们受不了要向人讲述，</p><p>如今却是欣欣的林木把一切遗忘。</p><p>过去的是你们对死的抗争，</p><p>你们死去为了要活的人们生存，</p><p>那白热的纷争还没有停止，</p><p>你们却在森林的周期内，不再听闻。</p><p>静静的，在那被遗忘的山坡上，</p><p>还下着密雨，还吹着细风，</p><p>没有人知道历史曾在此走过，</p><p>留下了英灵化入树干而滋生。</p><br><h4><span id="reference">Reference</span></h4><p>穆旦诗编年汇校</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;穆旦诗集部分摘抄，或许找个时间能给通读一遍呢？&lt;/p&gt;
&lt;br&gt;

&lt;h4 id=&quot;《诗八首——节选》&quot;&gt;&lt;a href=&quot;#《诗八首——节选》&quot; class=&quot;headerlink&quot; title=&quot;《诗八首——节选》&quot;&gt;&lt;/a&gt;《诗八首——节选》&lt;/h4&gt;&lt;p&gt;风暴，远路，寂寞的夜晚，&lt;/p&gt;
&lt;p&gt;丢失，记忆，永续的时间，&lt;/p&gt;
&lt;p&gt;所有科学不能祛除的恐惧&lt;/p&gt;
&lt;p&gt;让我在你的怀里得到安憩&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    <category term="随笔" scheme="http://example.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="2024" scheme="http://example.com/tags/2024/"/>
    
  </entry>
  
  <entry>
    <title>德米安-埃米尔·辛克莱的彷徨少年时</title>
    <link href="http://example.com/2024/05/27/%E5%BE%B7%E7%B1%B3%E5%AE%89-%E5%9F%83%E7%B1%B3%E5%B0%94%C2%B7%E8%BE%9B%E5%85%8B%E8%8E%B1%E7%9A%84%E5%BD%B7%E5%BE%A8%E5%B0%91%E5%B9%B4%E6%97%B6/"/>
    <id>http://example.com/2024/05/27/%E5%BE%B7%E7%B1%B3%E5%AE%89-%E5%9F%83%E7%B1%B3%E5%B0%94%C2%B7%E8%BE%9B%E5%85%8B%E8%8E%B1%E7%9A%84%E5%BD%B7%E5%BE%A8%E5%B0%91%E5%B9%B4%E6%97%B6/</id>
    <published>2024-05-26T16:43:55.000Z</published>
    <updated>2024-05-26T16:47:04.506Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>黑塞的书一如既往的难读啊…</p><p>去年的《悉达多》就只了解了个大概，今年的《德米安》依旧如此…</p><p>希望未来能有时间把它们重新再拾起来吧</p><blockquote><p>人的一生是自我寻觅的过程，在大大小小的路途上尝试并获得启示，没有人能得到完美的结局。然而，每个人都在朝着它努力，或愚笨或明晰，尽着自己的所能。我们无法摆脱自己出生的痕迹，身体背负着史前世界的黏液和蛋壳，直到永恒的终点。有些生命永远无法进化为人，它们止于青蛙、蜥蜴和蚂蚁，有的则人鱼各半。但我们都是自然之子，都在迈向人类的路途中，起源和母体一样，来自同一个黑洞，努力从生命深处爬向自己的目标。我们可以相互理解，但自我的诠释却只能亲力亲为。</p></blockquote><span id="more"></span><p>当你无法对抗与生俱来的荒蛮与动物性，也就无法进化成为人，止于青蛙、蜥蜴和蚂蚁</p><p>人性并非全然的善，这也是我们第一步需要认知到的问题，而书中与克罗莫的遭遇，就很好的诠释了这一点。即动物性与荒蛮性是人性所构成的一部分，当它被我们所深知之后，我们才能更好的追求文明，理性的意义也才被我们所深知——当你深知自身的黑暗之后，才能更好与之对抗</p><p>在当我连被克罗莫霸凌的事实都没勇气说出口时，德米安却悄无声息的帮我解决了这个问题</p><blockquote><p>“我先回家了。”他在雨中将大衣领子拉紧，说，“我只想再告诉你，事已至此，你必须摆脱这家伙！如果没别的办法，就打死他，那样我会对你刮目相看的。我也会帮你。”<br>我突然想到了该隐，感到很恐怖，开始轻轻啜泣。周围的世界太可怕。</p></blockquote><p>可悲的是这时的我连面对的勇气都没有，也无法承认世界的另一半黑暗，无法承认自身的欲望，无法驾驭自身的动物性，更无法辨认和使用。这在我儿时的生活中是不曾接触的，儿时的世界仅有善的一半。</p><blockquote><p>只要我们满心期盼，只要这个愿望真正萦回于我们全部的生命，我们就能拥有足够强大的意志去实施它。一旦如此，一旦人按照内心的命令去尝试，就能实现愿望，驾驭意志，宛如驾驭一匹良驹。</p></blockquote><p>只有我们自身的理性能力，我们的辨证思维能打败我们心中的克罗莫——我们的境界和我们的胸怀是需要向善的方式去完成的，但是我们的智慧和我们的坚强，却是需要有直面恶的力量去完成的</p><blockquote><p>有勇气和个性的人，在他人看来总是骇人。这种具备无畏又骇人特质的人四处行走，让人极为不适。于是人们给这种人起绰号，杜撰寓言。为了报复他们，也为稍许掩饰自己流露的恐惧——你懂吗？”</p><p>我认为，该隐是个卓越的人。人们因为怕他，才编出这种故事。这个故事是谣言，就像人们四处嚼舌的传闻。但有一点是真的，该隐和他的后裔的确携有某种‘记号’，有别于大多数人。”</p><p>我们拥有一个可以仰慕的上帝，但他只展示世界的一半——那个公开规矩的光明世界。而我们应该崇拜的是一个完整的世界，既是上帝也是魔鬼的神。阿布拉克萨斯就是这样一个神。</p></blockquote><p>我们需要的是听从内心理性的声音，去怀疑，去反思，而不是安逸的生活在上帝为我们打造美好的一半世界当中。当社会给予的一切规训，我们都温和的说是的，这都是对的。即用这些规训塑造自己、要求自己，而不去探讨这背后的真相，是否对我们具有其欺骗性和伤害。但那也许有另外一种真相呢！——你所信仰的这个善的世界可能只是一个谎言。</p><p>虽然我们能清楚的认知我们活在巨大的谎言之中，活在约的的欺骗之中，但又有多少人愿意走出来，愿意与之抗争呢？面对巨大的谎言，又如何得到内心的满足和自己想要的生活呢？</p><blockquote><p>飞鸟奋力欲破壳而出。蛋即世界。欲新生者必先摧毁世界。鸟儿飞向上帝，上帝之名是阿布拉克萨斯</p></blockquote><ul><li>感受痛苦</li><li>反思并质疑</li><li>抗拒与叛逆</li><li>打造属于自己的真正的自我世界</li></ul><p>当你无法感受痛苦也就不会反思，无法获得新生，即书中辛克莱在克莱莫事件中所感受到的痛苦，成为了我自救的第一步。</p><p>…待更新</p><p>Reference</p><blockquote><p><a href="https://space.bilibili.com/84102036/search/video?keyword=%E5%BE%B7%E7%B1%B3%E5%AE%89">杜素娟细读精典——德米安</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;黑塞的书一如既往的难读啊…&lt;/p&gt;
&lt;p&gt;去年的《悉达多》就只了解了个大概，今年的《德米安》依旧如此…&lt;/p&gt;
&lt;p&gt;希望未来能有时间把它们重新再拾起来吧&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;人的一生是自我寻觅的过程，在大大小小的路途上尝试并获得启示，没有人能得到完美的结局。然而，每个人都在朝着它努力，或愚笨或明晰，尽着自己的所能。我们无法摆脱自己出生的痕迹，身体背负着史前世界的黏液和蛋壳，直到永恒的终点。有些生命永远无法进化为人，它们止于青蛙、蜥蜴和蚂蚁，有的则人鱼各半。但我们都是自然之子，都在迈向人类的路途中，起源和母体一样，来自同一个黑洞，努力从生命深处爬向自己的目标。我们可以相互理解，但自我的诠释却只能亲力亲为。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="书评" scheme="http://example.com/categories/%E4%B9%A6%E8%AF%84/"/>
    
    
    <category term="2024" scheme="http://example.com/tags/2024/"/>
    
  </entry>
  
  <entry>
    <title>Python之常用设计模式</title>
    <link href="http://example.com/2024/05/03/Python%E4%B9%8B%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/2024/05/03/Python%E4%B9%8B%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</id>
    <published>2024-05-03T14:24:30.000Z</published>
    <updated>2024-05-15T15:58:29.148Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h3><span id="简单工厂设计模式">简单工厂设计模式</span></h3><p>内容：不直接向客户端暴露对象创建的实现细节，而是通过一个工厂类来负责创建产品类的实例</p><p>角色：</p><ul><li>抽象工厂角色（Creator）</li><li>具体工厂角色（Concrete Creator）</li><li>具体产品角色（Concrete Product）</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Payment</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Alipay</span>(<span class="params">Payment</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, use_huabei=<span class="literal">False</span></span>):</span></span><br><span class="line">        self.use_huabei = use_huabei</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.use_huabei:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;花呗支付%d元&quot;</span> % money)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;支付宝支付%d元&quot;</span> % money)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatPay</span>(<span class="params">Payment</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;微信支付%d元&quot;</span> % money)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankPay</span>(<span class="params">Payment</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;银行卡支付%d元&quot;</span> % money)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentFactory</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_payment</span>(<span class="params">self, method</span>):</span></span><br><span class="line">        <span class="keyword">if</span> method == <span class="string">&#x27;alipay&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> Alipay(use_huabei=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">elif</span> method == <span class="string">&#x27;wechat&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> WechatPay()</span><br><span class="line">        <span class="keyword">elif</span> method == <span class="string">&#x27;bankpay&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> BankPay()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;No such payment named %s&quot;</span> % method)</span><br><span class="line">        </span><br><span class="line">pf = PaymentFactory()</span><br><span class="line">p = pf.create_payment(<span class="string">&#x27;alipay&#x27;</span>)</span><br><span class="line">p.pay(<span class="number">100</span>)</span><br></pre></td></tr></table></figure><span id="more"></span><p>优点：</p><ul><li>隐藏了对象创建的实现细节</li><li>客户端不需要修改代码</li></ul><p>缺点：</p><ul><li>违反了单一职责原则，将创建逻辑几种到一个工厂类里</li><li>当添加新产品时，需要修改工厂类代码，违反了开闭原则</li></ul><h3><span id="工厂方法模式">工厂方法模式</span></h3><p>内容：定义一个用于创建对象的接口（工厂接口），让子类决定实例化那一个产品类</p><p>角色：</p><ul><li>抽象工厂角色（Creator）</li><li>具体工厂角色（Concrete Creator）</li><li>抽象产品角色（Product）</li><li>具体产品角色（Concrete Product）</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义支付类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Payment</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Alipay</span>(<span class="params">Payment</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, use_huabei=<span class="literal">False</span></span>):</span></span><br><span class="line">        self.use_huabei = use_huabei</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.use_huabei:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;花呗支付%d元&quot;</span> % money)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;支付宝支付%d元&quot;</span> % money)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatPay</span>(<span class="params">Payment</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;微信支付%d元&quot;</span> % money)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankPay</span>(<span class="params">Payment</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay</span>(<span class="params">self, money</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;银行卡支付%d元&quot;</span> % money)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工厂类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentFactory</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_payment</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayFactory</span>(<span class="params">PaymentFactory</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_payment</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Alipay(use_huabei=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatPayFactory</span>(<span class="params">PaymentFactory</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_payment</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> WechatPay()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankPayFactory</span>(<span class="params">PaymentFactory</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_payment</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">        </span><br><span class="line">pf = AliPayFactory()</span><br><span class="line">p = pf.create_payment()</span><br><span class="line">p.pay(<span class="number">100</span>)</span><br></pre></td></tr></table></figure><p>优点：</p><ul><li>每个具体产品都对应一个具体工厂类，不需要修改工厂类代码</li><li>隐藏了对象创建的实现细节</li></ul><p>缺点：</p><ul><li>每增加一个具体产品类，就必须增加一个相对应的具体工厂类</li></ul><h3><span id="抽象工厂模式">抽象工厂模式</span></h3><p>内容：定义一个工厂类接口，让工厂子类来创建一系列相关或相互依赖的对象</p><p>例如：生产一部手机，需要手机壳、CPU、操作系统三类对象进行组装，其中每类对象都有不同的种类。对每个具体工厂，分别生产一部手机所需要的三个对象</p><p>相比工厂方法模式，抽象工厂模式中的每个具体工厂都生产一套产品</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抽象的产品</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhoneShell</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhoneCPU</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhoneOS</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_os</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 具体的产品</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmallShell</span>(<span class="params">PhoneShell</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;普通手机小手机壳&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigShell</span>(<span class="params">PhoneShell</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;普通手机大手机壳&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppleShell</span>(<span class="params">PhoneShell</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;苹果手机壳&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnapDragonCPU</span>(<span class="params">PhoneCPU</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;骁龙CPU&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HuaweiCPU</span>(<span class="params">PhoneCPU</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;华为CPU&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppleCPU</span>(<span class="params">PhoneCPU</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;苹果CPU&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidOS</span>(<span class="params">PhoneOS</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_os</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;AndroidOS系统&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppleOS</span>(<span class="params">PhoneOS</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_os</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;IOS系统&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 抽象工厂</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhoneFactory</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_os</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 具体工厂</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HuaweiFactory</span>(<span class="params">PhoneFactory</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> SmallShell()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HuaweiCPU()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_os</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> AndroidOS()</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppleFactory</span>(<span class="params">PhoneFactory</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> AppleShell()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">male_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> AppleCPU()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_os</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> AppleOS()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Phone</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, shell, cpu, os</span>):</span></span><br><span class="line">        self.shell = shell</span><br><span class="line">        self.cpu = cpu</span><br><span class="line">        self.os = os</span><br><span class="line">         </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_info</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;手机信息: &quot;</span>)</span><br><span class="line">        self.shell.show_shell()</span><br><span class="line">        self.cpu.show_cpu()</span><br><span class="line">        self.os.show_os()</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_phone</span>(<span class="params">factory</span>):</span></span><br><span class="line">    shell = factory.make_shell()</span><br><span class="line">    cpu = factory.make_cpu()</span><br><span class="line">    os = factory.make_os()</span><br><span class="line">    <span class="keyword">return</span> Phone(shell, cpu, os)</span><br><span class="line"></span><br><span class="line">p = make_phone(HuaweiFactory())</span><br><span class="line">p.show_info()</span><br></pre></td></tr></table></figure><p>优点：</p><ul><li>将客户端与类的具体实现相分离</li><li>每个工厂创建了一个完整的产品系列，使得易于交换产品系列</li><li>有利于产品的一致性（即产品之间的约束关系）</li></ul><p>缺点：</p><ul><li>难以支持新种类的（抽象）产品</li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;简单工厂设计模式&quot;&gt;&lt;a href=&quot;#简单工厂设计模式&quot; class=&quot;headerlink&quot; title=&quot;简单工厂设计模式&quot;&gt;&lt;/a&gt;简单工厂设计模式&lt;/h3&gt;&lt;p&gt;内容：不直接向客户端暴露对象创建的实现细节，而是通过一个工厂类来负责创建产品类的实例&lt;/p&gt;
&lt;p&gt;角色：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;抽象工厂角色（Creator）&lt;/li&gt;
&lt;li&gt;具体工厂角色（Concrete Creator）&lt;/li&gt;
&lt;li&gt;具体产品角色（Concrete Product）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; abc &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ABCMeta, abstractmethod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Payment&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;metaclass=ABCMeta&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;    @abstractmethod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;pay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, money&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;pass&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Alipay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;Payment&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;__init__&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, use_huabei=&lt;span class=&quot;literal&quot;&gt;False&lt;/span&gt;&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.use_huabei = use_huabei&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;pay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, money&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.use_huabei:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;花呗支付%d元&amp;quot;&lt;/span&gt; % money)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;支付宝支付%d元&amp;quot;&lt;/span&gt; % money)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;WechatPay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;Payment&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;pay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, money&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;微信支付%d元&amp;quot;&lt;/span&gt; % money)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BankPay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;Payment&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;pay&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, money&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;银行卡支付%d元&amp;quot;&lt;/span&gt; % money)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;PaymentFactory&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;create_payment&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, method&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; method == &lt;span class=&quot;string&quot;&gt;&amp;#x27;alipay&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; Alipay(use_huabei=&lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;elif&lt;/span&gt; method == &lt;span class=&quot;string&quot;&gt;&amp;#x27;wechat&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; WechatPay()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;elif&lt;/span&gt; method == &lt;span class=&quot;string&quot;&gt;&amp;#x27;bankpay&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; BankPay()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;raise&lt;/span&gt; TypeError(&lt;span class=&quot;string&quot;&gt;&amp;quot;No such payment named %s&amp;quot;&lt;/span&gt; % method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pf = PaymentFactory()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;p = pf.create_payment(&lt;span class=&quot;string&quot;&gt;&amp;#x27;alipay&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;p.pay(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Python" scheme="http://example.com/categories/Python/"/>
    
    <category term="设计模式" scheme="http://example.com/categories/Python/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="设计模式" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Python魔法方法</title>
    <link href="http://example.com/2024/05/01/Python%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95/"/>
    <id>http://example.com/2024/05/01/Python%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95/</id>
    <published>2024-05-01T13:46:54.000Z</published>
    <updated>2024-05-03T14:29:27.175Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>在Python中，所有以双下划线<code>__</code>包起来的方法，统称为<strong>Magic Method（魔术方法）</strong>，它是一种的特殊方法，普通方法需要调用，而魔术方法不需要调用就可以自动执行。</p><p>魔术方法在类或对象的某些事件出发后会自动执行，让类具有神奇的“魔力”。如果希望根据自己的程序定制自己特殊功能的类，那么就需要对这些方法进行重写。</p><p>Python中常用的运算符、for循环、以及类操作等都是运行在魔术方法之上的。</p><h3><span id="__doc__">__doc__</span></h3><ul><li>表示类的描述信息</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;描述类信息，这个是工具类&quot;&quot;&quot;</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(Foo.__doc__)<span class="comment"># 输出：类的描述信息</span></span><br></pre></td></tr></table></figure><span id="more"></span><h3><span id="__module__-和-__class__">__module__ 和 __class__</span></h3><ul><li><code>__module__</code>表示当前操作的对象在那个模块</li><li><code>__class__</code>表示当前操作的对象的类是什么</li></ul><p>test.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.name = <span class="string">&#x27;william&#x27;</span></span><br></pre></td></tr></table></figure><p>main.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> test <span class="keyword">import</span> Person</span><br><span class="line"></span><br><span class="line">obj = Person</span><br><span class="line"><span class="built_in">print</span>(obj.__module__)<span class="comment"># 输出 test 即：输出模块</span></span><br><span class="line"><span class="built_in">print</span>(obj.__class__)<span class="comment"># 输出 test.Person 即：输出类</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span></span><br><span class="line">&lt;class <span class="string">&#x27;test.Person&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><h3><span id="__init__">__init__</span></h3><ul><li>初始化方法，通过类创建对象时，自动触发执行</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">    self.name = name</span><br><span class="line">    self.age = <span class="number">18</span></span><br><span class="line">    </span><br><span class="line">obj = Person(<span class="string">&#x27;william&#x27;</span>)<span class="comment"># 自动执行类中的 __init__ 方法</span></span><br></pre></td></tr></table></figure><h3><span id="__del__">__del__</span></h3><ul><li>当对象在内存中被释放时，自动触发执行</li></ul><p>此方法一般无需定义，<code>__del__</code>的调用是由解释器在进行垃圾回收时自动触发执行的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h3><span id="__call__">__call__</span></h3><ul><li>对象后面加括号，触发执行</li></ul><p><code>__init__</code>方法的执行是由创建对象触发的，即：<code>对象 = 类名()</code>；而对于 <code>__call__</code>方法的执行是由对象后加括号触发的，即<code>对象()</code>或者<code>类()()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;__call__&quot;</span>)</span><br><span class="line">    </span><br><span class="line">obj = Foo()<span class="comment"># 执行 __init__</span></span><br><span class="line">obj()<span class="comment"># 执行 __call__</span></span><br></pre></td></tr></table></figure><h3><span id="__dict__">__dict__</span></h3><ul><li>类或对象中的所有属性</li></ul><p>类的实例属性属于对象；类中的类属性和方法属于类，即：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Province</span>:</span></span><br><span class="line">    country = <span class="string">&quot;China&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, count</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.count = count</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;func&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 获取类的属性，即：类属性、方法</span></span><br><span class="line"><span class="built_in">print</span>(Province.__dict__)</span><br><span class="line"><span class="comment"># 输出: &#123;&#x27;__module__&#x27;: &#x27;__main__&#x27;, &#x27;country&#x27;: &#x27;China&#x27;, &#x27;__init__&#x27;: &lt;function Province.__init__ at 0x100bd6160&gt;, &#x27;func&#x27;: &lt;function Province.func at 0x100c24f40&gt;, &#x27;__dict__&#x27;: &lt;attribute &#x27;__dict__&#x27; of &#x27;Province&#x27; objects&gt;, &#x27;__weakref__&#x27;: &lt;attribute &#x27;__weakref__&#x27; of &#x27;Province&#x27; objects&gt;, &#x27;__doc__&#x27;: None&#125;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">obj1 = Province(<span class="string">&quot;山东&quot;</span>, <span class="number">10000</span>)</span><br><span class="line"><span class="built_in">print</span>(obj1.__dict__)</span><br><span class="line"><span class="comment"># 获取 对象obj1 的属性</span></span><br><span class="line"><span class="comment"># 输出: &#123;&#x27;name&#x27;: &#x27;山东&#x27;, &#x27;count&#x27;: 10000&#125;</span></span><br><span class="line"></span><br><span class="line">obj2 = Province(<span class="string">&quot;山西&quot;</span>, <span class="number">20000</span>)</span><br><span class="line"><span class="built_in">print</span>(obj2.__dict__)</span><br><span class="line"><span class="comment"># 获取 对象obj2 的属性</span></span><br><span class="line"><span class="comment"># 输出: &#123;&#x27;name&#x27;: &#x27;山西&#x27;, &#x27;count&#x27;: 20000&#125;</span></span><br></pre></td></tr></table></figure><h3><span id="__str__">__str__</span></h3><ul><li>如果一个类定义了<code>__str__</code>方法，那么打印对象时，默认输出该方法返回值</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;william&#x27;</span></span><br><span class="line">  </span><br><span class="line">obj = Foo()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;当前对象返回值为: %s&quot;</span> %obj)<span class="comment"># 输出: william</span></span><br></pre></td></tr></table></figure><h3><span id="__repr__">__repr__</span></h3><p>函数<code>__str__</code> 用于将值转化为适于人阅读的形式，而<code>__repr__</code>转化为供解释器读取的形式，某对象没有适于人阅读的解释形式的话，<code>__str__</code>会返回与<code>__repr__</code>，所以<code>print</code>展示的都是<code>__str__</code>的格式。</p><p>默认情况下，<code>__repr__</code> 会返回和调用者有关的 <code>类名+object at+内存地址</code> (&lt;__main__.CLanguage object at 0x000001A7275221D0&gt;)信息。当然，我们还可以通过在类中重写这个方法，从而实现当输出实例化对象时，输出我们想要的信息。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CLanguage</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name = <span class="string">&quot;C语言中文网&quot;</span></span><br><span class="line">        self.add = <span class="string">&quot;http://c.biancheng.net&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;CLanguage[name=&quot;</span>+ self.name +<span class="string">&quot;,add=&quot;</span> + self.add +<span class="string">&quot;]&quot;</span></span><br><span class="line">clangs = CLanguage()</span><br><span class="line"><span class="built_in">print</span>(clangs)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLanguage[name=C语言中文网,add=http://c.biancheng.net]</span><br></pre></td></tr></table></figure><h3><span id="__getitem__-__setitem__-__delitem__">__getitem__、__setitem__、__delitem__</span></h3><ul><li>用于索引操作，如字典。已上分别表示获取、设置、删除数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;__getitem__&quot;</span>, key)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;__setitem__&quot;</span>, key, value)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;__delitem__&quot;</span>, key)</span><br><span class="line">    </span><br><span class="line">obj = Foo()</span><br><span class="line"></span><br><span class="line">result = obj[<span class="string">&#x27;k1&#x27;</span>]<span class="comment"># 自动触发执行 __getitem__</span></span><br><span class="line">obj[<span class="string">&#x27;k2&#x27;</span>] = <span class="string">&#x27;william&#x27;</span><span class="comment"># 自动触发执行 __setitem__</span></span><br><span class="line"><span class="keyword">del</span> obj[<span class="string">&#x27;k1&#x27;</span>]<span class="comment"># 自动触发执行 __delitem__</span></span><br></pre></td></tr></table></figure><p>我们可以自定义“有序字典”类，它允许我们按照元素插入的顺序进行迭代，并且同时支持通过键来访问、修改和删除元素</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderedDict</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span>  </span><br><span class="line">        self.keys = []  </span><br><span class="line">        self.values = &#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, key</span>):</span>  </span><br><span class="line">        <span class="comment"># 实现通过键访问值的功能  </span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.values:  </span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">f&quot;Key <span class="subst">&#123;key&#125;</span> not found&quot;</span>)  </span><br><span class="line">        <span class="keyword">return</span> self.values[key]  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span>  </span><br><span class="line">        <span class="comment"># 实现通过键设置值的功能，并维护键的顺序  </span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.keys:  </span><br><span class="line">            self.keys.append(key)  </span><br><span class="line">        self.values[key] = value  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span>(<span class="params">self, key</span>):</span>  </span><br><span class="line">        <span class="comment"># 实现通过键删除元素的功能，并维护键的顺序  </span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.values:  </span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">f&quot;Key <span class="subst">&#123;key&#125;</span> not found&quot;</span>)  </span><br><span class="line">        self.keys.remove(key)  </span><br><span class="line">        <span class="keyword">del</span> self.values[key]  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span>  </span><br><span class="line">        <span class="comment"># 实现迭代功能，按照键的插入顺序迭代值  </span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> self.keys:  </span><br><span class="line">            <span class="keyword">yield</span> self.values[key]  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span>  </span><br><span class="line">        <span class="comment"># 提供字符串表示形式，方便查看内容  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;OrderedDict(<span class="subst">&#123;<span class="built_in">repr</span>(<span class="built_in">dict</span>(<span class="built_in">zip</span>(self.keys, self.values)))&#125;</span>)&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 使用示例  </span></span><br><span class="line">od = OrderedDict()  </span><br><span class="line">od[<span class="string">&#x27;a&#x27;</span>] = <span class="number">1</span>  </span><br><span class="line">od[<span class="string">&#x27;b&#x27;</span>] = <span class="number">2</span>  </span><br><span class="line">od[<span class="string">&#x27;c&#x27;</span>] = <span class="number">3</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 访问元素  </span></span><br><span class="line"><span class="built_in">print</span>(od[<span class="string">&#x27;b&#x27;</span>])  <span class="comment"># 输出: 2  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 修改元素  </span></span><br><span class="line">od[<span class="string">&#x27;b&#x27;</span>] = <span class="number">20</span>  </span><br><span class="line"><span class="built_in">print</span>(od[<span class="string">&#x27;b&#x27;</span>])  <span class="comment"># 输出: 20  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 删除元素  </span></span><br><span class="line"><span class="keyword">del</span> od[<span class="string">&#x27;c&#x27;</span>]  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 迭代元素  </span></span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> od:  </span><br><span class="line">    <span class="built_in">print</span>(value)  <span class="comment"># 输出: 1 和 20（按插入顺序）  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 查看内容  </span></span><br><span class="line"><span class="built_in">print</span>(od)  <span class="comment"># 输出: OrderedDict(&#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: 20&#125;)</span></span><br></pre></td></tr></table></figure><p>在这个例子中，<code>OrderedDict</code> 类使用两个内部数据结构：一个列表 <code>keys</code> 用于保存键的插入顺序，一个字典 <code>values</code> 用于保存键值对。通过实现 <code>__getitem__</code>、<code>__setitem__</code> 和 <code>__delitem__</code> 方法，我们可以像操作普通字典一样操作 <code>OrderedDict</code> 实例，同时还保留了元素的插入顺序。</p><h3><span id="__getslice__-__setslice__-__delslice__">__getslice__、__setslice__、__delslice__</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__getslice__</span>(<span class="params">self, i, j</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;__getslice__&#x27;</span>, i, j)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__setslice__</span>(<span class="params">self, i, j, sequence</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;__setslice__&#x27;</span>, i, j)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__delslice__</span>(<span class="params">self, i, j</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;__delslice__&#x27;</span>, i ,j)</span><br><span class="line">    </span><br><span class="line">obj = Foo()</span><br><span class="line"></span><br><span class="line">obj[-<span class="number">1</span>:<span class="number">1</span>]<span class="comment"># 自动触发执行 __getslice__</span></span><br><span class="line">obj[<span class="number">0</span>:<span class="number">1</span>] = [<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>]<span class="comment"># 自动触发执行 __setslice__</span></span><br><span class="line"><span class="keyword">del</span> obj[<span class="number">0</span>:<span class="number">2</span>]<span class="comment"># 自动触发执行 __delslice__</span></span><br></pre></td></tr></table></figure><h3><span id="__iter__和__next__">__iter__和__next__</span></h3><p><code>__iter__</code>它允许一个对象定义自己的迭代行为。当你尝试在一个对象上使用迭代（例如，在 <code>for</code> 循环中或在内置函数如 <code>list()</code> 或 <code>sum()</code> 中）时，Python会查找这个对象是否实现了 <code>__iter__</code> 方法。</p><p><code>__iter__</code> 方法应该返回一个迭代器对象，该对象实现了 <code>__iter__</code> 和 <code>__next__</code> 方法。迭代器是一个可以记住遍历的位置的对象。</p><p>以下是一个简单的例子，演示如何在一个自定义类中实现 <code>__iter__</code> 方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, <span class="built_in">max</span></span>):</span></span><br><span class="line">        self.<span class="built_in">max</span> = <span class="built_in">max</span></span><br><span class="line">        self.a = <span class="number">0</span></span><br><span class="line">        self.b = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;__iter__ called&quot;</span>)</span><br><span class="line">        <span class="comment"># 这里返回self, 因为self对象实现了__next__方法</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;__next__ called&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        fib = self.a</span><br><span class="line">        <span class="keyword">if</span> fib &gt; self.<span class="built_in">max</span>:</span><br><span class="line">            <span class="comment"># 当没有更多值可以返回时，__next__方法会抛出一个StopIteration异常，告诉for循环迭代结束</span></span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        self.a, self.b = self.b, self.a + self.b</span><br><span class="line">        <span class="keyword">return</span> fib</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> Fib(<span class="number">5</span>):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__iter__ called</span><br><span class="line">__next__ called</span><br><span class="line">0</span><br><span class="line">__next__ called</span><br><span class="line">1</span><br><span class="line">__next__ called</span><br><span class="line">1</span><br><span class="line">__next__ called</span><br><span class="line">2</span><br><span class="line">__next__ called</span><br><span class="line">3</span><br><span class="line">__next__ called</span><br><span class="line">5</span><br><span class="line">__next__ called</span><br></pre></td></tr></table></figure><p>定义 <strong>iter</strong> 表示这个类是一个迭代器（iterator）。它只在迭代开始的时候运行一次。返回的是对象本身。这里还给顺手给对象添加了 a 和 b 两个属性。接下来就是循环调用 <strong>next</strong> 直到遇到 raise StopIteration 为止。调用的过程就是模拟斐波那契数列的过程。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在Python中，所有以双下划线&lt;code&gt;__&lt;/code&gt;包起来的方法，统称为&lt;strong&gt;Magic Method（魔术方法）&lt;/strong&gt;，它是一种的特殊方法，普通方法需要调用，而魔术方法不需要调用就可以自动执行。&lt;/p&gt;
&lt;p&gt;魔术方法在类或对象的某些事件出发后会自动执行，让类具有神奇的“魔力”。如果希望根据自己的程序定制自己特殊功能的类，那么就需要对这些方法进行重写。&lt;/p&gt;
&lt;p&gt;Python中常用的运算符、for循环、以及类操作等都是运行在魔术方法之上的。&lt;/p&gt;
&lt;h3 id=&quot;doc&quot;&gt;&lt;a href=&quot;#doc&quot; class=&quot;headerlink&quot; title=&quot;__doc__&quot;&gt;&lt;/a&gt;__doc__&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;表示类的描述信息&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Foo&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&amp;quot;&amp;quot;&amp;quot;描述类信息，这个是工具类&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;func&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;pass&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(Foo.__doc__)		&lt;span class=&quot;comment&quot;&gt;# 输出：类的描述信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="Python" scheme="http://example.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Python类的方法</title>
    <link href="http://example.com/2024/04/30/Python%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <id>http://example.com/2024/04/30/Python%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95/</id>
    <published>2024-04-30T13:40:15.000Z</published>
    <updated>2024-05-03T14:27:02.725Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><ul><li><a href="#%E7%B1%BB%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1">类对象与实例对象</a></li><li><a href="#%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E3%80%81%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%B1%BB%E6%96%B9%E6%B3%95%E3%80%81%E7%89%B9%E6%80%A7%E6%96%B9%E6%B3%95">实例方法、静态方法、类方法、特性方法</a></li><li><a href="#%E7%89%B9%E6%80%A7%E6%96%B9%E6%B3%95">特性方法</a></li><li><a href="#%E6%8A%BD%E8%B1%A1%E7%B1%BB%E5%92%8C%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95">抽象类和抽象方法</a></li></ul><h3><span id="类对象与实例对象">类对象与实例对象</span></h3><p>他们在定义和使用中有所区别，而本质的区别是内存中保存的位置不同</p><ul><li>实例属性属于实例对象</li><li>类属性属于类</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Province</span>:</span></span><br><span class="line">  <span class="comment"># 类属性</span></span><br><span class="line">  country = <span class="string">&quot;中国&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">    <span class="comment"># 实例属性</span></span><br><span class="line">    self.name = name</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 创建一个实例对象</span></span><br><span class="line">obj = Province(<span class="string">&quot;山东省&quot;</span>)</span><br><span class="line"><span class="comment"># 直接访问实例属性</span></span><br><span class="line"><span class="built_in">print</span>(obj.name)</span><br><span class="line"><span class="comment"># 直接访问类属性</span></span><br><span class="line">Province.country</span><br></pre></td></tr></table></figure><p>由上述代码可以看出【实例属性需要通过对象来访问】【类属性通过类访问】，在使用上可以看出实例属性和类属性的归属是不同的</p><span id="more"></span><p>其在内容的存储方式类似如下图：</p><p><img src="./%E7%B1%BB%E5%B1%9E%E6%80%A7%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7.png"></p><p>上图中实例对象2，<code>obj1 = Province(&quot;山西省&quot;)</code> 山东省属于笔误</p><p>由此可见：</p><ul><li>类属性在内存中只保存一份</li><li>实例属性在每个对象中都要保存一份</li></ul><h4><span id="应用场景">应用场景</span></h4><ul><li>通过类创建实例对象，如果每个对象需要具有相同名字的属性，那么就使用类属性，用一份即可</li></ul><h3><span id="实例方法-静态方法-类方法-特性方法">实例方法、静态方法、类方法、特性方法</span></h3><p>在 Python 的类里面，在类里面编写的特性函数称为方法，这些方法主要分为普通方法（实例方法），特性方法，静态方法，类方法</p><p>他们都归属于类，区别在于调用方式的不同</p><ul><li>实例方法：由对象调用；至少一个<code>self</code>参数，执行实例方式时，自动将调用该方法的对象赋值给<code>self</code></li><li>类方法：<code>@classmethod</code>由类调用；至少一个<code>cls</code>参数，执行类方法时，自动将调用该方法的类赋值给<code>cls</code></li><li>静态方法：<code>staticmethod</code>由类调用；无默认参数</li><li>特性方法：<code>@property</code>由类调用；不能传入参数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">    self.name = name</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">ord_func</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;定义实例方法，至少有一个self参数&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># print(self.name)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;实例方法&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">class_func</span>(<span class="params">cls</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;定义类方法，至少有一个cls参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;类方法&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">  @staticmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">static_func</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;定义静态方法，无默认参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;静态方法&quot;</span>)</span><br><span class="line">    </span><br><span class="line">f = Foo(<span class="string">&quot;中国&quot;</span>)</span><br><span class="line"><span class="comment"># 调用实例方法</span></span><br><span class="line">f.ord_func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用类方法</span></span><br><span class="line">Foo.class_func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用静态方法</span></span><br><span class="line">Foo.static_func()</span><br></pre></td></tr></table></figure><h4><span id="对比">对比</span></h4><ul><li>相同点：对于所有的方法而言，均属于类，所以在内存中也只保留一份</li><li>不同点：方法调用者不同，调用方法时自动传入的参数不同</li></ul><h4><span id="为什么会有类方法和静态方法">为什么会有类方法和静态方法</span></h4><p>类方法作用</p><ul><li><strong>修改类状态</strong>：类方法可以直接修改类的状态（类变量），而不需要通过类实例</li><li><strong>无需实例即可访问</strong>：有时，你可能需要执行与类相关的操作，但不需要创建类的实例。在这种情况下，类方法非常有用</li><li><strong>工厂方法</strong>：类方法常常用作工厂方法，用于创建和返回类的实例。由于它们与类本身紧密相关，因此它们可以在创建实例时执行一些与类相关的初始化或设置</li></ul><p>静态方法作用</p><ul><li><strong>组织代码</strong>：有时，你可能有一组与类紧密相关的函数，但这些函数并不需要访问类的状态或实例。将这些函数作为静态方法放在类中可以使代码更具组织性和可读性。</li><li><strong>保持命名空间整洁</strong>：将相关函数放在类中而不是模块级别可以使命名空间更整洁，并减少模块级别的名称冲突。</li><li><strong>访问类属性和其他方法</strong>：尽管静态方法不直接访问类的状态或实例，但它们仍然可以访问类的属性和其他方法（作为类本身的方法）</li></ul><p>以下是类方法的使用场景</p><h4><span id="修改类状态以及无需实例即可访问">修改类状态以及无需实例即可访问</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increment</span>(<span class="params">cls, increment_by = <span class="number">1</span></span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Counter count: <span class="subst">&#123;cls.count&#125;</span>&quot;</span>)</span><br><span class="line">        cls.count += increment_by</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Counter increased by <span class="subst">&#123;increment_by&#125;</span>. New count: <span class="subst">&#123;cls.count&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 使用类方法增加计数器的值，无需创建实例</span></span><br><span class="line">Counter.increment()</span><br><span class="line">Counter.increment(<span class="number">5</span>)</span><br><span class="line">Counter.increment()</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Counter count: 0</span><br><span class="line">Counter increased by 1. New count: 1</span><br><span class="line">Counter count: 1</span><br><span class="line">Counter increased by 5. New count: 6</span><br><span class="line">Counter count: 6</span><br><span class="line">Counter increased by 1. New count: 7</span><br></pre></td></tr></table></figure><h4><span id="工厂方法">工厂方法</span></h4><p>假设我们有一个<code>Shape</code>类，它是一个基类，用于创建不同类型的形状对象。我们可以使用类方法作为工厂方法，根据提供的参数返回不同类型的形状对象</p><p>关乎设计模式的内容，可以搜索下之前的文章</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span>:</span>  </span><br><span class="line"><span class="meta">    @classmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls, shape_type, **kwargs</span>):</span>  </span><br><span class="line">        <span class="keyword">if</span> shape_type == <span class="string">&#x27;circle&#x27;</span>:  </span><br><span class="line">            <span class="keyword">return</span> Circle(**kwargs)  </span><br><span class="line">        <span class="keyword">elif</span> shape_type == <span class="string">&#x27;rectangle&#x27;</span>:  </span><br><span class="line">            <span class="keyword">return</span> Rectangle(**kwargs)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported shape type: <span class="subst">&#123;shape_type&#125;</span>&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>(<span class="params">Shape</span>):</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, radius</span>):</span>  </span><br><span class="line">        self.radius = radius  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>(<span class="params">Shape</span>):</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, width, height</span>):</span>  </span><br><span class="line">        self.width = width  </span><br><span class="line">        self.height = height  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 使用工厂方法创建形状对象，无需直接实例化特定类  </span></span><br><span class="line">circle = Shape.create(<span class="string">&#x27;circle&#x27;</span>, radius=<span class="number">5</span>)  </span><br><span class="line">rectangle = Shape.create(<span class="string">&#x27;rectangle&#x27;</span>, width=<span class="number">3</span>, height=<span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>下面是关于静态方法的使用</p><h4><span id="组织代码">组织代码</span></h4><p>假设我们有一个<code>MathUtils</code>类，它包含了一些与数学相关的静态方法。这些静态方法不需要访问类的状态或实例，但它们都与数学计算相关，因此将它们放在同一个类中可以使代码更具组织性</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MathUtils</span>:</span>  </span><br><span class="line"><span class="meta">    @staticmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a, b</span>):</span>  </span><br><span class="line">        <span class="keyword">return</span> a + b  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @staticmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">multiply</span>(<span class="params">a, b</span>):</span>  </span><br><span class="line">        <span class="keyword">return</span> a * b  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 使用静态方法进行数学计算  </span></span><br><span class="line">result_add = MathUtils.add(<span class="number">3</span>, <span class="number">4</span>)  <span class="comment"># 结果为 7  </span></span><br><span class="line">result_multiply = MathUtils.multiply(<span class="number">3</span>, <span class="number">4</span>)  <span class="comment"># 结果为 12</span></span><br></pre></td></tr></table></figure><h4><span id="保持命名空间整洁">保持命名空间整洁</span></h4><p>如果我们有一些与特定主题相关的函数，将它们放在一个类中作为静态方法可以使模块级别的命名空间更整洁。例如，我们有一个与文件操作相关的工具集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileUtils</span>:</span>  </span><br><span class="line"><span class="meta">    @staticmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">file_path</span>):</span>  </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:  </span><br><span class="line">            <span class="keyword">return</span> file.read()  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @staticmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_file</span>(<span class="params">file_path, content</span>):</span>  </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file:  </span><br><span class="line">            file.write(content)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 使用静态方法进行文件操作  </span></span><br><span class="line">content = FileUtils.read_file(<span class="string">&#x27;example.txt&#x27;</span>)  </span><br><span class="line">FileUtils.write_file(<span class="string">&#x27;new_file.txt&#x27;</span>, <span class="string">&#x27;Hello, world!&#x27;</span>)</span><br></pre></td></tr></table></figure><h4><span id="访问类属性和其他方法">访问类属性和其他方法</span></h4><p>虽然静态方法不依赖于类的实例，但它们仍然可以访问类属性和其他类方法。这在某些情况下可能是有用的，尤其是当你需要在静态方法中调用类的其他功能时</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span>  </span><br><span class="line">    class_variable = <span class="string">&quot;I&#x27;m a class variable&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @classmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span>(<span class="params">cls</span>):</span>  </span><br><span class="line">        <span class="keyword">return</span> cls.class_variable  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @staticmethod  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_method</span>():</span>  </span><br><span class="line">        <span class="keyword">return</span> MyClass.class_variable, MyClass.class_method()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 使用静态方法访问类属性和类方法  </span></span><br><span class="line"><span class="built_in">print</span>(MyClass.static_method())  <span class="comment"># 输出：(&#x27;I&#x27;m a class variable&#x27;, &#x27;I&#x27;m a class variable&#x27;)</span></span><br></pre></td></tr></table></figure><p>在这个例子中，<code>static_method</code>是一个静态方法，但它通过<code>MyClass</code>类名直接访问了类属性<code>class_variable</code>和类方法<code>class_method</code>。这展示了静态方法如何在不依赖于类的实例的情况下访问类的其他部分</p><h3><span id="特性方法">特性方法</span></h3><p><code>@property</code></p><p>特性方法只具备只读属性，且调用特性方法不能有形参。</p><p>普通方法具备读和写的属性，且调用特性方法可以使用形参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setinfo</span>(<span class="params">self, name, age</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(name, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;name不是字符串的数据类型&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(age, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;age不是整型的数据类型&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">info</span>(<span class="params">self, city</span>):</span></span><br><span class="line">        self.setinfo(self.name, self.age)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;my name is <span class="subst">&#123;self.name&#125;</span>, and my age is <span class="subst">&#123;self.age&#125;</span>, from <span class="subst">&#123;city&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">property_info</span>(<span class="params">self</span>):</span><span class="comment"># 不能传入参数</span></span><br><span class="line">        self.setinfo(self.name, self.age)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;my name is <span class="subst">&#123;self.name&#125;</span>, and my age is <span class="subst">&#123;self.age&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    person = Person(<span class="string">&#x27;william&#x27;</span>, <span class="number">18</span>)</span><br><span class="line">    person.info(city=<span class="string">&#x27;xian&#x27;</span>)</span><br><span class="line">    person.property_info<span class="comment"># 调用方法后面没有()</span></span><br></pre></td></tr></table></figure><p>我们看一下实际上有那些使用了<code>@property</code></p><p>在<code>selenium</code>中<code>find_element(By.LINK_TEXT).text</code>方法，使用的是特性方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;The text of the element.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> self._execute(Command.GET_ELEMENT_TEXT)[<span class="string">&quot;value&quot;</span>]</span><br></pre></td></tr></table></figure><h3><span id="抽象类和抽象方法">抽象类和抽象方法</span></h3><p><strong>场景介绍</strong></p><p>假如我们现在实现了一个数据中台的开发，我们对外提供一个接口让不同组件通过这个接口进行访问数据库，来读取数据，我们给数据接口主要有2个功能，</p><ul><li>登录数据库</li><li>读取数据</li><li>执行SQL语句</li></ul><p>可以想象，<strong>登录数据库</strong>这个功能在不同组件之间可以共用，不同组件只需要提供host、user、passwd即可，至于读取数据这是每个组件都必须单独实现的，可以声明为抽象方法，执行SQL语句也是每个子类需要实现的，可以声明为抽象的静态方法。</p><p>Python标准库中有一个模块<strong>abc</strong>可以实现抽象基类和抽象方法，它们的实现方式如下：</p><p><strong>抽象基类</strong>：通过继承abc模块中的ABC类来实现抽象基类。</p><p><strong>抽象方法</strong>：通过装饰器的方法来调用abc模块中abstractmethod方法来注解抽象基类的方法。</p><blockquote><p>abstractmethod注解除了可以实现抽象方法外，还可以注解类方法(@classmethod)、静态方法(@staticmethod)、属性(@property)。</p></blockquote><p>下面就先实现抽象基类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Database</span>(<span class="params">ABC</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">self, host, user, password</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Host : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(host))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;User : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(user))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Password : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(password))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Register Success!&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">  @abstractmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    传入查询数据的SQL语句并执行</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">  @staticmethod</span></span><br><span class="line"><span class="meta">  @abstractmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">sql_string</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    执行SQL语句</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>从抽象基类<strong>Database</strong>的实现可以看出，它共包含3个方法，其中<strong>register</strong>是每个子类都需要的，直接实现在抽象基类里，是一个普通的类方法。<strong>query</strong>和<strong>execute</strong>只是在基类中进行类声明，给出了描述，但并没有实现，它限定了继承<strong>Database</strong>的子类必须实现这两个方法。</p><p>下面就来实现两个组件(子类)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component1</span>(<span class="params">Database</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host, user, password</span>):</span></span><br><span class="line">    self.register(host, user, password)</span><br><span class="line">    </span><br><span class="line"><span class="meta">  @staticmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">sql_string</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(sql_string)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">    sql_string = <span class="string">&quot;SELECT ID FROM db_name&quot;</span></span><br><span class="line">    self.execute(sql_string)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component2</span>(<span class="params">Database</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host, user, password</span>):</span></span><br><span class="line">    self.register(host, user, password)</span><br><span class="line">    </span><br><span class="line"><span class="meta">  @staticmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">sql_string</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(sql_string)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">    sql_string = <span class="string">&quot;SELECT ID FROM db_name&quot;</span></span><br><span class="line">    self.execute(sql_string)</span><br><span class="line">    </span><br><span class="line">comp1 = Component1(<span class="string">&quot;00.00.00.00&quot;</span>, <span class="string">&quot;abc&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line">comp2 = Component2(<span class="string">&quot;11.11.11.11&quot;</span>, <span class="string">&quot;ABC&quot;</span>, <span class="string">&quot;111111&quot;</span>)</span><br><span class="line">comp1.query()</span><br><span class="line">comp2.query()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">Host : <span class="number">00.00</span><span class="number">.00</span><span class="number">.00</span></span><br><span class="line">User : abc</span><br><span class="line">Password : <span class="number">000000</span></span><br><span class="line">Register Success!</span><br><span class="line">Host : <span class="number">11.11</span><span class="number">.11</span><span class="number">.11</span></span><br><span class="line">User : ABC</span><br><span class="line">Password : <span class="number">111111</span></span><br><span class="line">Register Success!</span><br><span class="line">SELECT ID FROM db_name</span><br><span class="line">SELECT NAME FROM db_name</span><br></pre></td></tr></table></figure><p>上述是通过Python标准库中abc模块实现了抽象基类，其实在Python中collections中也实现了抽象基类，numbers中也定义了有关数字对象的抽象基类，可见，抽象基类在Python中占据着至关重要的地位。</p>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%B1%BB%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1&quot;&gt;类对象与实例对象&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E3%80%81%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%B1%BB%E6%96%B9%E6%B3%95%E3%80%81%E7%89%B9%E6%80%A7%E6%96%B9%E6%B3%95&quot;&gt;实例方法、静态方法、类方法、特性方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%89%B9%E6%80%A7%E6%96%B9%E6%B3%95&quot;&gt;特性方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%8A%BD%E8%B1%A1%E7%B1%BB%E5%92%8C%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95&quot;&gt;抽象类和抽象方法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;类对象与实例对象&quot;&gt;&lt;a href=&quot;#类对象与实例对象&quot; class=&quot;headerlink&quot; title=&quot;类对象与实例对象&quot;&gt;&lt;/a&gt;类对象与实例对象&lt;/h3&gt;&lt;p&gt;他们在定义和使用中有所区别，而本质的区别是内存中保存的位置不同&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;实例属性属于实例对象&lt;/li&gt;
&lt;li&gt;类属性属于类&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Province&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# 类属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  country = &lt;span class=&quot;string&quot;&gt;&amp;quot;中国&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;__init__&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self, name&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# 实例属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.name = name&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 创建一个实例对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;obj = Province(&lt;span class=&quot;string&quot;&gt;&amp;quot;山东省&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 直接访问实例属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(obj.name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 直接访问类属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Province.country&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;由上述代码可以看出【实例属性需要通过对象来访问】【类属性通过类访问】，在使用上可以看出实例属性和类属性的归属是不同的&lt;/p&gt;</summary>
    
    
    
    <category term="Python" scheme="http://example.com/categories/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>Python深拷贝与浅拷贝</title>
    <link href="http://example.com/2024/04/30/Python%E6%B7%B1%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B5%85%E6%8B%B7%E8%B4%9D/"/>
    <id>http://example.com/2024/04/30/Python%E6%B7%B1%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B5%85%E6%8B%B7%E8%B4%9D/</id>
    <published>2024-04-30T11:49:41.000Z</published>
    <updated>2024-05-03T14:29:56.495Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h3><span id="python的引用计数">Python的引用计数</span></h3><p>首先我们要知道，Python 内<strong>不可变对象</strong>的内存管理方式是引用计数。因此，我们在谈论浅拷贝时，其实谈论的主要特点都是基于可变对象的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span>  <span class="comment"># python的不可变对象：元组，数值，字符串</span></span><br><span class="line">b = a</span><br><span class="line">c = copy.copy(a)</span><br><span class="line">d = copy.deepcopy(c)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(b))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(c))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(d))</span><br></pre></td></tr></table></figure><span id="more"></span><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4310112880</span><br><span class="line">4310112880</span><br><span class="line">4310112880</span><br><span class="line">4310112880</span><br></pre></td></tr></table></figure><p>因为我们这里操作的是不可变对象，Python 用引用计数的方式管理它们，所以 Python 不会对值相同的不可变对象，申请单独的内存空间。只会记录它的引用次数</p><p>操作不可变对象时，由于引用计数的特性，浅拷贝和深拷贝是没有区别的</p><h3><span id="浅拷贝shallow-copy">浅拷贝（Shallow Copy）</span></h3><p>我们先来比较一下浅拷贝和赋值在可变对象上的区别</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = [<span class="string">&#x27;123&#x27;</span>]</span><br><span class="line"></span><br><span class="line">b = a</span><br><span class="line"></span><br><span class="line">c = copy.copy(a)</span><br><span class="line"></span><br><span class="line">d = copy.deepcopy(c)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(b))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(c))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(d))</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4372413312</span><br><span class="line">4372413312</span><br><span class="line">4372889152</span><br><span class="line">4372889216</span><br></pre></td></tr></table></figure><p><code>赋值</code>就是对物体进行贴标签的操作，作用于同一个物体</p><p><code>浅拷贝</code>则会创建一个新的对象，至于对象中的元素，它依然会引用原来的物体，请看下面的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = [<span class="string">&#x27;123&#x27;</span>]</span><br><span class="line"></span><br><span class="line">c = copy.copy(a)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(c))</span><br><span class="line"></span><br><span class="line">a[<span class="number">0</span>] = <span class="string">&#x27;555&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;a的值为: <span class="subst">&#123;a&#125;</span>, a的内存地址为: <span class="subst">&#123;<span class="built_in">id</span>(a)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;c的值为: <span class="subst">&#123;c&#125;</span>, c的内存地址为: <span class="subst">&#123;<span class="built_in">id</span>(c)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4337646464</span><br><span class="line">4338122688</span><br><span class="line">a的值为: [<span class="string">&#x27;555&#x27;</span>], a的内存地址为: 4337646464</span><br><span class="line">c的值为: [<span class="string">&#x27;123&#x27;</span>], c的内存地址为: 4338122688</span><br></pre></td></tr></table></figure><p><img src="./%E6%B5%85%E6%8B%B7%E8%B4%9D.png"></p><hr><p>由于浅拷贝会使用原始元素的引用（内存地址）。所以在操作被拷贝对象内部可变元素时，其结果是会影响到拷贝对象的</p><p>现在，我们看下面的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = [[<span class="string">&#x27;aaa&#x27;</span>],<span class="string">&#x27;bbb&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line">c = copy.copy(a)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"></span><br><span class="line">a[<span class="number">0</span>][<span class="number">0</span>] = <span class="string">&#x27;tom&#x27;</span></span><br><span class="line">a[<span class="number">1</span>] = <span class="string">&#x27;jack&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br></pre></td></tr></table></figure><p><img src="%E6%B5%85%E6%8B%B7%E8%B4%9D2.png"></p><h3><span id="深拷贝deep-copy">深拷贝（Deep Copy）</span></h3><p>深拷贝遇到可变对象，则又会进行一层对象创建，所以你操作被拷贝对象内部的可变对象，不影响对象内部的值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = [[<span class="string">&#x27;aaa&#x27;</span>],<span class="string">&#x27;bbb&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;a的值为: <span class="subst">&#123;a&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">c = copy.copy(a)</span><br><span class="line">d = copy.deepcopy(a)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;浅拷贝c的值为: <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;深拷贝d的值为: <span class="subst">&#123;d&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">a[<span class="number">0</span>][<span class="number">0</span>] = <span class="string">&#x27;tom&#x27;</span></span><br><span class="line">a[<span class="number">1</span>] = <span class="string">&#x27;jack&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-------------&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;修改后a的值为: <span class="subst">&#123;a&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;浅拷贝c的值为: <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;深拷贝d的值为: <span class="subst">&#123;d&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a的值为: [[<span class="string">&#x27;aaa&#x27;</span>], <span class="string">&#x27;bbb&#x27;</span>]</span><br><span class="line">浅拷贝c的值为: [[<span class="string">&#x27;aaa&#x27;</span>], <span class="string">&#x27;bbb&#x27;</span>]</span><br><span class="line">深拷贝d的值为: [[<span class="string">&#x27;aaa&#x27;</span>], <span class="string">&#x27;bbb&#x27;</span>]</span><br><span class="line">-------------</span><br><span class="line">修改后a的值为: [[<span class="string">&#x27;tom&#x27;</span>], <span class="string">&#x27;jack&#x27;</span>]</span><br><span class="line">浅拷贝c的值为: [[<span class="string">&#x27;tom&#x27;</span>], <span class="string">&#x27;bbb&#x27;</span>]</span><br><span class="line">深拷贝d的值为: [[<span class="string">&#x27;aaa&#x27;</span>], <span class="string">&#x27;bbb&#x27;</span>]</span><br></pre></td></tr></table></figure><p><img src="%E6%B7%B1%E6%8B%B7%E8%B4%9D.png"></p><h3><span id="总结">总结</span></h3><ol><li>由于Python内部引用计数器的特性，对于不可变对象，浅拷贝和深拷贝的作用是一样的，指针指向同一个地址</li><li>浅拷贝的拷贝，其实是拷贝了原始元素的引用（内存地址），所以当拷贝可变对象时，原对象内可变对象的对应元素的改变，会在复制对象的对应元素上，有所体现</li><li>深拷贝遇到可变对象时，又在内部新建了一个副本。所以，不管它内部的元素如何变化，都不会影响到原来副本的可变对象</li></ol><h3><span id="实际应用场景">实际应用场景</span></h3><p>那么讲了这么多，他们的实际应用场景又是什么呢？这也是网上讲的最少的部分了</p><ol><li><p><strong>避免修改原始数据</strong>：当你需要修改一个对象，但又不想影响原始数据时，深拷贝是一个很好的选择。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">original_dict = &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: [<span class="number">2</span>,<span class="number">3</span>]&#125;</span><br><span class="line">deep_copy = copy.deepcopy(original_dict)</span><br><span class="line"></span><br><span class="line">deep_copy[<span class="string">&#x27;b&#x27;</span>][<span class="number">0</span>] = <span class="number">4</span></span><br><span class="line"><span class="built_in">print</span>(original_dict)</span><br><span class="line"><span class="built_in">print</span>(deep_copy)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;a&#x27;</span>: 1, <span class="string">&#x27;b&#x27;</span>: [2, 3]&#125;</span><br><span class="line">&#123;<span class="string">&#x27;a&#x27;</span>: 1, <span class="string">&#x27;b&#x27;</span>: [4, 3]&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>配置文件的处理</strong>：当你从配置文件中读取数据并希望对其进行修改，但同时又希望保留原始配置文件的内容时，深拷贝非常有用</p></li><li><p><strong>多线程/多进程中数据安全</strong>：在多线程或多进程环境中，你可能需要确保一个对象在多线程或多进程之间是独立的。通过深拷贝，你可以为每个线程或进程提过一个独立的对象副本</p></li></ol><p><em>注意：</em>深拷贝可能会消耗更多的内存和时间，因为它需要递归的复制对象的所有内容。因此，在选择使用深拷贝还是浅拷贝时，需要权衡你具体需求（如性能、内存使用等）和场景</p><h3><span id="引用">引用</span></h3><p><a href="https://zhuanlan.zhihu.com/p/57893374">5张图彻底理解Python中的浅拷贝与深拷贝</a></p><p><a href="https://www.runoob.com/w3cnote/python-understanding-dict-copy-shallow-or-deep.html">Python 直接赋值、浅拷贝和深度拷贝解析</a></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Python的引用计数&quot;&gt;&lt;a href=&quot;#Python的引用计数&quot; class=&quot;headerlink&quot; title=&quot;Python的引用计数&quot;&gt;&lt;/a&gt;Python的引用计数&lt;/h3&gt;&lt;p&gt;首先我们要知道，Python 内&lt;strong&gt;不可变对象&lt;/strong&gt;的内存管理方式是引用计数。因此，我们在谈论浅拷贝时，其实谈论的主要特点都是基于可变对象的。&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; copy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a = &lt;span class=&quot;string&quot;&gt;&amp;#x27;hello&amp;#x27;&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# python的不可变对象：元组，数值，字符串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;b = a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;c = copy.copy(a)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;d = copy.deepcopy(c)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;id&lt;/span&gt;(a))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;id&lt;/span&gt;(b))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;id&lt;/span&gt;(c))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;id&lt;/span&gt;(d))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Python" scheme="http://example.com/categories/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>logging日志模块</title>
    <link href="http://example.com/2024/04/11/logging%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/"/>
    <id>http://example.com/2024/04/11/logging%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/</id>
    <published>2024-04-10T16:39:51.000Z</published>
    <updated>2024-04-10T16:42:12.319Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h3><span id="logging库日志级别">Logging库日志级别</span></h3><table><thead><tr><th>级别</th><th>级别数值</th><th>使用时机</th></tr></thead><tbody><tr><td>DEBUG</td><td>10</td><td>详细信息，常用于调试</td></tr><tr><td>INFO</td><td>20</td><td>程序正常运行过程中产生的一些信息</td></tr><tr><td>WARNNING</td><td>30</td><td>警告用户，虽然程序还在正常工作，但有可能发生错误</td></tr><tr><td>ERROR</td><td>40</td><td>由于更严重的问题，程序已不能执行一些功能了</td></tr><tr><td>CRITICAL</td><td>50</td><td>严重错误，程序已不能继续运行</td></tr></tbody></table><p><strong>默认的日志级别是warning</strong></p><span id="more"></span><p>我们来看一下代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认的日志输出级别为Warning</span></span><br><span class="line"></span><br><span class="line">logging.debug(<span class="string">&quot;This is a debug message&quot;</span>)</span><br><span class="line">logging.info(<span class="string">&quot;This is an info&quot;</span>)</span><br><span class="line">logging.warning(<span class="string">&quot;This is an warning&quot;</span>)</span><br><span class="line">logging.error(<span class="string">&quot;This is an error&quot;</span>)</span><br><span class="line">logging.critical(<span class="string">&quot;This is an critical&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARNING:root:This is an warning</span><br><span class="line">ERROR:root:This is an error</span><br><span class="line">CRITICAL:root:This is an critical</span><br></pre></td></tr></table></figure><p>正常不会打印出debug和info日志。现在我们更改下日志输出的级别，将日志的输出级别改成DEBUG</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认的日志输出级别为Warning</span></span><br><span class="line"><span class="comment"># 使用baseConfig()来指定日志输出级别</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">logging.debug(<span class="string">&quot;This is a debug message&quot;</span>)</span><br><span class="line">logging.info(<span class="string">&quot;This is an info&quot;</span>)</span><br><span class="line">logging.warning(<span class="string">&quot;This is an warning&quot;</span>)</span><br><span class="line">logging.error(<span class="string">&quot;This is an error&quot;</span>)</span><br><span class="line">logging.critical(<span class="string">&quot;This is an critical&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEBUG:root:This is a debug message</span><br><span class="line">INFO:root:This is an info</span><br><span class="line">WARNING:root:This is an warning</span><br><span class="line">ERROR:root:This is an error</span><br><span class="line">CRITICAL:root:This is an critical</span><br></pre></td></tr></table></figure><p>现在打印出了所有的日志了</p><h3><span id="loggingbasicconfig">Logging.basicConfig()</span></h3><p><strong>logging.basicConfig()</strong> 的参数除了日志等级的这个参数可以设置以外，还可以设置其他的参数，比如：</p><table><thead><tr><th align="left">格式</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>filename</em></td><td align="left">使用指定的文件名创建一个 <a href="https://docs.python.org/zh-cn/3/library/logging.handlers.html#logging.FileHandler"><code>FileHandler</code></a>，而不是 <a href="https://docs.python.org/zh-cn/3/library/logging.handlers.html#logging.StreamHandler"><code>StreamHandler</code></a>。</td></tr><tr><td align="left"><em>filemode</em></td><td align="left">如果指定了 <em>filename</em>，则用此 <a href="https://docs.python.org/zh-cn/3/library/functions.html#filemodes">模式</a> 打开该文件。 默认模式为 <code>&#39;a&#39;</code>。</td></tr><tr><td align="left"><em>format</em></td><td align="left">使用指定的格式字符串作为处理器。 默认为属性以冒号分隔的 <code>levelname</code>, <code>name</code> 和 <code>message</code>。</td></tr><tr><td align="left"><em>datefmt</em></td><td align="left">使用指定的日期/时间格式，与 <a href="https://docs.python.org/zh-cn/3/library/time.html#time.strftime"><code>time.strftime()</code></a> 所接受的格式相同。</td></tr><tr><td align="left"><em>style</em></td><td align="left">如果指定了 <em>format</em>，将为格式字符串使用此风格。 <code>&#39;%&#39;</code>, <code>&#39;&#123;&#39;</code> 或 <code>&#39;$&#39;</code> 分别对应于 <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#old-string-formatting">printf 风格</a>, <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str.format"><code>str.format()</code></a> 或 <a href="https://docs.python.org/zh-cn/3/library/string.html#string.Template"><code>string.Template</code></a>。 默认为 <code>&#39;%&#39;</code>。</td></tr><tr><td align="left"><em>level</em></td><td align="left">设置根记录器级别为指定的 <a href="https://docs.python.org/zh-cn/3/library/logging.html#levels">level</a>.</td></tr><tr><td align="left"><em>stream</em></td><td align="left">使用指定的流初始化 <a href="https://docs.python.org/zh-cn/3/library/logging.handlers.html#logging.StreamHandler"><code>StreamHandler</code></a>。 请注意此参数与 <em>filename</em> 不兼容 —— 如果两者同时存在，则会引发 <code>ValueError</code>。</td></tr><tr><td align="left"><em>handlers</em></td><td align="left">如果指定，这应为一个包含要加入根日志记录器的已创建处理器的可迭代对象。 任何尚未设置格式描述符的处理器将被设置为在此函数中创建的默认格式描述符。 请注意此参数与 <em>filename</em> 或 <em>stream</em> 不兼容 —— 如果两者同时存在，则会引发 <code>ValueError</code>。</td></tr><tr><td align="left"><em>force</em></td><td align="left">如果将此关键字参数指定为 true，则在执行其他参数指定的配置之前，将移除并关闭附加到根记录器的所有现有处理器。</td></tr><tr><td align="left"><em>encoding</em></td><td align="left">如果此关键字参数与 <em>filename</em> 一同被指定，则其值会在创建 <a href="https://docs.python.org/zh-cn/3/library/logging.handlers.html#logging.FileHandler"><code>FileHandler</code></a> 时被使用，因而也会在打开输出文件时被使用。</td></tr><tr><td align="left"><em>errors</em></td><td align="left">如果此关键字参数与 <em>filename</em> 一同被指定，则其值会在创建 <a href="https://docs.python.org/zh-cn/3/library/logging.handlers.html#logging.FileHandler"><code>FileHandler</code></a> 时被使用，因而也会在打开输出文件时被使用。 如果未指定，则会使用值 ‘backslashreplace’。 请注意如果指定为 <code>None</code>，它将被原样传给 <a href="https://docs.python.org/zh-cn/3/library/functions.html#open"><code>open()</code></a>，这意味着它将会当作传入 ‘errors’ 一样处理。</td></tr></tbody></table><p>上表提到的日志的输出格式参数format，其控制着日志输出的一些格式：</p><table><thead><tr><th align="left">属性名称</th><th align="left">格式</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">args</td><td align="left">此属性不需要用户进行格式化。</td><td align="left">合并到 <code>msg</code> 以产生 <code>message</code> 的包含参数的元组，或是其中的值将被用于合并的字典（当只有一个参数且其类型为字典时）。</td></tr><tr><td align="left">asctime</td><td align="left"><code>%(asctime)s</code></td><td align="left">表示人类易读的 <a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.LogRecord"><code>LogRecord</code></a> 生成时间。 默认形式为 ‘2003-07-08 16:49:45,896’ （逗号之后的数字为时间的毫秒部分）。</td></tr><tr><td align="left">created</td><td align="left"><code>%(created)f</code></td><td align="left"><a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.LogRecord"><code>LogRecord</code></a> 被创建的时间（即 <a href="https://docs.python.org/zh-cn/3/library/time.html#time.time"><code>time.time()</code></a> 的返回值）。</td></tr><tr><td align="left">exc_info</td><td align="left">此属性不需要用户进行格式化。</td><td align="left">异常元组（例如 <code>sys.exc_info</code>）或者如未发生异常则为 <code>None</code>。</td></tr><tr><td align="left">filename</td><td align="left"><code>%(filename)s</code></td><td align="left"><code>pathname</code> 的文件名部分。</td></tr><tr><td align="left">funcName</td><td align="left"><code>%(funcName)s</code></td><td align="left">函数名包括调用日志记录.</td></tr><tr><td align="left">levelname</td><td align="left"><code>%(levelname)s</code></td><td align="left">消息文本记录级别（<code>&#39;DEBUG&#39;</code>，<code>&#39;INFO&#39;</code>，<code>&#39;WARNING&#39;</code>，<code>&#39;ERROR&#39;</code>，<code>&#39;CRITICAL&#39;</code>）。</td></tr><tr><td align="left">levelno</td><td align="left"><code>%(levelno)s</code></td><td align="left">消息数字的记录级别 (<a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.DEBUG"><code>DEBUG</code></a>, <a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.INFO"><code>INFO</code></a>, <a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.WARNING"><code>WARNING</code></a>, <a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.ERROR"><code>ERROR</code></a>, <a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.CRITICAL"><code>CRITICAL</code></a>).</td></tr><tr><td align="left">lineno</td><td align="left"><code>%(lineno)d</code></td><td align="left">发出日志记录调用所在的源行号（如果可用）。</td></tr><tr><td align="left">message</td><td align="left"><code>%(message)s</code></td><td align="left">记入日志的消息，即 <code>msg % args</code> 的结果。 这是在发起调用 <a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a> 时设置的。</td></tr><tr><td align="left">module</td><td align="left"><code>%(module)s</code></td><td align="left">模块 (<code>filename</code> 的名称部分)。</td></tr><tr><td align="left">msecs</td><td align="left"><code>%(msecs)d</code></td><td align="left"><a href="https://docs.python.org/zh-cn/3/library/logging.html#logging.LogRecord"><code>LogRecord</code></a> 被创建的时间的毫秒部分。</td></tr><tr><td align="left">msg</td><td align="left">此属性不需要用户进行格式化。</td><td align="left">在原始日志记录调用中传入的格式字符串。 与 <code>args</code> 合并以产生 <code>message</code>，或是一个任意对象 (参见 <a href="https://docs.python.org/zh-cn/3/howto/logging.html#arbitrary-object-messages">使用任意对象作为消息</a>)。</td></tr><tr><td align="left">name</td><td align="left"><code>%(name)s</code></td><td align="left">用于记录调用的日志记录器名称。</td></tr><tr><td align="left">pathname</td><td align="left"><code>%(pathname)s</code></td><td align="left">发出日志记录调用的源文件的完整路径名（如果可用）。</td></tr><tr><td align="left">process</td><td align="left"><code>%(process)d</code></td><td align="left">进程ID（如果可用）</td></tr><tr><td align="left">processName</td><td align="left"><code>%(processName)s</code></td><td align="left">进程名（如果可用）</td></tr><tr><td align="left">relativeCreated</td><td align="left"><code>%(relativeCreated)d</code></td><td align="left">以毫秒数表示的 LogRecord 被创建的时间，即相对于 logging 模块被加载时间的差值。</td></tr><tr><td align="left">stack_info</td><td align="left">此属性不需要用户进行格式化。</td><td align="left">当前线程中从堆栈底部起向上直到包括日志记录调用并引发创建当前记录堆栈帧创建的堆栈帧信息（如果可用）。</td></tr><tr><td align="left">thread</td><td align="left"><code>%(thread)d</code></td><td align="left">线程ID（如果可用）</td></tr><tr><td align="left">threadName</td><td align="left"><code>%(threadName)s</code></td><td align="left">线程名（如果可用）</td></tr></tbody></table><p>我们来看看怎么使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认的日志输出级别为Warning</span></span><br><span class="line"></span><br><span class="line">logging.basicConfig(filename=<span class="string">&#x27;message.log&#x27;</span>,</span><br><span class="line">                    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(filename)s:%(lineno)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">                    level=logging.DEBUG)</span><br><span class="line">logging.debug(<span class="string">&quot;This is a debug message&quot;</span>)</span><br><span class="line">logging.info(<span class="string">&quot;This is an info&quot;</span>)</span><br><span class="line">logging.warning(<span class="string">&quot;This is an warning&quot;</span>)</span><br><span class="line">logging.error(<span class="string">&quot;This is an error&quot;</span>)</span><br><span class="line">logging.critical(<span class="string">&quot;This is an critical&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>filemode也是一个常用的参数，不设的话默认为<code>&#39;a&#39;</code>，即追加模式；也可以设为<code>&#39;w&#39;</code>，那么每次写日志会覆盖之前的日志。</strong></p><p>上述产生的日志文件<code>message.log</code>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2024-04-10 22:35:26,490 - root - test.py:8 - DEBUG - This is a debug message</span><br><span class="line">2024-04-10 22:35:26,490 - root - test.py:9 - INFO - This is an info</span><br><span class="line">2024-04-10 22:35:26,491 - root - test.py:10 - WARNING - This is an warning</span><br><span class="line">2024-04-10 22:35:26,491 - root - test.py:11 - ERROR - This is an error</span><br><span class="line">2024-04-10 22:35:26,491 - root - test.py:12 - CRITICAL - This is an critical</span><br></pre></td></tr></table></figure><h3><span id="logging组件">Logging组件</span></h3><p>Logging中除了以上的一些设置之外，logging还提供了几个组件（类）供我们实现一些特殊的功能，它们主要是：</p><table><thead><tr><th>组件名称</th><th>对应类名</th><th>对应描述</th></tr></thead><tbody><tr><td>日志器</td><td>Logger</td><td>提供了应用程序可以一直使用的接口</td></tr><tr><td>处理器</td><td>Handler</td><td>将创建的日志记录发送到合适的目的地输出</td></tr><tr><td>过滤器</td><td>Filter</td><td>提供了更细颗粒度的控制工具来决定输出哪条日志记录，丢弃哪条日志记录</td></tr><tr><td>格式器</td><td>Formatter</td><td>决定日志记录的最终输出格式</td></tr></tbody></table><p>这些组件共同完成日志的配置和输出：</p><ul><li><code>Logger</code>需要通过<code>handler</code>将日志信息输出到目标位置，目标位置可以是<code>sys.stdout</code>和文件等。</li><li>不同的Handler可以将日志输出到不同的位置(不同的日志文件)。</li><li><code>Logger</code>可以设置多个<code>handler</code>将同一条日志记录输出到不同的位置。</li><li>每个<code>Handler</code>都可以设置自己的<code>filter</code>从而实现日志过滤，保留实际项目中需要的日志。</li><li><code>formatter</code>实现同一条日志以不同的格式输出到不同的地方。</li></ul><p><strong>简单的说就是：日志器作为入口，通过设置处理器的方式将日志输出，处理器再通过过滤器和格式器对日志进行相应的处理操作。</strong></p><p>我们来简单的介绍一下这些组件中一些常用的方法：</p><h4><span id="logger-日志器">Logger 日志器</span></h4><ol><li><p>提供应用程序的调用接口</p><p><code>logger = logging.getLogger(__name__)</code></p><p><code>logger</code>是单例的</p></li><li><p>决定日志记录的级别</p><p><code>logger.setLevel()</code></p></li><li><p>将日志内容传递到相关联的<code>headlers</code>中</p><p><code>logger.addHandler() 和 logger.removeHandler()</code></p></li></ol><table><thead><tr><th>方法</th><th>方法描述</th></tr></thead><tbody><tr><td>Logger.setLevel()</td><td>设置日志器将会处理的日志消息级别</td></tr><tr><td>Logger.addHander()</td><td>添加一个<code>handler</code>对象</td></tr><tr><td>Logger.addFilter()</td><td>添加一个<code>filter</code>对象</td></tr><tr><td>Logger.removeHander()</td><td>移除一个<code>handler</code>对象</td></tr><tr><td>Logger.removeFilter()</td><td>移除一个<code>filter</code>对象</td></tr><tr><td>Logger.debug()</td><td>设置DEBUG级别的日志记录</td></tr><tr><td>Logger.info()</td><td>设置INFO级别的日志记录</td></tr><tr><td>Logger.exception()</td><td>输出堆栈追踪信息</td></tr><tr><td>Logger.log()</td><td>设置一个自定义的<code>lever</code>参数来创建一个日志记录</td></tr></tbody></table><h4><span id="handler-处理器">Handler 处理器</span></h4><p><code>Handler</code>将日志分发到不同的目的地。可以是文件、标准输出、邮件、或者通过<code>socke</code>、<code>http</code>等协议发送到任何地方</p><p><font color="orange"><code>StreamHeadler</code></font></p><p>标准输出<code>stdout</code>（如显示器）分发器</p><p>创建方法：<code>sh = logging.StreamHandler(stream=None)</code></p><p><font color="orange"><code>FileHandler</code></font></p><p>将日志保存到磁盘文件的处理器</p><p>创建方法：<code>fh = logging.FileHandler(filename, mode=&#39;a&#39;, encoding=None, delay=False)</code></p><p><code>setFormatter():</code> 设置当前handler对象使用的消息格式</p><table><thead><tr><th>方法</th><th>方法描述</th></tr></thead><tbody><tr><td>logging.StreamHandler()</td><td>它可将日志记录输出发送到数据流例如 <em>sys.stdout</em>, <em>sys.stderr</em> 或任何文件型对象（或者更精确地说，任何支持 <code>write()</code> 和 <code>flush()</code> 方法的对象）。</td></tr><tr><td>logging.FileHandler()</td><td>它可将日志记录输出到磁盘文件中</td></tr><tr><td>RotatingFileHandler()</td><td>将日志消息发送到磁盘文件，支持日志文件按大小切割</td></tr><tr><td>BaseRotatingHandler()</td><td>它是轮换文件处理程序类</td></tr><tr><td>TimedRotatingFileHandler()</td><td>将日志消息发送到磁盘文件，并支持日志文件按时间切割</td></tr></tbody></table><h4><span id="fliter-过滤器">Fliter 过滤器</span></h4><p>看名字大家就知道这是一个过滤类，那么过滤什么呢？</p><p>Filter可以被Handler和Logger用来做比之前设置的日志等级level更为细粒度的、更复杂的相关过滤功能。</p><p>简单的说Filter是一个过滤器基类，它只允许某个logger层级下的日志事件通过过滤，保存下来。该类定义如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">logging</span>.<span class="title">Filter</span>(<span class="title">name</span></span>=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    filter(record)</span><br></pre></td></tr></table></figure><p>过滤举例：</p><p>例如用 ‘A.B’ 初始化的 Filter，那么其允许Logger ‘A.B’, ‘A.B.C’, ‘A.B.C.D’, ‘A.B.D’ 等日志记录的事件，logger‘A.BB’, ‘B.A.B’ 等就不满足过滤的条件。</p><p>如果用空字符串来对Filter初始化，所有日志记录的事件都将不会被过滤。</p><h4><span id="formatter-格式器">Formatter 格式器</span></h4><p><code>Formater</code>主要负责日志的格式化输出的</p><p>构造方法：<code>ft = logging.Formatter.__init__(fmt=None, datefmt=None, style=&#39; %&#39;)</code></p><p><code>datefmt</code>默认是<code>%Y-%m-%d %H:%M:%S</code>样式的</p><p><code>style</code>参数默认为百分符%，这表示<code>%(&lt;dictionary key&gt;)s</code>格式的字符串</p><p>如果使用<code>logging</code>的组件呢，来看下面的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># logger 日志器</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;applog&#x27;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)<span class="comment"># console 和 file 想要打印不同的日志级别，需要logger设置成DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理器handler</span></span><br><span class="line">consoleHandler = logging.StreamHandler()</span><br><span class="line">consoleHandler.setLevel(logging.DEBUG)  <span class="comment"># console 打印的日志级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 没有给handler指定日志级别，将使用logger的级别</span></span><br><span class="line">fileHandler = logging.FileHandler(filename=<span class="string">&#x27;message.log&#x27;</span>)</span><br><span class="line">fileHandler.setLevel(logging.INFO)<span class="comment"># file 打印日志级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># formatter 格式</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s [%(levelname)s] [%(filename)s:%(lineno)s] [%(name)s] %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给处理器设置格式</span></span><br><span class="line">consoleHandler.setFormatter(formatter)</span><br><span class="line">fileHandler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录器设置处理器</span></span><br><span class="line">logger.addHandler(consoleHandler)</span><br><span class="line">logger.addHandler(fileHandler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志打印</span></span><br><span class="line">logger.debug(<span class="string">&#x27;This is a debug message&#x27;</span>)</span><br><span class="line">logger.info(<span class="string">&#x27;This is an info message&#x27;</span>)</span><br><span class="line">logger.warning(<span class="string">&#x27;This is an warning message&#x27;</span>)</span><br><span class="line">logger.error(<span class="string">&#x27;This is an error message&#x27;</span>)</span><br><span class="line">logger.critical(<span class="string">&#x27;This is an critical message&#x27;</span>)</span><br></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2024-04-10 23:46:28,312 [DEBUG] [test1.py:26] [applog] This is a debug message</span><br><span class="line">2024-04-10 23:46:28,313 [INFO] [test1.py:27] [applog] This is an info message</span><br><span class="line">2024-04-10 23:46:28,313 [WARNING] [test1.py:28] [applog] This is an warning message</span><br><span class="line">2024-04-10 23:46:28,313 [ERROR] [test1.py:29] [applog] This is an error message</span><br><span class="line">2024-04-10 23:46:28,313 [CRITICAL] [test1.py:30] [applog] This is an critical message</span><br></pre></td></tr></table></figure><h3><span id="配置文件">配置文件</span></h3><h4><span id="conf形式配置文件"><code>conf</code>形式配置文件</span></h4><p>我们知道在**logging.basicConfig()**中，是进行一些日志的配置的，如果每次都去改动代码，那将变得十分的麻烦，特别是在程序发布或者上线的时候。所以我们可以使用一个什么好的方法来规避这个问题呢？有的，那就是配置文件。</p><p>我们在文件<strong>logging.conf</strong>中写入相关的信息，内容如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[loggers]</span></span><br><span class="line"><span class="attr">keys</span>=root,appname</span><br><span class="line"></span><br><span class="line"><span class="section">[handlers]</span></span><br><span class="line"><span class="attr">keys</span>=fileHandler,consoleHandler</span><br><span class="line"></span><br><span class="line"><span class="section">[formatters]</span></span><br><span class="line"><span class="attr">keys</span>=simpleFormatter</span><br><span class="line"></span><br><span class="line"><span class="section">[logger_root]</span></span><br><span class="line"><span class="attr">level</span>=DEBUG</span><br><span class="line"><span class="comment">; logger.addHandler(consoleHandler)</span></span><br><span class="line"><span class="attr">handlers</span>=consoleHandler</span><br><span class="line"></span><br><span class="line"><span class="section">[logger_appname]</span></span><br><span class="line"><span class="attr">level</span>=DEBUG</span><br><span class="line"><span class="attr">handlers</span>=fileHandler,consoleHandler</span><br><span class="line"><span class="comment">; 别名 logging.getLogger(&#x27;appname&#x27;)</span></span><br><span class="line"><span class="attr">qualname</span>=appname</span><br><span class="line"><span class="comment">; 继承关系 0 不继承</span></span><br><span class="line"><span class="attr">propagate</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[handler_consoleHandler]</span></span><br><span class="line"><span class="comment">; consoleHandler = logging.StreamHandler()</span></span><br><span class="line"><span class="attr">class</span>=StreamHandler</span><br><span class="line"><span class="comment">; sys.stdout 标准输出，即 console 输出</span></span><br><span class="line"><span class="attr">args</span>=(sys.stdout,)</span><br><span class="line"><span class="attr">level</span>=DEBUG</span><br><span class="line"><span class="attr">formatter</span>=simpleFormatter</span><br><span class="line"></span><br><span class="line"><span class="section">[handler_fileHandler]</span></span><br><span class="line"><span class="attr">class</span>=handlers.TimedRotatingFileHandler</span><br><span class="line"><span class="comment">; 日志滚动更新，每天24点分隔日志，1 代表 delay多少s，0 代表文件保留的时间，0即不删除</span></span><br><span class="line"><span class="attr">args</span>=(<span class="string">&#x27;appname.log&#x27;</span>, <span class="string">&#x27;midnight&#x27;</span>, <span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line"><span class="attr">level</span>=DEBUG</span><br><span class="line"><span class="attr">formatter</span>=simpleFormatter</span><br><span class="line"></span><br><span class="line"><span class="section">[formatter_simpleFormatter]</span></span><br><span class="line"><span class="attr">format</span>=%(asctime)s [%(levelname)s] [%(filename)s:%(line<span class="literal">no</span>)s] [%(name)s] %(message)s</span><br><span class="line"><span class="comment">;datefmt=%Y-%m-%d %H:%M:%S</span></span><br></pre></td></tr></table></figure><p>使用配置文件的代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 载入配置文件信息</span></span><br><span class="line">logging.config.fileConfig(<span class="string">&#x27;logging.conf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rootLogger = logging.getLogger()</span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;appname&#x27;</span>)</span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">&#x27;debug message&#x27;</span>)</span><br><span class="line">rootLogger.info(<span class="string">&#x27;info message&#x27;</span>)</span><br><span class="line"></span><br><span class="line">a = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">int</span>(a)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    logger.exception(e)<span class="comment"># 使用logger.exception() 捕获异常，而非 logger.error()</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2024-04-11 00:28:56,077 [DEBUG] [test2.py:9] [appname] debug message</span><br><span class="line">2024-04-11 00:28:56,077 [INFO] [test2.py:10] [root] info message</span><br><span class="line">2024-04-11 00:28:56,077 [ERROR] [test2.py:17] [appname] invalid literal <span class="keyword">for</span> int() with base 10: <span class="string">&#x27;abc&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/Users/william/Desktop/tmp/logger_manager/test2.py&quot;</span>, line 15, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    int(a)</span><br><span class="line">ValueError: invalid literal <span class="keyword">for</span> int() with base 10: <span class="string">&#x27;abc&#x27;</span></span><br></pre></td></tr></table></figure><h3><span id="自定义logger日志输出文件">自定义<code>logger</code>日志输出文件</span></h3><p>以上介绍的知识点，大家在平时或在实际的项目中使用基本上就足够了，下面我们简单的介绍一下怎么进行自定义logger进行日志的输出。</p><p>我们写一个<strong>sel_def_logger.py</strong>文件，文件中的定义一个类，内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> strftime</span><br><span class="line"><span class="comment"># 输出日志路径</span></span><br><span class="line">PATH = os.path.abspath(<span class="string">&#x27;.&#x27;</span>) + <span class="string">&#x27;/logs/&#x27;</span></span><br><span class="line"><span class="comment"># 设置日志格式#和时间格式</span></span><br><span class="line">FMT = <span class="string">&#x27;%(asctime)s %(filename)s [line:%(lineno)d] %(levelname)s: %(message)s&#x27;</span></span><br><span class="line">DATEFMT = <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLog</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.logger = logging.getLogger()</span><br><span class="line">        self.formatter = logging.Formatter(fmt=FMT, datefmt=DATEFMT)</span><br><span class="line">        self.log_filename = <span class="string">&#x27;&#123;0&#125;&#123;1&#125;.log&#x27;</span>.<span class="built_in">format</span>(PATH, strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>))</span><br><span class="line"></span><br><span class="line">        self.logger.addHandler(self.get_file_handler(self.log_filename))</span><br><span class="line">        self.logger.addHandler(self.get_console_handler())</span><br><span class="line">        <span class="comment"># 设置日志的默认级别</span></span><br><span class="line">        self.logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出到文件handler的函数定义</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_file_handler</span>(<span class="params">self, filename</span>):</span></span><br><span class="line">        filehandler = logging.FileHandler(filename, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        filehandler.setFormatter(self.formatter)</span><br><span class="line">        <span class="keyword">return</span> filehandler</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出到控制台handler的函数定义</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_console_handler</span>(<span class="params">self</span>):</span></span><br><span class="line">        console_handler = logging.StreamHandler(sys.stdout)</span><br><span class="line">        console_handler.setFormatter(self.formatter)</span><br><span class="line">        <span class="keyword">return</span> console_handler</span><br></pre></td></tr></table></figure><p>那么使用这个类的方法可以这样写：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sef_def_logger <span class="keyword">import</span> MyLog</span><br><span class="line">my_logg = MyLog().logger</span><br><span class="line">my_logg.info(<span class="string">&quot;代码开始运行的时间&#123;&#125;&quot;</span>.<span class="built_in">format</span>(datetime.datetime.now()))</span><br><span class="line">my_logg.debug(<span class="string">&#x27;看看debug&#x27;</span>)</span><br><span class="line">my_logg.error(<span class="string">&#x27;This is a error&#x27;</span>)</span><br></pre></td></tr></table></figure><h3><span id="reference">Reference</span></h3><p><a href="https://docs.python.org/zh-cn/3/library/logging.html#module-logging">logging — Python的日志记录工具</a></p><p><a href="https://zhuanlan.zhihu.com/p/166671955">Python实用教程系列——Logging日志模块</a></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Logging库日志级别&quot;&gt;&lt;a href=&quot;#Logging库日志级别&quot; class=&quot;headerlink&quot; title=&quot;Logging库日志级别&quot;&gt;&lt;/a&gt;Logging库日志级别&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;级别&lt;/th&gt;
&lt;th&gt;级别数值&lt;/th&gt;
&lt;th&gt;使用时机&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;DEBUG&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;详细信息，常用于调试&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;INFO&lt;/td&gt;
&lt;td&gt;20&lt;/td&gt;
&lt;td&gt;程序正常运行过程中产生的一些信息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WARNNING&lt;/td&gt;
&lt;td&gt;30&lt;/td&gt;
&lt;td&gt;警告用户，虽然程序还在正常工作，但有可能发生错误&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ERROR&lt;/td&gt;
&lt;td&gt;40&lt;/td&gt;
&lt;td&gt;由于更严重的问题，程序已不能执行一些功能了&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CRITICAL&lt;/td&gt;
&lt;td&gt;50&lt;/td&gt;
&lt;td&gt;严重错误，程序已不能继续运行&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;默认的日志级别是warning&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Python" scheme="http://example.com/categories/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>Python多线程</title>
    <link href="http://example.com/2024/03/24/Python%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    <id>http://example.com/2024/03/24/Python%E5%A4%9A%E7%BA%BF%E7%A8%8B/</id>
    <published>2024-03-24T07:41:00.000Z</published>
    <updated>2024-04-02T16:24:34.751Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><ul><li><a href="#Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%AE%80%E4%BB%8B">Python并发编程简介</a></li><li><a href="#%E6%80%8E%E6%A0%B7%E9%80%89%E6%8B%A9%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E5%A4%9A%E5%8D%8F%E7%A8%8B%EF%BC%9F">怎样选择多线程、多进程、多协程？</a></li><li><a href="#GIL%E9%94%81">GIL锁</a></li><li><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8">多线程使用</a></li><li><a href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F">生产者-消费者模式</a></li><li><a href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3">线程安全问题和解决</a></li><li><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0">线程池</a></li><li><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9C%A8web%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%8A%A0%E9%80%9F">线程池在web服务中实现加速</a></li><li><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8">多进程使用</a></li><li><a href="#%E5%BC%82%E6%AD%A5IO%EF%BC%9Aanyncio">异步IO：anyncio</a></li></ul><h3><span id="python并发编程简介">Python并发编程简介</span></h3><p>因为CPU和IO是可以同时并行执行的，IO的执行，比如读取内存、磁盘、网络他的过程中是不需要CPU的参与的。这样的话使用多线程CPU可以释放出来，来执行其他Task，实现并发加速</p><p>同理加入多进程就可以同时使用多个CPU来执行多个Task，来为我们的程序提速</p><span id="more"></span><p><img src="./1.png"></p><ul><li><p>多线程：threading，利用CPU和IO可以同时执行的原理，让CPU不会干巴巴的等待IO</p></li><li><p>多进程：multiprocessing，利用多核CPU的能力，真正的并行执行任务</p></li><li><p>异步IO：asyncio，在单线程利用CPU和IO同时执行的原理，实现函数异步执行</p></li><li><p>当多线程和进程同时访问同一个文件时，我们可以<code>使用Lock对资源加锁，防止冲突访问</code>，有序访问</p></li><li><p>使用Queue实现不同线程/进程之间的数据通信，实现生产者-消费者模式</p></li><li><p>使用线程池Pool/进程池Pool，简化线程/进程的任务提交、等待结束、获取结果</p></li><li><p>使用subprocess启动外部程序的进程，并进行输入输出交互（如：你写好了一个exe程序，那么使用这个模块就可以调起这个exe，并跟它进行输入输出的交互，来实现交互式的进程通信）</p></li></ul><h3><span id="怎样选择多线程-多进程-多协程">怎样选择多线程、多进程、多协程？</span></h3><ol><li>什么事CPU密集型（CPU-bound）计算、IO密集型（I/O-bound）计算</li></ol><p><code>CPU密集型</code>也叫计算密集型，是指I/O在很短时间就可以完成，CPU需要大量的计算和处理，特点是CPU占用率相当高</p><p>例如：压缩解压缩、加密解密、正则表达式搜索</p><p><code>I/O密集型</code>指的是系统运行大部分时间都是CPU在等I/O（硬盘/内存）的读/写操作，CPU占用率仍然较低</p><p>例如：文件处理程序、网络爬虫程序、读写数据库程序</p><ol start="2"><li>多线程、多进程、多协程对比</li></ol><p><code>多进程 Process（multiprocessing）</code></p><ul><li>优点：可以利用多核CPU并行计算</li><li>缺点：占用资源最多、可启动数目比线程少</li><li>适用于：CPU密集型计算</li></ul><p><code>多线程 Thread（threading）</code></p><ul><li>优点：相比进程，更轻量级、占用资源少</li><li>缺点：<ul><li>相比进程：多线程只能并发执行，不能利用多CPU（GIL）</li><li>相比协程：启动数目有限制，占用内存资源，有线程切换开销</li></ul></li><li>适用于：IO密集型计算、同时运行任务数目要求不多</li></ul><p><code>多协程 Coroutine（asyncio）</code></p><p>一个线程可以启动N个协程</p><ul><li>优点：内存开销最少、启动协程数量最多</li><li>缺点：支持的库有限制（aiohttp vs requests）、代码实现复杂</li><li>适用于：IO密集型计算、需要超多歌任务运行、但有现成库支持的场景</li></ul><h3><span id="gil锁">GIL锁</span></h3><ul><li>Python速度慢的两大原因</li><li>GIL是什么</li><li>为什么有GIL这个东西</li><li>怎样规避GIL带来的限制</li></ul><h4><span id="python速度慢的原因">Python速度慢的原因</span></h4><ul><li>动态类型语言，边解释边执行</li><li>有GIL锁存在，无法利用多核CPU并发执行</li></ul><h4><span id="gil是什么">GIL是什么</span></h4><p>全局解释器锁（Global Interpreter Lock）</p><p>是计算机程序设计语言解释器用于同步线程的一种机制，他使得任何时刻仅有一个线程在执行</p><p>即便在多核心处理器上，使用GIL的解释器也只允许同一时间执行一个线程</p><p><img src="./GIL.png"></p><h4><span id="为什么有gil这个东西">为什么有GIL这个东西</span></h4><p><code>简而言之：Python设计初期，为了规避并发问题引入了GIL，现在无法去除</code></p><p>为了解决多线程之间数据完整性和状态同步问题</p><p>Python中对象的管理，是使用引用计数器进行的，引用数0则释放对象</p><p>开始：线程A和线程B都引用了对象obj，obj.ref_num = 2，线程A和B都想撤销对obj的引用</p><p><img src="./GIL%E8%AF%A6%E8%A7%A3.png"></p><p>不过GIL简化了Python对共享资源的管理</p><h4><span id="怎样规避gil带来的限制">怎样规避GIL带来的限制？</span></h4><ol><li><p>多线程threading机制依然是有用的，用于IO密集型计算</p><p>因为在 I/O（read, write, send, recv, etc.）期间，线程会释放GIL，实现CPU和IO的并行</p><p><strong>因此多线程用于IO密集型计算依然可以大幅提升速度</strong></p><p><strong>但多线程用于CPU密集型计算时，只会更加拖慢速度</strong></p></li><li><p>使用<code>multiprocessing</code>的多进程机制实现并行计算、利用多核CPU优势</p><p>为了对应GIL的问题，Python提供了<code>multiprocessing</code></p></li></ol><h3><span id="多线程使用">多线程使用</span></h3><h4><span id="python-创建多线程方法">Python 创建多线程方法</span></h4><ol><li><p>准备一个函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_func</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    do_craw(a,b)</span><br></pre></td></tr></table></figure></li><li><p>怎样创建一个线程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="comment"># target 传入一个函数</span></span><br><span class="line"><span class="comment"># args传的是一个元组</span></span><br><span class="line">t = threading.Thread(target=my_func, args=(<span class="number">100</span>,<span class="number">200</span>,) </span><br></pre></td></tr></table></figure></li><li><p>启动线程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t.start()</span><br></pre></td></tr></table></figure></li><li><p>等待结束</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t.join()</span><br></pre></td></tr></table></figure></li></ol><h4><span id="使用简单的多线程爬虫">使用简单的多线程爬虫</span></h4><p><code>blog_spider.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">f&quot;https://www.cnblogs.com/#p<span class="subst">&#123;page&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span> + <span class="number">1</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">craw</span>(<span class="params">url</span>):</span></span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="built_in">print</span>(url, <span class="built_in">len</span>(r.text))</span><br><span class="line"></span><br><span class="line"><span class="comment"># craw(urls[0])</span></span><br></pre></td></tr></table></figure><p><code>multi_thread_cray.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> blog_spider</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BenchmarkThread</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">        self.end = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;consume: <span class="subst">&#123;self.end - self.start&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_threaded_crawler</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start single thread crawling...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> blog_spider.urls:</span><br><span class="line">        blog_spider.craw(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end single thread crawling...&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_threaded_crawler</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start multi thread crawling...&quot;</span>)</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> blog_spider.urls:</span><br><span class="line">        threads.append(</span><br><span class="line">            threading.Thread(target=blog_spider.craw, args=(url, ))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end multi thread crawling...&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> BenchmarkThread():</span><br><span class="line">        single_threaded_crawler()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> BenchmarkThread():</span><br><span class="line">        multi_threaded_crawler()</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">start single thread crawling...</span><br><span class="line">...</span><br><span class="line">https://www.cnblogs.com/<span class="comment">#p49 71620</span></span><br><span class="line">https://www.cnblogs.com/<span class="comment">#p50 71620</span></span><br><span class="line">end single thread crawling...</span><br><span class="line">consume: 17.035787105560303</span><br><span class="line"></span><br><span class="line">start multi thread crawling...</span><br><span class="line">...</span><br><span class="line">https://www.cnblogs.com/<span class="comment">#p12 71620</span></span><br><span class="line">https://www.cnblogs.com/<span class="comment">#p4 71620</span></span><br><span class="line">end multi thread crawling...</span><br><span class="line">consume: 1.0366919040679932</span><br></pre></td></tr></table></figure><p>可以看出多线程要快了17倍左右</p><h3><span id="生产者-消费者模式">生产者-消费者模式</span></h3><ul><li>多组件的Pipeline技术架构</li><li>生产者-消费者爬虫的架构</li><li>多线程数据通信的queue.Queue</li><li>代码编写实现生产者消费者爬虫</li></ul><h4><span id="多组件的pipline技术架构">多组件的Pipline技术架构</span></h4><p><img src="./Pipline.png"></p><h4><span id="生产者-消费值爬虫架构">生产者-消费值爬虫架构</span></h4><p><img src="./Producer-Consumer.png"></p><h4><span id="多线程数据通信的queuequeue">多线程数据通信的queue.Queue</span></h4><p>queue.Queue可以用于多线程之间的、<strong>线程安全</strong>的数据通信</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Queue</span></span><br><span class="line">q = queue.Queue()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加元素</span></span><br><span class="line">q.put(item)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取元素</span></span><br><span class="line">item = q.get()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询状态</span></span><br><span class="line">q.qsize()<span class="comment"># 查看元素的多少</span></span><br><span class="line">q.empty()<span class="comment"># 判断是否为空</span></span><br><span class="line">q.full()<span class="comment"># 判断是否已满</span></span><br></pre></td></tr></table></figure><h4><span id="代码编写实现生产者消费者爬虫">代码编写实现生产者消费者爬虫</span></h4><p>modify <code>blog_spider.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> blog_spider</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fout</span>(<span class="params">file_path, data</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;a+&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="built_in">str</span>(data) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># producer</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_craw</span>(<span class="params">url_queue: queue.Queue, html_queue: queue.Queue</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        url = url_queue.get()</span><br><span class="line">        html = blog_spider.craw(url)</span><br><span class="line">        html_queue.put(html)</span><br><span class="line">        <span class="built_in">print</span>(threading.current_thread().name, <span class="string">f&quot;craw <span class="subst">&#123;url&#125;</span>&quot;</span>,</span><br><span class="line">              <span class="string">&quot;url_queue.size =&quot;</span>, url_queue.qsize())</span><br><span class="line">        time.sleep(random.randint(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># consumer</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_parse</span>(<span class="params">html_queue: queue.Queue, file_path</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        html = html_queue.get()</span><br><span class="line">        results = blog_spider.parse(html)</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            fout(file_path, result)</span><br><span class="line">        <span class="built_in">print</span>(threading.current_thread().name, <span class="string">f&quot;results.size&quot;</span>,</span><br><span class="line">              <span class="built_in">len</span>(results), <span class="string">&quot;html_queue.size =&quot;</span>, html_queue.qsize())</span><br><span class="line">        time.sleep(random.randint(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url_queue = queue.Queue()</span><br><span class="line">    html_queue = queue.Queue()</span><br><span class="line"></span><br><span class="line">    file_path = <span class="string">&#x27;./spider_data.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> blog_spider.urls:</span><br><span class="line">        url_queue.put(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># producer thread</span></span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        t = threading.Thread(target=do_craw, args=(url_queue, html_queue),</span><br><span class="line">                             name=<span class="string">f&quot;craw<span class="subst">&#123;idx&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># consumer thread</span></span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        t = threading.Thread(target=do_parse, args=(html_queue, file_path),</span><br><span class="line">                             name=<span class="string">f&quot;parse<span class="subst">&#123;idx&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure><h3><span id="线程安全问题和解决">线程安全问题和解决</span></h3><ul><li>线程安全概念介绍</li><li>Lock用于解决线程安全问题</li><li>实例代码演示问题以及解决方案</li></ul><h4><span id="线程安全概念介绍">线程安全概念介绍</span></h4><p>线程安全指某个函数、函数库在多线程环境中被调用时，能够正确处理多个线程之间的共享变量，使程序功能正确完成</p><p>由于线程的执行随时会发生切换，就造成了不可预料的结果，出现线程不安全</p><p>例如：两个线程先后进入 if 语句，第一个线程执行后，第二个线程也执行了（其实不应该执行）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span>(<span class="params">account, amount</span>):</span></span><br><span class="line">    <span class="keyword">if</span> account.balance &gt;= amount:</span><br><span class="line">        account.balance -= amount</span><br></pre></td></tr></table></figure><p><img src="./thread_security.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, balance</span>):</span></span><br><span class="line">        self.balance = balance</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span>(<span class="params">account, amount</span>):</span></span><br><span class="line">    <span class="keyword">if</span> account.balance &gt;= amount:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>) <span class="comment"># blocking can lead to thread switching </span></span><br><span class="line">        <span class="built_in">print</span>(threading.current_thread().name,</span><br><span class="line">              <span class="string">&quot;withdraw money successfully&quot;</span>)</span><br><span class="line">        account.balance -= amount</span><br><span class="line">        <span class="built_in">print</span>(threading.current_thread().name,</span><br><span class="line">              <span class="string">&quot;balance&quot;</span>, account.balance)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(threading.current_thread().name,</span><br><span class="line">              <span class="string">&quot;withdrawal failure insuffcient balance&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    account = Account(<span class="number">1000</span>)</span><br><span class="line">    ta = threading.Thread(target=draw, args=(account, <span class="number">800</span>), name=<span class="string">&quot;ta&quot;</span>)</span><br><span class="line">    tb = threading.Thread(target=draw, args=(account, <span class="number">800</span>), name=<span class="string">&quot;tb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ta.start()</span><br><span class="line">    tb.start()</span><br></pre></td></tr></table></figure><p>结果1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tatb withdraw money successfully</span><br><span class="line">ta balance 200 withdraw money successfully</span><br><span class="line">tb balance -600</span><br></pre></td></tr></table></figure><h4><span id="lock用于解决线程安全问题">Lock用于解决线程安全问题</span></h4><p><img src="./solve_thread_security.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, balance</span>):</span></span><br><span class="line">        self.balance = balance</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span>(<span class="params">account, amount</span>):</span></span><br><span class="line">  <span class="keyword">with</span> lock: <span class="comment"># adding a lock to a thread</span></span><br><span class="line">      <span class="keyword">if</span> account.balance &gt;= amount:</span><br><span class="line">          time.sleep(<span class="number">0.1</span>) <span class="comment"># blocking can lead to thread switching </span></span><br><span class="line">          <span class="built_in">print</span>(threading.current_thread().name,</span><br><span class="line">                <span class="string">&quot;withdraw money successfully&quot;</span>)</span><br><span class="line">          account.balance -= amount</span><br><span class="line">          <span class="built_in">print</span>(threading.current_thread().name,</span><br><span class="line">                <span class="string">&quot;balance&quot;</span>, account.balance)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          <span class="built_in">print</span>(threading.current_thread().name,</span><br><span class="line">                <span class="string">&quot;withdrawal failure insuffcient balance&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    account = Account(<span class="number">1000</span>)</span><br><span class="line">    ta = threading.Thread(target=draw, args=(account, <span class="number">800</span>), name=<span class="string">&quot;ta&quot;</span>)</span><br><span class="line">    tb = threading.Thread(target=draw, args=(account, <span class="number">800</span>), name=<span class="string">&quot;tb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ta.start()</span><br><span class="line">    tb.start()</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ta withdraw money successfully</span><br><span class="line">ta balance 200</span><br><span class="line">tb withdrawal failure insuffcient balance</span><br></pre></td></tr></table></figure><h3><span id="线程池">线程池</span></h3><ul><li>线程池的原理</li><li>使用线程池的好吃</li><li>ThreadPoolExecutor的使用语法</li><li>使用线程池改造爬虫程序</li></ul><p><font color="orange">使用线程池本身不需要加锁，但<strong>在访问和修改共享数据时可能需要使用锁</strong>或其他同步机制来确保线程安全</font></p><h4><span id="线程池的原理">线程池的原理</span></h4><p><img src="./threadPool_principle.png"></p><p>因为新建线程系统需要分配资源、终止线程系统需要回收资源</p><p>那么如果可以重用线程，则可以减去新建/终止的开销</p><p><img src="./threadPool.png"></p><p>线程池本身为提前预先建好的线程，这些线程会被重复的使用、</p><p>当有新任务时先放入任务队列，线程池里的线程会挨个取队列里的线程，依次执行</p><p>当没有任务时，回到线程池，并不会被销毁，等待下一个任务到来</p><h4><span id="使用线程池的好处">使用线程池的好处</span></h4><ol><li>提升性能：因为减去了大量新建、终止线程的开销，重用了线程资源</li><li>适用场景：适合处理突发性大量请求或需要大量线程完成的任务，但实际任务处理时间较短</li><li>防御功能：能有效避免系统因为创建线程过多，而导致系统负荷过大相应变慢等问题</li><li>代码优势：使用线程池的语法比自己新建线程执行线程更加简洁</li></ol><h4><span id="threadpoolexecutor的使用语法">ThreadPoolExecutor的使用语法</span></h4><p><img src="./ThreadPoolExecutor.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">    results = pool.<span class="built_in">map</span>(craw, urls) <span class="comment"># 提前把urls都准备好，进行全部的执行</span></span><br><span class="line">    <span class="keyword">for</span> result im results:</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>用法1：map 函数，很简单</p><p>注意 map 的结果和入参是顺序对应的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">    futures = [pool.submit(craw, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> futures: <span class="comment"># 挨个等待每一个按顺序的结束，进行返回和打印</span></span><br><span class="line">        <span class="built_in">print</span>(future.result())</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures): <span class="comment"># 不管里面那个任务先执行完了，它就会先进行返回</span></span><br><span class="line">        <span class="built_in">print</span>(future.result())</span><br></pre></td></tr></table></figure><p>用法2：future模式，更强大</p><p>注意如果使用 as_completed 顺序是不定的</p><h4><span id="使用线程池改造爬虫程序">使用线程池改造爬虫程序</span></h4><p><code>thread_pool.py</code></p><p>使用<code>pool.map</code> 、 <code>futures</code>和<code>as_completed</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> blog_spider</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">    htmls = pool.<span class="built_in">map</span>(blog_spider.craw, blog_spider.urls)</span><br><span class="line">    htmls = <span class="built_in">list</span>(<span class="built_in">zip</span>(blog_spider.urls, htmls))</span><br><span class="line">    <span class="keyword">for</span> url, html <span class="keyword">in</span> htmls:</span><br><span class="line">        <span class="built_in">print</span>(url, <span class="built_in">len</span>(html))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;craw over&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">    futures = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> url, html <span class="keyword">in</span> htmls:</span><br><span class="line">        future = pool.submit(blog_spider.parse, html)</span><br><span class="line">        futures[future] = url</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> future, url <span class="keyword">in</span> futures.items():</span><br><span class="line">        <span class="built_in">print</span>(url, future.result())</span><br></pre></td></tr></table></figure><p><img src="./pool-map%E5%92%8Cfuture.png"></p><p>可以看出是顺序执行的，下面看看使用<code>futures.as_completed</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> blog_spider</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">    htmls = pool.<span class="built_in">map</span>(blog_spider.craw, blog_spider.urls)</span><br><span class="line">    htmls = <span class="built_in">list</span>(<span class="built_in">zip</span>(blog_spider.urls, htmls))</span><br><span class="line">    <span class="keyword">for</span> url, html <span class="keyword">in</span> htmls:</span><br><span class="line">        <span class="built_in">print</span>(url, <span class="built_in">len</span>(html))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;craw over&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">    futures = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> url, html <span class="keyword">in</span> htmls:</span><br><span class="line">        future = pool.submit(blog_spider.parse, html)</span><br><span class="line">        futures[future] = url</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> future, url <span class="keyword">in</span> futures.items():</span><br><span class="line">        <span class="built_in">print</span>(url, future.result())</span><br></pre></td></tr></table></figure><p><img src="./concurrent.futures.as_completed.png"></p><p>那个任务先执行完成，就先返回那个任务</p><p>总结</p><ul><li><code>pool.map</code>方式更加简洁，但你需要把所有的任务提前准备好，才能一次性提交。并且返回是按顺序返回的</li><li><code>pool.submit</code>方式是单个提交任务。<code>for future in futures</code>是按顺序返回的，而<code>for future in as_completed</code>那个任务先执行完成，就先返回那个</li><li>更推荐使用<code>for future in as_completed</code></li></ul><h3><span id="线程池在web服务中实现加速">线程池在web服务中实现加速</span></h3><ul><li>Web服务的架构以及特点</li><li>使用线程池ThreadPoolExecutor加速</li><li>代码使用Flask实现Web服务并实现加速</li></ul><h4><span id="web服务的架构以及特点">Web服务的架构以及特点</span></h4><p><img src="./Web%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9E%B6%E6%9E%84%E4%BB%A5%E5%8F%8A%E7%89%B9%E7%82%B9.png"></p><p>Web后台服务的特点</p><ul><li>Web服务对响应时间要求非常高，比如要求200ms内返回</li><li>Web服务有大量的依赖IO操作的调用，比如磁盘文件、数据库、远程API</li><li>Web服务经常需要处理几万人、几百万人的同时请求</li></ul><h4><span id="使用线程池threadpoolexecutor加速">使用线程池ThreadPoolExecutor加速</span></h4><p>使用线程池ThreadPoolExecutor的好处：</p><ul><li>方便的将磁盘文件、数据库、远程API的IO调用并发执行</li><li>线程池的线程数目不会无限创建（导致系统挂掉），具有防御功能</li></ul><h4><span id="代码使用flask实现web服务并实现加速">代码使用Flask实现Web服务并实现加速</span></h4><p><code>flask_thread_pool.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>():</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read_file&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_db</span>():</span></span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read_db&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_api</span>():</span></span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read_api&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    result_file = read_file()</span><br><span class="line">    result_db = read_db()</span><br><span class="line">    result_api = read_api()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json.dumps(&#123;</span><br><span class="line">        <span class="string">&quot;result_file&quot;</span>: result_file,</span><br><span class="line">        <span class="string">&quot;result_db&quot;</span>: result_db,</span><br><span class="line">        <span class="string">&quot;result_api&quot;</span>: result_api</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p><code>time curl http://127.0.0.1</code></p><p><img src="./time_curl.png"></p><p>可以看出每一次请求大概消耗600ms左右（三个IO操作，以及系统时间），那么这个程序我们如何改造和加速呢？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">pool = ThreadPoolExecutor() <span class="comment"># 初始化全局线程池</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>():</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read_file&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_db</span>():</span></span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read_db&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_api</span>():</span></span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;read_api&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    result_file = pool.submit(read_file)</span><br><span class="line">    result_db = pool.submit(read_db)</span><br><span class="line">    result_api = pool.submit(read_api)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json.dumps(&#123;</span><br><span class="line">        <span class="string">&quot;result_file&quot;</span>: result_file.result(),</span><br><span class="line">        <span class="string">&quot;result_db&quot;</span>: result_db.result(),</span><br><span class="line">        <span class="string">&quot;result_api&quot;</span>: result_api.result()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>结果</p><p><img src="./time_curl_improve.png"></p><p>为什么是300ms左右呢？因为他们并发同时运行时，花费最多的就是<code>read_api()</code>300ms，其他两个都在300ms内完成，所以请求花费时间基本等于最长消耗时间的函数了</p><h3><span id="多进程使用">多进程使用</span></h3><ul><li>有了多线程threading，为什么还要使用多进程multiprocessing</li><li>多进程mutiprocessing知识梳理（对比多线程threading）</li><li>单线程、多线程、多进程对CPU密集计算速度</li></ul><h4><span id="有了多线程threading为什么还要使用多进程multiprocessing">有了多线程threading，为什么还要使用多进程multiprocessing</span></h4><p><img src="./multiprocessing_issue.png"></p><p><strong><font color="orange">multiprocessing 模块就是python为了解决GIL缺陷引入的一个模块，原理是用多进程在多CPU上并行执行</font></strong></p><h4><span id="多进程mutiprocessing知识梳理">多进程mutiprocessing知识梳理</span></h4><p><img src="./%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86.png"></p><h4><span id="单线程-多线程-多进程cpu密集计算速度">单线程、多线程、多进程CPU密集计算速度</span></h4><p><img src="./%E5%8D%95%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8BCPU%E5%AF%86%E9%9B%86%E8%AE%A1%E7%AE%97%E9%80%9F%E5%BA%A6.png"></p><p><code>thread_process_cpu_bound.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math, time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line">PRIMES = [<span class="number">112272535095293</span>] * <span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Benchmark</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, description</span>):</span></span><br><span class="line">        self.description = description</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.start_time = time.time()</span><br><span class="line">        <span class="built_in">print</span>(self.description)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">        self.end_time = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;consume: <span class="subst">&#123;self.end_time - self.start_time&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_prime</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    sqrt_n = <span class="built_in">int</span>(math.floor(math.sqrt(n)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, sqrt_n + <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> n % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_thread</span>():</span></span><br><span class="line">    <span class="keyword">for</span> number <span class="keyword">in</span> PRIMES:</span><br><span class="line">        is_prime(number)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_thread</span>():</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">        pool.<span class="built_in">map</span>(is_prime, PRIMES)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_process</span>():</span></span><br><span class="line">    <span class="keyword">with</span> ProcessPoolExecutor() <span class="keyword">as</span> pool:</span><br><span class="line">        pool.<span class="built_in">map</span>(is_prime, PRIMES)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> Benchmark(<span class="string">&quot;single thread&quot;</span>):</span><br><span class="line">        single_thread()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> Benchmark(<span class="string">&quot;multi thread&quot;</span>):</span><br><span class="line">        multi_thread()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> Benchmark(<span class="string">&quot;multi process&quot;</span>):</span><br><span class="line">        multi_process()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">single thread</span><br><span class="line">consume: 22.90883493423462</span><br><span class="line">multi thread</span><br><span class="line">consume: 22.713069915771484</span><br><span class="line">multi process</span><br><span class="line">consume: 4.842185974121094</span><br></pre></td></tr></table></figure><h4><span id="在flask服务中使用进程池加速">在Flask服务中使用进程池加速</span></h4><p><code>flask_process_pool.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask, math, json</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">process_pool = ProcessPoolExecutor()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_prime</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    sqrt_n = <span class="built_in">int</span>(math.floor(math.sqrt(n)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, sqrt_n + <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> n % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/is_prime/&lt;numbers&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_is_prime</span>(<span class="params">numbers</span>):</span></span><br><span class="line">    number_list = [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> numbers.split(<span class="string">&quot;,&quot;</span>)]</span><br><span class="line">    results = process_pool.<span class="built_in">map</span>(is_prime, number_list)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(<span class="built_in">dict</span>(<span class="built_in">zip</span>(number_list, results)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:    </span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>请求路径<code>http://127.0.0.1:5000/is_prime/1,2,3,4</code></p><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;1&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;2&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;3&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;4&quot;</span>: <span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure><h3><span id="异步ioanyncio">异步IO：anyncio</span></h3><p>在一个线程中如果遇到IO等待时间，线程不会傻傻等待，利用空闲的时候去干其他事情</p><p>语法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义协程</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">myfunc</span>(<span class="params">url</span>):</span></span><br><span class="line">  <span class="keyword">await</span> get_url(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建task列表</span></span><br><span class="line">tasks = [loop.create_task(myfunc(url)) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去生成或者获取一个事件循环</span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将任务放到任务列表</span></span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure><p>注意：</p><ol><li>要用在异步IO编程中，依赖的库必须支持异步IO特性</li><li>爬虫引用中：<code>requests</code> 不支持异步，需要用 <code>aiohttp</code></li></ol><p><img src="./%E5%8D%8F%E7%A8%8B.png"></p><p>python3.4及以后版本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">2</span>) <span class="comment"># 遇到IO耗时操作，自动切换到tasks中的其他任务</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="number">2</span>)</span><br><span class="line">  </span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="number">3</span>)</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="number">4</span>)</span><br><span class="line">  </span><br><span class="line">tasks = [</span><br><span class="line">  asyncio.ensure_future(func1()),</span><br><span class="line">  asyncio.ensure_future(func2())</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure><p>python3.5及以后版本（推荐），使用 anync &amp; await 关键字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func1</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>) <span class="comment"># 遇到IO耗时操作，自动切换到tasks中的其他任务</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="number">2</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func2</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="number">3</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="number">4</span>)</span><br><span class="line">  </span><br><span class="line">tasks = [</span><br><span class="line">  asyncio.ensure_future(func1()),</span><br><span class="line">  asyncio.ensure_future(func2())</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure><p>使用协程异步保存文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">session, url</span>):</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;发送请求: &quot;</span>, url)</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, verify_ssl=<span class="literal">False</span>) <span class="keyword">as</span> response:</span><br><span class="line">    content = <span class="keyword">await</span> response.content.read()</span><br><span class="line">    file_name = url.rsplit(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;下载完成: &quot;</span>, url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">    url_list = [</span><br><span class="line">      <span class="string">&#x27;https://dailybing.com/view/zh-cn/20240109.html&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://dailybing.com/view/zh-cn/20240112.html&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;https://dailybing.com/view/zh-cn/20240113.html&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    tasks = [asyncio.create_task(fetch(session, url)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  asyncio.run(main())</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">发送请求:  https://dailybing.com/view/zh-cn/20240109.html</span><br><span class="line">发送请求:  https://dailybing.com/view/zh-cn/20240112.html</span><br><span class="line">发送请求:  https://dailybing.com/view/zh-cn/20240113.html</span><br><span class="line">下载完成:  https://dailybing.com/view/zh-cn/20240112.html</span><br><span class="line">下载完成:  https://dailybing.com/view/zh-cn/20240113.html</span><br><span class="line">下载完成:  https://dailybing.com/view/zh-cn/20240109.html</span><br></pre></td></tr></table></figure><h4><span id="python-异步io库介绍asyncio">Python 异步IO库介绍：asyncio</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">result = func()</span><br></pre></td></tr></table></figure><p><strong>执行协程函数创建的写成对象，函数内部代码不会执行</strong></p><p>如果想要运行协程函数内部代码，必须要将协程对象交给事件循环来处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  </span><br><span class="line">result = func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># loop = asyncio.get_event_loop()</span></span><br><span class="line"><span class="comment"># loop.run_until_complete(result) # 将函数添加到任务列表中</span></span><br><span class="line">asyncio.run(result) <span class="comment"># python 3.7及以后，代替上面两步</span></span><br></pre></td></tr></table></figure><h4><span id="await">await</span></h4><p><code>await</code> + 可等待的对象（协程对象、Future、Task对象 -&gt; IO等待）</p><p>示例1：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  response = <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>) <span class="comment"># IO等待</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;结束&quot;</span>,response)</span><br><span class="line"></span><br><span class="line">asyncio.run(func())</span><br></pre></td></tr></table></figure><p>示例2：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">others</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;返回值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;执行协程函数内部代码&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起任务时，事件循环可以去执行其他协程（任务）</span></span><br><span class="line">  response = <span class="keyword">await</span> others()</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;IO请求结束, 结果为: &quot;</span>, response)</span><br><span class="line"></span><br><span class="line">asyncio.run(func())</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">执行协程函数内部代码</span><br><span class="line">start</span><br><span class="line">end</span><br><span class="line">IO请求结束, 结果为:  返回值</span><br></pre></td></tr></table></figure><p><code>await</code>就是等待对象的值得到结果后再继续执行</p><h4><span id="task对象">Task对象</span></h4><blockquote><p>Tasks are used to schedule coroutines concurrently</p><p>When a coroutine is wrapped into a Task with functions like <code>asyncio.create_ task()</code> the coroutine is automatically scheduled to run soon.</p></blockquote><p>在事件循环中添加多个任务</p><p>Tasks 用于并发调度协程，通过<code>asyncio.create_task(协程对象)</code>的方式创建Task对象，这样可以让协程加入事件，循环中等待被调度执行。除了使用<code>asyncio.create_task()</code>函数以外（python3.7），还可以用低层级的<code>loop.create_task()</code>或<code>ensure_future()</code>函数（python3.7之前）。不建议手动实例化Task对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;返回值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建Task对象，将当前执行func函数任务添加到事件循环中</span></span><br><span class="line">  task1 = asyncio.create_task(func())</span><br><span class="line">  task2 = asyncio.create_task(func())</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 当执行某协程遇到IO操作时，会自动化切换执行其他任务</span></span><br><span class="line">  <span class="comment"># 此处的await是等待相对应的协程全都执行完毕并获取结果</span></span><br><span class="line">  ret1 = <span class="keyword">await</span> task1</span><br><span class="line">  ret2 = <span class="keyword">await</span> task2</span><br><span class="line">  <span class="built_in">print</span>(ret1, ret2)</span><br><span class="line">  </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">end</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">返回值 返回值</span><br></pre></td></tr></table></figure><p>简化写法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;返回值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建Task对象，将当前执行func函数任务添加到事件循环中</span></span><br><span class="line">  task_list = [</span><br><span class="line">    asyncio.create_task(func(), name=<span class="string">&#x27;n1&#x27;</span>),</span><br><span class="line">    asyncio.create_task(func(), name=<span class="string">&#x27;n2&#x27;</span>)</span><br><span class="line">  ]</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 当执行某协程遇到IO操作时，会自动化切换执行其他任务</span></span><br><span class="line">  <span class="comment"># 此处的await是等待相对应的协程全都执行完毕并获取结果</span></span><br><span class="line"></span><br><span class="line">  done, pending = <span class="keyword">await</span> asyncio.wait(task_list, timeout=<span class="literal">None</span>) <span class="comment"># timeout 最多等待时间。 如果等待后未完成，pending返回一个未完成的集合</span></span><br><span class="line">  <span class="built_in">print</span>(done) <span class="comment"># 返回一个完成的集合</span></span><br><span class="line">  </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">end</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">&#123;&lt;Task finished name=&#x27;n1&#x27; coro=&lt;func() done, defined at test.py:3&gt; result=&#x27;返回值&#x27;&gt;, &lt;Task finished name=&#x27;n2&#x27; coro=&lt;func() done, defined at test.py:3&gt; result=&#x27;返回值&#x27;&gt;&#125;</span><br></pre></td></tr></table></figure><h4><span id></span></h4><h4><span id="asynciofuture对象">asyncio.Future对象</span></h4><blockquote><p>A <code>Future</code>is a special <strong>low-level</strong> awaitable object that represents an <strong>eventual result</strong> of an asynchronous operation.</p></blockquote><p>asyncio中的Future对象是一个相对更偏向底层的可对象，通常我们不会直接用到这个对象，而是直接使用Task对象来完成任务的并和状态的追踪。（ Task 是 Futrue的子类 ）</p><p>Future为我们提供了异步编程中的 最终结果 的处理（Task类也具备状态处理的功能）。</p><p>示例1：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># 获取当前事件循环</span></span><br><span class="line">    loop = asyncio.get_running_loop()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 创建一个任务（Future对象），这个任务什么都不干。</span></span><br><span class="line">    fut = loop.create_future()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待任务最终结果（Future对象），没有结果则会一直等下去。</span></span><br><span class="line">    <span class="keyword">await</span> fut</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>示例2：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">set_after</span>(<span class="params">fut</span>):</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    fut.set_result(<span class="string">&quot;666&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># 获取当前事件循环</span></span><br><span class="line">    loop = asyncio.get_running_loop()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个任务（Future对象），没绑定任何行为，则这个任务永远不知道什么时候结束。</span></span><br><span class="line">    fut = loop.create_future()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个任务（Task对象），绑定了set_after函数，函数内部在2s之后，会给fut赋值。</span></span><br><span class="line">    <span class="comment"># 即手动设置future任务的最终结果，那么fut就可以结束了。</span></span><br><span class="line">    <span class="keyword">await</span> loop.create_task(set_after(fut))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待 Future对象获取 最终结果，否则一直等下去</span></span><br><span class="line">    data = <span class="keyword">await</span> fut</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>Future对象本身函数进行绑定，所以想要让事件循环获取Future的结果，则需要手动设置。而Task对象继承了Future对象，其实就对Future进行扩展，他可以实现在对应绑定的函数执行完成之后，自动执行<code>set_result</code>，从而实现自动结束。</p><p>虽然，平时使用的是Task对象，但对于结果的处理本质是基于Future对象来实现的。</p><p>扩展：支持 <code>await 对象</code>语 法的对象课成为可等待对象，所以 <code>协程对象</code>、<code>Task对象</code>、<code>Future对象</code> 都可以被成为可等待对象。</p><h4><span id="futuresfuture对象">futures.Future对象</span></h4><p><code>concurrent.futures.Future对象</code>使用线程池、进程池实现异步操作时用到的对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> Future</span><br><span class="line"><span class="keyword">from</span> concurrent.futrues.thread <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">from</span> concurrent.futrues.process <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">value</span>):</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建线程池</span></span><br><span class="line">pool = ThreadPoolExecutor(max_workers=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建进程池</span></span><br><span class="line"><span class="comment"># pool = ProcessPoolExecutor(max_workers=5)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    fut = pool.submit(func, i)</span><br><span class="line">    <span class="built_in">print</span>(fut)</span><br></pre></td></tr></table></figure><p>两个Future对象是不同的，他们是为不同的应用场景而设计，例如：<code>concurrent.futures.Future</code>不支持await语法等</p><p>官方提示两对象之间不同：</p><ul><li>unlike asyncio Futures, <code>concurrent.futures.Future</code> instances cannot be awaited.</li><li><code>asyncio.Future.result()</code> and <code>asyncio.Future.exception()</code> do not accept the <em>timeout</em> argument.</li><li><code>asyncio.Future.result()</code> and <code>asyncio.Future.exception()</code> raise an <code>InvalidStateError</code> exception when the Future is not <em>done</em>.</li><li>Callbacks registered with <code>asyncio.Future.add_done_callback()</code> are not called immediately. They are scheduled with <code>loop.call_soon()</code> instead.</li><li>asyncio Future is not compatible with the <code>concurrent.futures.wait()</code> and <code>concurrent.futures.as_completed()</code> functions.</li></ul><p>在Python提供了一个将<code>futures.Future</code> 对象包装成<code>asyncio.Future</code>对象的函数 <code>asynic.wrap_future</code></p><p>一般在程序开发中我们要么统一使用 asycio 的协程实现异步操作、要么都使用进程池和线程池实现异步操作。但如果 <code>协程的异步</code>和 <code>进程池/线程池的异步</code> 混搭时，那么就会用到此功能了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span>():</span></span><br><span class="line">    <span class="comment"># 某个耗时操作</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;SB&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    loop = asyncio.get_running_loop()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. Run in the default loop&#x27;s executor ( 默认ThreadPoolExecutor )</span></span><br><span class="line">    <span class="comment"># 第一步：内部会先调用 ThreadPoolExecutor 的 submit 方法去线程池中申请一个线程去执行func1函数，并返回一个concurrent.futures.Future对象</span></span><br><span class="line">    <span class="comment"># 第二步：调用asyncio.wrap_future将concurrent.futures.Future对象包装为asycio.Future对象。</span></span><br><span class="line">    <span class="comment"># 因为concurrent.futures.Future对象不支持await语法，所以需要包装为 asycio.Future对象 才能使用。</span></span><br><span class="line">    fut = loop.run_in_executor(<span class="literal">None</span>, func1)</span><br><span class="line">    result = <span class="keyword">await</span> fut</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;default thread pool&#x27;</span>, result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. Run in a custom thread pool:</span></span><br><span class="line">    <span class="comment"># with concurrent.futures.ThreadPoolExecutor() as pool:</span></span><br><span class="line">    <span class="comment">#     result = await loop.run_in_executor(</span></span><br><span class="line">    <span class="comment">#         pool, func1)</span></span><br><span class="line">    <span class="comment">#     print(&#x27;custom thread pool&#x27;, result)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. Run in a custom process pool:</span></span><br><span class="line">    <span class="comment"># with concurrent.futures.ProcessPoolExecutor() as pool:</span></span><br><span class="line">    <span class="comment">#     result = await loop.run_in_executor(</span></span><br><span class="line">    <span class="comment">#         pool, func1)</span></span><br><span class="line">    <span class="comment">#     print(&#x27;custom process pool&#x27;, result)</span></span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><h4><span id="asyncio-不支持异步模块">asyncio + 不支持异步模块</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">download_file</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="comment"># 发送网络请求,下载文件(遇到网络下载文件IO请求,自动切换到其他任务)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;开始下载:&quot;</span>, url)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="comment"># requests模块默认不支持异步操作,所以使用线程池来配合实现</span></span><br><span class="line">    future = loop.run_in_executor(<span class="literal">None</span>, requests.get, url)</span><br><span class="line"></span><br><span class="line">    response = <span class="keyword">await</span> future</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;下载完成:&quot;</span>, url)</span><br><span class="line">    <span class="comment"># 文件保存到本地</span></span><br><span class="line">    file_name = url.rsplit(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    url_list = [</span><br><span class="line">        <span class="string">&quot;https://dailybing.com/view/zh-cn/20240109.html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dailybing.com/view/zh-cn/20240110.html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dailybing.com/view/zh-cn/20240111.html&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    tasks = [download_file(url) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure><p><a href="https://www.bilibili.com/video/BV1bK411A7tV?p=12&vd_source=7edae3cd790e850cc7836ab5c5d9ac4b">https://www.bilibili.com/video/BV1bK411A7tV?p=12&amp;vd_source=7edae3cd790e850cc7836ab5c5d9ac4b</a></p><p><a href="https://www.dabeaz.com/python/UnderstandingGIL.pdf">Understanding GIL</a></p><p><a href="https://zhuanlan.zhihu.com/p/354358309">https://zhuanlan.zhihu.com/p/354358309</a></p><p><a href="https://docs.python.org/zh-cn/3.9/library/asyncio-task.html">https://docs.python.org/zh-cn/3.9/library/asyncio-task.html</a></p><p><a href="https://zhuanlan.zhihu.com/p/137057192">https://zhuanlan.zhihu.com/p/137057192</a></p>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%AE%80%E4%BB%8B&quot;&gt;Python并发编程简介&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%80%8E%E6%A0%B7%E9%80%89%E6%8B%A9%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E5%A4%9A%E5%8D%8F%E7%A8%8B%EF%BC%9F&quot;&gt;怎样选择多线程、多进程、多协程？&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#GIL%E9%94%81&quot;&gt;GIL锁&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8&quot;&gt;多线程使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F&quot;&gt;生产者-消费者模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3&quot;&gt;线程安全问题和解决&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%BA%BF%E7%A8%8B%E6%B1%A0&quot;&gt;线程池&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9C%A8web%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%8A%A0%E9%80%9F&quot;&gt;线程池在web服务中实现加速&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8&quot;&gt;多进程使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%BC%82%E6%AD%A5IO%EF%BC%9Aanyncio&quot;&gt;异步IO：anyncio&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;Python并发编程简介&quot;&gt;&lt;a href=&quot;#Python并发编程简介&quot; class=&quot;headerlink&quot; title=&quot;Python并发编程简介&quot;&gt;&lt;/a&gt;Python并发编程简介&lt;/h3&gt;&lt;p&gt;因为CPU和IO是可以同时并行执行的，IO的执行，比如读取内存、磁盘、网络他的过程中是不需要CPU的参与的。这样的话使用多线程CPU可以释放出来，来执行其他Task，实现并发加速&lt;/p&gt;
&lt;p&gt;同理加入多进程就可以同时使用多个CPU来执行多个Task，来为我们的程序提速&lt;/p&gt;</summary>
    
    
    
    <category term="Python" scheme="http://example.com/categories/Python/"/>
    
    
    <category term="多线程" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>pytest-Allure</title>
    <link href="http://example.com/2024/03/12/pytest-Allure/"/>
    <id>http://example.com/2024/03/12/pytest-Allure/</id>
    <published>2024-03-12T14:19:53.000Z</published>
    <updated>2024-03-18T09:51:43.603Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h3><span id="allure报告结构">Allure报告结构</span></h3><ul><li><p>Overview:整体数据显示。</p></li><li><p>Suites:用例集合,按照套件和类分组的已执行测试的标准结构表示形式。</p></li><li><p>Behaviors：对于行为驱动的方法，此选项卡根据Epic、Feature和Story标记对测试结果进行分组。</p></li><li><p>Categories：“类别”选项卡提供了创建自定义缺陷分类以应用测试结果的方法。</p></li><li><p>Graphs：用图表显示测试数据中收集的不同统计数据，状态分解或严重性和持续时间图。</p></li><li><p>Packages：软件包选项卡表示测试结果的树状布局，按不同的包名分组。</p></li><li><p>Timeline：时间轴选项卡可视化测试执行的回顾，allure适配器收集测试的精确时间，在这个选项卡上，它们相应地按照顺序或并行的时间结构排列。</p></li></ul><span id="more"></span><h3><span id="allure安装">Allure安装</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install allure-pytest</span><br></pre></td></tr></table></figure><ol><li>下载 allure ZIP包 <code>https://github.com/allure-framework/allure2/releases</code></li><li><code>pip install pytest-allure</code></li><li><code>vim ~/.zshrc</code> 并在最后一行添加环境变量 <code>export PATH=&quot;/Users/william/DYJ/Tools/allure-2.7.0/bin:$PATH&quot;</code></li><li>使环境变量生效 <code>source ~/.zshrc</code></li><li>验证 <code>allure --version</code></li></ol><h3><span id="allure基本用法">Allure基本用法</span></h3><ul><li><code>@allure.epic():</code> 项目名称</li><li><code>@allure.feature():</code> 模块名称，功能点描述</li><li><code>@allure.story():</code> 接口名称</li><li><code>@allure.title():</code> 测试用例标题（适用于一个方法对应一个用例）</li><li><code>allure.dynamic.title:</code> 测试用例标题（适用于一个方法对应多个用例，用于数据驱动情况）</li><li><code>@allure.testcase():</code> 关联测试用例系统里面的用例</li><li><code>@allure.issue():</code> 关联缺陷管理系统里面的链接</li><li><code>@allure.description:</code> 测试用例的描述</li><li><code>@allure.step():</code> 测试用例的步骤</li><li><code>@allure.severity():</code> 用例的等级（block、critical、normal、minor、trivial）</li><li><code>@allure.link():</code> 定义一个链接，在测试报告中展现</li><li><code>@allure.attachment():</code> 为测试报告添加附件</li></ul><h3><span id="allure-epicfeaturestorytitle">Allure epic/feature/story/title</span></h3><ol><li><p>编辑<code>./testcase/alluredemo/test_allure.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> allure</span><br><span class="line"></span><br><span class="line"><span class="meta">@allure.epic(<span class="params"><span class="string">&quot;接口项目名称：xx在线接口测试&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@allure.feature(<span class="params"><span class="string">&quot;接口模块名称：IVR接口&quot;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApi</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @allure.story(<span class="params"><span class="string">&quot;接口名称：常规请求&quot;</span></span>)</span></span><br><span class="line"><span class="meta">    @allure.title(<span class="params"><span class="string">&quot;@allure.title 测试用例1&quot;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_allure_01</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;test_allure_01&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @allure.title(<span class="params"><span class="string">&quot;@allure.title 测试用例2&quot;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_allure_02</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;test_allure_02&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>修改<code>pytest.ini</code>文件中的<code>addopts</code>参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[pytest]</span><br><span class="line"><span class="comment">#--html ./report/report.html，reruns 失败重跑次数</span></span><br><span class="line"><span class="comment"># addopts = -vs -n=2 -reruns 2 --html ./report/report.html</span></span><br><span class="line"><span class="comment"># 生成json格式的allure报告，并删除上一次的报告</span></span><br><span class="line">addopts = -vs --alluredir=reports/temps --clean-alluredir</span><br><span class="line"><span class="comment"># 指定 pytest 搜索测试文件的路径。pytest 将在 ./interfaceCase 目录下搜索可执行文件</span></span><br><span class="line">testpaths =</span><br><span class="line">    ./testcase/alluredemo</span><br><span class="line"><span class="comment"># 指定 pytest 应该匹配的测试文件模式。pytest 将会运行所有以 test_ 为开头的 python 文件</span></span><br><span class="line">python_files = test_*.py</span><br><span class="line"><span class="comment"># 指定 pytest 应该匹配的测试类名模式。pytest 将会运行所有以 Test 开头的类</span></span><br><span class="line">python_classes = Test</span><br><span class="line"><span class="comment"># 指定 pytest 应该匹配的测试函数模式。pytest 将会运行所有以 Test 开头的函数</span></span><br><span class="line">python_functions = test</span><br><span class="line"><span class="comment"># 用于为测试用例添加标记。使用方法: @pytest.mark.smoke  pytest -m &quot;smoke [or usermanage]&quot;</span></span><br><span class="line">markers =</span><br><span class="line">    smoke : Smoke Testing Module</span><br><span class="line">    userManage : User Management Module</span><br><span class="line">    productManage : 商品管理</span><br></pre></td></tr></table></figure></li><li><p><code>main.py</code>文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pytest.main()</span><br><span class="line">    time.sleep(<span class="number">1</span>) <span class="comment"># 生成报告需要一点时间</span></span><br><span class="line">    os.system(<span class="string">&#x27;allure generate ./reports/temps -o ./reports/allures --clean&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li><code>allure generate</code> 固定写法</li><li><code>./reports/temps</code>: 临时的 json 格式报告的路径</li><li><code>-o</code>: 输出 output</li><li><code>./reports/allure</code>: 生成的 allure 报告的路径</li><li><code>--clean</code>: 清空<code>./report</code> 路径原来的报告</li></ul></li><li><p>结果</p><p><img src="./allure1.jpg"></p></li></ol><h3><span id="allure-severitydescription">Allure severity/description</span></h3><ul><li>Blocker</li><li>Critical</li><li>Normal</li><li>Minor</li><li>Trivial</li></ul><p><code>@allure.severity(allure.serverity_level.BLOCKER)</code></p><p><font color="orange">这个装饰器既可以修饰方法，也可以修饰类</font></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> allure</span><br><span class="line"></span><br><span class="line"><span class="meta">@allure.epic(<span class="params"><span class="string">&quot;接口项目名称：xx在线接口测试&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@allure.feature(<span class="params"><span class="string">&quot;接口模块名称：IVR接口&quot;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApi</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @allure.story(<span class="params"><span class="string">&quot;接口名称：常规请求&quot;</span></span>)</span></span><br><span class="line"><span class="meta">    @allure.title(<span class="params"><span class="string">&quot;@allure.title 测试用例1&quot;</span></span>) </span><span class="comment"># 单次的用例标题</span></span><br><span class="line"><span class="meta">    @allure.description(<span class="params"><span class="string">&quot;@allure.description: 测试用例描述&quot;</span></span>) </span><span class="comment"># 单次的用例描述</span></span><br><span class="line"><span class="meta">    @allure.severity(<span class="params">allure.severity_level.BLOCKER</span>) </span><span class="comment"># 单次的用例优先级</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_allure_01</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;test_allure_01&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @allure.title(<span class="params"><span class="string">&quot;@allure.title 测试用例2&quot;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_allure_02</span>(<span class="params">self</span>):</span></span><br><span class="line">        allure.dynamic.title(<span class="string">&quot;allure.dynamic.title&quot;</span>) <span class="comment"># 用于数据驱动的标题</span></span><br><span class="line">        allure.dynamic.description(<span class="string">&quot;allure.dynamic.description&quot;</span>) <span class="comment"># 用于数据驱动的用例描述</span></span><br><span class="line">        allure.dynamic.severity(allure.severity_level.BLOCKER) <span class="comment"># 用于数据驱动的用例优先级</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;test_allure_02&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="./severity.jpg"></p><h3><span id="allure-linkissuetestcase">Allure link/issue/testcase</span></h3><ul><li><code>@allure.description()</code>: 用例描述</li><li><code>@allure.link(url, name=name)</code>: 接口地址</li><li><code>@allure.issue(url, name=name)</code>: BUG链接</li><li><code>@allure.testcase(url, name=name)</code>: 测试用例地址</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> allure</span><br><span class="line"></span><br><span class="line"><span class="meta">@allure.epic(<span class="params"><span class="string">&quot;接口项目名称：xx在线接口测试&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@allure.feature(<span class="params"><span class="string">&quot;接口模块名称：DM接口&quot;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApi</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @allure.story(<span class="params"><span class="string">&quot;接口名称：数据驱动测试&quot;</span></span>)</span></span><br><span class="line"><span class="meta">    @pytest.mark.parametrize(<span class="params"><span class="string">&quot;test_case_title, link&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">                             [[<span class="string">&quot;allure.dynamic.title 测试用例1&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>],</span></span></span><br><span class="line"><span class="params"><span class="meta">                              [<span class="string">&quot;allure.dynamic.title 测试用例2&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>],</span></span></span><br><span class="line"><span class="params"><span class="meta">                              [<span class="string">&quot;allure.dynamic.title 测试用例3&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>]]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_allure_03</span>(<span class="params">self, test_case_title, link, user_fixture</span>):</span></span><br><span class="line">        allure.dynamic.title(test_case_title)</span><br><span class="line">        allure.dynamic.severity(allure.severity_level.BLOCKER)</span><br><span class="line">        allure.dynamic.description(test_case_title)</span><br><span class="line">        allure.dynamic.link(url=link, name=<span class="string">&quot;API URL&quot;</span>)</span><br><span class="line">        <span class="comment"># 测试用例步骤</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">            <span class="keyword">with</span> allure.step(<span class="string">&quot;测试用例步骤&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;&quot;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;步骤&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;执行脚本&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="./description.jpg"></p><h3><span id="使用yaml作为数据驱动">使用YAML作为数据驱动</span></h3><ul><li><code>allure.attach(file_path, name=None, attachment_type=None)</code>: 附件</li></ul><p><code>attachment_type=allure.AttachmentType.TEXT</code>类型：</p><ol><li><strong>TEXT</strong> - 文本内容。用于附加简单的文本信息。</li><li><strong>PNG</strong> - PNG 图片格式。用于附加截图或其他 PNG 图片。</li><li><strong>JPG</strong> - JPG 图片格式。用于附加 JPG 格式的图片。</li><li><strong>GIF</strong> - GIF 图片格式。用于附加 GIF 图片。</li><li><strong>HTML</strong> - HTML 内容。用于附加 HTML 格式的内容，可以在报告中渲染为富文本。</li><li><strong>XML</strong> - XML 格式内容。用于附加 XML 文件或内容。</li><li><strong>JSON</strong> - JSON 格式内容。用于附加 JSON 文件或内容。</li><li><strong>CSV</strong> - CSV 格式内容。用于附加 CSV 文件或内容。</li><li><strong>TXT</strong> - 文本文件。与 TEXT 类似，但更强调是文件形式。</li></ol><p><code>test_allure.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">获取token接口</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">接口描述</span></span><br><span class="line">  <span class="attr">severity:</span> <span class="string">BLOCKER</span></span><br><span class="line">  <span class="attr">request:</span></span><br><span class="line">    <span class="attr">method:</span> <span class="string">get</span></span><br><span class="line">    <span class="attr">url_name:</span> <span class="string">&quot;bing search&quot;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://cn.bing.com/search?/</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">q:</span> <span class="string">&quot;安娜卡列尼娜&quot;</span></span><br><span class="line">  <span class="attr">validate:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">获取token接口</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">接口描述</span></span><br><span class="line">  <span class="attr">severity:</span> <span class="string">CRITICAL</span></span><br><span class="line">  <span class="attr">request:</span></span><br><span class="line">    <span class="attr">method:</span> <span class="string">get</span></span><br><span class="line">    <span class="attr">url_name:</span> <span class="string">&quot;bing search&quot;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://cn.bing.com/search?/</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">q:</span> <span class="string">&quot;平凡的世界&quot;</span></span><br><span class="line">  <span class="attr">validate:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure><p><code>test_allure.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> allure</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YamlUntil</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, yaml_file</span>):</span></span><br><span class="line">        self.yaml_file = yaml_file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_yaml</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.yaml_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = yaml.load(f, Loader=yaml.FullLoader)</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_severity_level</span>(<span class="params">severity_string</span>):</span></span><br><span class="line">    severity_mapping = &#123;</span><br><span class="line">        <span class="string">&quot;BLOCKER&quot;</span>: allure.severity_level.BLOCKER,</span><br><span class="line">        <span class="string">&quot;CRITICAL&quot;</span>: allure.severity_level.CRITICAL,</span><br><span class="line">        <span class="string">&quot;NORMAL&quot;</span>: allure.severity_level.NORMAL,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 通过get获取对应的值，默认为...NORMAL</span></span><br><span class="line">    <span class="keyword">return</span> severity_mapping.get(severity_string, allure.severity_level.NORMAL)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@allure.epic(<span class="params"><span class="string">&quot;接口项目名称：xx在线接口测试&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@allure.feature(<span class="params"><span class="string">&quot;接口模块名称：DM接口&quot;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApi</span>:</span></span><br><span class="line"></span><br><span class="line">    yaml_path = os.getcwd() + <span class="string">&quot;/testcase/alluredemo/test_allure.yaml&quot;</span></span><br><span class="line">    yaml_file = YamlUntil(yaml_path).read_yaml()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @allure.story(<span class="params"><span class="string">&quot;接口名称：数据驱动测试&quot;</span></span>)</span></span><br><span class="line"><span class="meta">    @pytest.mark.parametrize(<span class="params"><span class="string">&quot;caseinfo&quot;</span>, yaml_file</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_allure_03</span>(<span class="params">self, caseinfo, user_fixture</span>):</span></span><br><span class="line">        <span class="comment">#print(caseinfo)</span></span><br><span class="line">        allure.dynamic.title(caseinfo[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">        severity_level = get_severity_level(caseinfo[<span class="string">&quot;severity&quot;</span>])</span><br><span class="line">        <span class="comment">#print(severity_level)</span></span><br><span class="line">        allure.dynamic.severity(severity_level)</span><br><span class="line">        allure.dynamic.description(caseinfo[<span class="string">&quot;description&quot;</span>])</span><br><span class="line">        allure.dynamic.link(url=caseinfo[<span class="string">&quot;request&quot;</span>][<span class="string">&quot;url&quot;</span>], name=caseinfo[<span class="string">&quot;request&quot;</span>][<span class="string">&quot;url_name&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># allure.attach 可以二次封装</span></span><br><span class="line">        allure.attach(body=caseinfo[<span class="string">&quot;request&quot;</span>][<span class="string">&quot;url&quot;</span>], name=<span class="string">&quot;请求地址: &quot;</span>, attachment_type=allure.attachment_type.TEXT)</span><br><span class="line">        allure.attach(body=caseinfo[<span class="string">&quot;request&quot;</span>][<span class="string">&quot;method&quot;</span>], name=<span class="string">&quot;请求方式: &quot;</span>, attachment_type=allure.attachment_type.TEXT)</span><br><span class="line">        data = caseinfo[<span class="string">&quot;request&quot;</span>][<span class="string">&quot;data&quot;</span>]</span><br><span class="line">        allure.attach(body=json.dumps(data), name=<span class="string">&quot;请求数据: &quot;</span>, attachment_type=allure.attachment_type.TEXT)</span><br><span class="line">        res = requests.get(url=caseinfo[<span class="string">&quot;request&quot;</span>][<span class="string">&quot;url&quot;</span>], params=data)</span><br><span class="line">        allure.attach(body=res.text, name=<span class="string">&quot;响应数据&quot;</span>, attachment_type=allure.attachment_type.TEXT)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 测试用例步骤</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">            <span class="keyword">with</span> allure.step(<span class="string">&quot;测试用例步骤&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;&quot;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;步骤&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;执行脚本&quot;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="./attach.jpg"></p><h3><span id="reference">Reference</span></h3><p>[1] <a href="https://allurereport.org/docs/">https://allurereport.org/docs/</a></p><p>[2] <a href="https://zhuanlan.zhihu.com/p/555114726">https://zhuanlan.zhihu.com/p/555114726</a></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Allure报告结构&quot;&gt;&lt;a href=&quot;#Allure报告结构&quot; class=&quot;headerlink&quot; title=&quot;Allure报告结构&quot;&gt;&lt;/a&gt;Allure报告结构&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Overview:整体数据显示。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Suites:用例集合,按照套件和类分组的已执行测试的标准结构表示形式。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Behaviors：对于行为驱动的方法，此选项卡根据Epic、Feature和Story标记对测试结果进行分组。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Categories：“类别”选项卡提供了创建自定义缺陷分类以应用测试结果的方法。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Graphs：用图表显示测试数据中收集的不同统计数据，状态分解或严重性和持续时间图。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Packages：软件包选项卡表示测试结果的树状布局，按不同的包名分组。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Timeline：时间轴选项卡可视化测试执行的回顾，allure适配器收集测试的精确时间，在这个选项卡上，它们相应地按照顺序或并行的时间结构排列。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="自动化测试" scheme="http://example.com/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="pytest" scheme="http://example.com/tags/pytest/"/>
    
  </entry>
  
  <entry>
    <title>关于python-functools</title>
    <link href="http://example.com/2024/03/10/%E5%85%B3%E4%BA%8Epython-functools/"/>
    <id>http://example.com/2024/03/10/%E5%85%B3%E4%BA%8Epython-functools/</id>
    <published>2024-03-10T14:04:04.000Z</published>
    <updated>2024-03-10T15:24:02.195Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><ul><li><a href="#functools.wraps">functools.wraps</a></li><li>functools.lru_cache（待补充）</li><li>functools.total_ordering（待补充）</li><li>functools.total_ordering（待补充）</li><li>functools.singledispatch（待补充）</li><li>functools.partial（待补充）</li><li>functools.partialmethod（待补充）</li><li>functools.reduce（待补充）</li></ul><h3><span id="functoolswraps"><code>functools.wraps</code></span></h3><p><code>functools.wraps</code> 是一个 Python 的装饰器工厂函数，用于更新一个函数对象，将另一个函数对象的元信息（如名称、文档字符串、注解和模块）复制到它上面。这通常用于创建装饰器，以确保被装饰的函数在装饰之后仍然保持其原始的元信息。</p><p>当你创建一个装饰器时，你通常会定义一个接受函数作为参数的函数，并返回一个新的函数对象。这会导致原始函数的元信息（如函数名）丢失，因为返回的是一个全新的函数对象。使用 <code>functools.wraps</code> 可以帮助解决这个问题。</p><span id="more"></span><p>先看一个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">  <span class="string">&quot;print a well-known message&quot;</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">  </span><br><span class="line">hello()</span><br><span class="line">&gt; hello world</span><br><span class="line"></span><br><span class="line">hello.__doc__</span><br><span class="line">&gt; <span class="string">&#x27;print a well-known message&#x27;</span></span><br><span class="line"></span><br><span class="line">hello.__name__</span><br><span class="line">&gt; <span class="string">&#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure><p>接着我们构建一个装饰器并使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">noop</span>(<span class="params">func</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">noop_wrapper</span>():</span></span><br><span class="line">    <span class="string">&quot;this is a decorator&quot;</span></span><br><span class="line">    <span class="keyword">return</span> func()</span><br><span class="line">  <span class="keyword">return</span> noop_wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@noop</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">  <span class="string">&quot;print a well-known message&quot;</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">  </span><br><span class="line">hello()</span><br><span class="line">&gt; hello world</span><br><span class="line"></span><br><span class="line">hello.__doc__</span><br><span class="line">&gt; <span class="string">&#x27;this is a decorator&#x27;</span></span><br><span class="line"></span><br><span class="line">hello.__name__</span><br><span class="line">&gt; <span class="string">&#x27;noop_wrapper&#x27;</span></span><br></pre></td></tr></table></figure><p>可以发现，在套用装饰器的时候，函数的名称和文档都被修改成了装饰器的了</p><p>我们有两种方法可以修改回来，第二种方法就是使用functools</p><h4><span id="方法一对__name__和__doc__重新赋值">方法一：对<code>__name__</code>和<code>__doc__</code>重新赋值</span></h4><p>   对<code>__name__</code>和<code>__doc__</code>重新赋值</p>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">noop</span>(<span class="params">func</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">noop_wrapper</span>():</span></span><br><span class="line">    <span class="string">&quot;this is a decorator&quot;</span></span><br><span class="line">    <span class="keyword">return</span> func()</span><br><span class="line">  noop_wrapper.__name__ = func.__name__</span><br><span class="line">  noop_wrapper.__doc__ = func.__doc__</span><br><span class="line">  <span class="keyword">return</span> noop_wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@noop</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">  <span class="string">&quot;print a well-known message&quot;</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">  </span><br><span class="line">hello()</span><br><span class="line">&gt; hello world</span><br><span class="line"></span><br><span class="line">hello.__doc__</span><br><span class="line">&gt; <span class="string">&#x27;print a well-known message&#x27;</span></span><br><span class="line"></span><br><span class="line">hello.__name__</span><br><span class="line">&gt; <span class="string">&#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure><h4><span id="方法二使用functoolswraps">方法二：使用<code>functools.wraps</code></span></h4><p>   使用<code>functools.wraps</code></p>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">noop</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">  @wraps(<span class="params">func</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">noop_wrapper</span>():</span></span><br><span class="line">    <span class="string">&quot;this is a decorator&quot;</span></span><br><span class="line">    <span class="keyword">return</span> f()</span><br><span class="line">  <span class="keyword">return</span> noop_wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@noop</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">  <span class="string">&quot;print a well-known message&quot;</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">  </span><br><span class="line">hello()</span><br><span class="line">&gt; hello world</span><br><span class="line"></span><br><span class="line">hello.__doc__</span><br><span class="line">&gt; <span class="string">&#x27;print a well-known message&#x27;</span></span><br><span class="line"></span><br><span class="line">hello.__name__</span><br><span class="line">&gt; <span class="string">&#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure><h4><span id="实用性例子">实用性例子</span></h4><p>下面是一个日志模块，其他程序套用日志模块来进行日志输出</p><p>先来看下大致的目录结构</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── logs</span><br><span class="line">│   └── __init__.py</span><br><span class="line">├── testcase</span><br><span class="line">│   ├── __pycache__</span><br><span class="line">│   ├── demo</span><br><span class="line">│       └── test_logger_demo.py</span><br><span class="line">└── utils</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── __pycache__</span><br><span class="line">    └── log_manager.py</span><br></pre></td></tr></table></figure><p><code>log_manager.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> strftime</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerManager</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 移除自带的logger控制台输出，防止重复打印日志信息</span></span><br><span class="line">        logger.remove()</span><br><span class="line">        filename = strftime(<span class="string">&#x27;%Y%m%d-%H%M%S&#x27;</span>)</span><br><span class="line">        <span class="comment"># 如果testcase目录下还有一个目录比如demo，demo里是执行文件，就用../../logs</span></span><br><span class="line">        <span class="comment"># 如果testcase目录下就是test_demo.py 就用../logs/</span></span><br><span class="line">        log_file_path = os.path.join(<span class="string">&#x27;../../logs/&#x27;</span>, filename + <span class="string">&#x27;.log&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(log_file_path)</span><br><span class="line">        log_format = <span class="string">&#x27;&lt;green&gt;&#123;time: YYYY-MM-DD HH:mm:ss.SSS&#125;&lt;/green&gt; &#123;level&#125; &#123;message&#125;&#x27;</span></span><br><span class="line">        level_ = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">        rotation_ = <span class="string">&#x27;5MB&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :enqueue=True 是否使用队列异步地将日志消息写入文件，</span></span><br><span class="line"><span class="string">        日志消息会被排入队列中，然后由后台线程或进程异步地写入文件。</span></span><br><span class="line"><span class="string">        这样可以提高日志记录的性能，避免阻塞主线程。</span></span><br><span class="line"><span class="string">        :backtrace=True 这个参数用于指定是否记录追溯信息</span></span><br><span class="line"><span class="string">        日志中将包含追溯信息，帮助你追踪日志消息的来源</span></span><br><span class="line"><span class="string">        :diagnose=True 这个参数指定是否在日志文件中包含诊断信息，</span></span><br><span class="line"><span class="string">        例如记录日志消息时的函数调用栈等。这对于排查日志问题很有用。</span></span><br><span class="line"><span class="string">        :rotation=rotation_ 这个参数用于指定日志文件的轮转策略</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.logger.add(log_file_path,</span><br><span class="line">                        enqueue=<span class="literal">True</span>,</span><br><span class="line">                        backtrace=<span class="literal">True</span>,</span><br><span class="line">                        diagnose=<span class="literal">True</span>,</span><br><span class="line">                        encoding=<span class="string">&#x27;UTF-8&#x27;</span>,</span><br><span class="line">                        rotation=rotation_)</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        标准错误流 (sys.stderr)： 用于输出错误信息和警告，通常用于指示程序运行中的问题</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.logger.add(sys.stderr,</span><br><span class="line">                        <span class="built_in">format</span>=log_format,</span><br><span class="line">                        enqueue=<span class="literal">True</span>,</span><br><span class="line">                        backtrace=<span class="literal">True</span>,</span><br><span class="line">                        diagnose=<span class="literal">True</span>,</span><br><span class="line">                        colorize=<span class="literal">True</span>,</span><br><span class="line">                        level=level_)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方法的logger装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runtime_logger</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        <span class="comment">#@wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            self.logger.info(<span class="string">f&quot;<span class="subst">&#123;func.__name__&#125;</span> 当前开始执行&quot;</span>)</span><br><span class="line"></span><br><span class="line">            now1 = time.time()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.logger.error(<span class="string">f&quot;<span class="subst">&#123;func.__name__&#125;</span> 当前用例执行失败，失败的原因是: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            now2 = time.time()</span><br><span class="line">            self.logger.success(<span class="string">f&quot;<span class="subst">&#123;func.__name__&#125;</span> 当前执行成功，耗时：<span class="subst">&#123;now2 - now1&#125;</span>ms&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 类的logger装饰器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runtime_logger_class</span>(<span class="params">self, cls</span>):</span></span><br><span class="line">        <span class="keyword">for</span> attr_name <span class="keyword">in</span> <span class="built_in">dir</span>(cls):</span><br><span class="line">            <span class="keyword">if</span> attr_name <span class="keyword">in</span> <span class="built_in">dir</span>(cls):</span><br><span class="line">                <span class="keyword">if</span> attr_name.startswith(<span class="string">&#x27;test_&#x27;</span>) <span class="keyword">and</span> <span class="built_in">callable</span>(<span class="built_in">getattr</span>(cls, attr_name)):</span><br><span class="line">                    <span class="built_in">setattr</span>(cls, attr_name, self.runtime_logger(<span class="built_in">getattr</span>(cls, attr_name)))</span><br><span class="line">        <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my_logger = LoggerManager()</span><br></pre></td></tr></table></figure><p><code>test_logger_demo.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">from</span> utils.log_manager <span class="keyword">import</span> my_logger</span><br><span class="line"></span><br><span class="line"><span class="comment">#@my_logger.runtime_logger_class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestDemo</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @my_logger.runtime_logger</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_01_demo</span>(<span class="params">self</span>):</span></span><br><span class="line">        my_logger.logger.info(<span class="string">&quot;这是一条日志&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pytest.main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果不使用<code>functools.wraps</code>用例的<code>__name__</code>就会被修改成<code>wrapper</code>，这是我们不希望看到的</p><p>修改前：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">========================= 1 passed, 1 warning in 0.03s =========================</span><br><span class="line"> 2024-03-10 23:12:09.733 INFO wrapper 当前开始执行</span><br><span class="line"> 2024-03-10 23:12:09.733 INFO 这是一条日志</span><br><span class="line"> 2024-03-10 23:12:09.733 SUCCESS wrapper 当前执行成功，耗时：0.00012969970703125ms</span><br></pre></td></tr></table></figure><p>修改后：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">========================= 1 passed, 1 warning in 0.03s =========================</span><br><span class="line"> 2024-03-10 23:12:09.733 INFO test_01_demo 当前开始执行</span><br><span class="line"> 2024-03-10 23:12:09.733 INFO 这是一条日志</span><br><span class="line"> 2024-03-10 23:12:09.733 SUCCESS test_01_demo 当前执行成功，耗时：0.00012969970703125ms</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#functools.wraps&quot;&gt;functools.wraps&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;functools.lru_cache（待补充）&lt;/li&gt;
&lt;li&gt;functools.total_ordering（待补充）&lt;/li&gt;
&lt;li&gt;functools.total_ordering（待补充）&lt;/li&gt;
&lt;li&gt;functools.singledispatch（待补充）&lt;/li&gt;
&lt;li&gt;functools.partial（待补充）&lt;/li&gt;
&lt;li&gt;functools.partialmethod（待补充）&lt;/li&gt;
&lt;li&gt;functools.reduce（待补充）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;functools-wraps&quot;&gt;&lt;a href=&quot;#functools-wraps&quot; class=&quot;headerlink&quot; title=&quot;functools.wraps&quot;&gt;&lt;/a&gt;&lt;code&gt;functools.wraps&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;functools.wraps&lt;/code&gt; 是一个 Python 的装饰器工厂函数，用于更新一个函数对象，将另一个函数对象的元信息（如名称、文档字符串、注解和模块）复制到它上面。这通常用于创建装饰器，以确保被装饰的函数在装饰之后仍然保持其原始的元信息。&lt;/p&gt;
&lt;p&gt;当你创建一个装饰器时，你通常会定义一个接受函数作为参数的函数，并返回一个新的函数对象。这会导致原始函数的元信息（如函数名）丢失，因为返回的是一个全新的函数对象。使用 &lt;code&gt;functools.wraps&lt;/code&gt; 可以帮助解决这个问题。&lt;/p&gt;</summary>
    
    
    
    <category term="Python" scheme="http://example.com/categories/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>一些关于docker的shell脚本</title>
    <link href="http://example.com/2024/03/09/%E4%B8%80%E4%BA%9B%E5%85%B3%E4%BA%8Edocker%E7%9A%84shell%E8%84%9A%E6%9C%AC/"/>
    <id>http://example.com/2024/03/09/%E4%B8%80%E4%BA%9B%E5%85%B3%E4%BA%8Edocker%E7%9A%84shell%E8%84%9A%E6%9C%AC/</id>
    <published>2024-03-09T12:16:12.000Z</published>
    <updated>2024-03-09T13:38:50.609Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>这个脚本是不值得单写一篇文章的，但是我怕哪一天脑子一抽就忘了，还是记录一下吧</p><p>反正周末在家闲着没事，也算是终于有时间写写文档和书评了</p><ul><li><a href="#Docker%E5%A4%9A%E5%AE%9E%E4%BE%8B%E4%B8%80%E9%94%AE%E6%8D%A2%E5%8C%85">Docker多实例一键换包</a></li><li><a href="#Docker%E7%9B%91%E6%8E%A7%E5%AE%B9%E5%99%A8%E5%B9%B6%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6">Docker监控容器并输出到文件</a></li></ul><span id="more"></span><h3><span id="docker多实例一键换包">Docker多实例一键换包</span></h3><ol><li><p>先来看一下五个docker实例的目录结构，下方仅展示其中一个实例，其他实例仅存在数字差别</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost audiolistening_arm]<span class="comment"># tree -L 1 ./audio_1/</span></span><br><span class="line">./audio_1/</span><br><span class="line">├── conf</span><br><span class="line">├── docker-audio1.yml</span><br><span class="line">├── logs</span><br><span class="line">└── user_manage_web</span><br><span class="line"></span><br><span class="line">./audio_2/</span><br><span class="line">├── conf</span><br><span class="line">├── docker-audio2.yml</span><br><span class="line">└── logs</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">./audio_5/</span><br><span class="line">├── conf</span><br><span class="line">├── docker-audio5.yml</span><br><span class="line">└── logs</span><br></pre></td></tr></table></figure></li><li><p>接着我们来看下audio_1的yaml文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">audiolistening-container_43_1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;audiolistening_arm:v3_zy_292&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;audiolistening_43_1&quot;</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&quot;3.00&quot;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">4G</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">2G</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&quot;1.00&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf:/usr/local/audiolistening/AudioListening/etc/conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/usr/local/audiolistening/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18941:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19941:9800&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>因为仅是多个实例统一换包，所以我们仅需要更改每个实例yaml文件的第四行，最后的版本号就行了</p><p>下面是通过sed命令做的替换，就不多赘述了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">basePath=/data/voice_bot_4.2/audiolistening_arm</span></span><br><span class="line"></span><br><span class="line">read -p &quot;请输入小程序版本号: &quot; duration</span><br><span class="line"></span><br><span class="line">for i in &#123;1..5&#125;;do</span><br><span class="line"></span><br><span class="line">    lastDuration=`sed -n &quot;4p&quot; ./audio_$&#123;i&#125;/docker-audio$&#123;i&#125;.yml | awk -F &#x27;_&#x27; &#x27;&#123;print $4&#125;&#x27; | awk -F &#x27;&quot;&#x27; &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">    sed -i &quot;4s/$lastDuration/$duration/g&quot; ./audio_$&#123;i&#125;/docker-audio$&#123;i&#125;.yml</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for i in &#123;1..5&#125;; do docker-compose -f &quot;`pwd`/audio_$&#123;i&#125;/docker-audio$&#123;i&#125;.yml&quot; down ;done</span><br><span class="line"></span><br><span class="line">sleep 10s</span><br><span class="line"></span><br><span class="line">for i in &#123;1..5&#125;; do docker-compose -f &quot;`pwd`/audio_$&#123;i&#125;/docker-audio$&#123;i&#125;.yml&quot; up -d ;done</span><br></pre></td></tr></table></figure></li><li><p>结果</p><p><img src="./%E7%BB%93%E6%9E%9C.png"></p></li></ol><h3><span id="docker监控容器并输出到文件">Docker监控容器并输出到文件</span></h3><p>这个脚本是用于监控大批量文件下载的内存开销的，所以打印了时间。当时因为用例少所以就没有使用python做统计。之前的文章有docker的监控与统计，所以这里就不说了</p><p>当然这个脚本有时间还是要写个python文件统计一下的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">now=$(date &quot;+%Y-%m-%d_%H_%M_%S&quot;)</span><br><span class="line"></span><br><span class="line">while true;do printf &quot;\n$(date &quot;+%Y-%m-%d_%H_%M_%S&quot;):\n&quot; | tee --append stats_$now.txt;  docker stats --no-stream audiolistening_42 | tee --append stats_$now.txt; sleep 1; done</span><br></pre></td></tr></table></figure><p><code>tee</code> 命令允许用户在管道中间拆分数据流，一部分输出到屏幕（标准输出），另一部分输出到文件。这样可以在不影响数据流的同时，将数据保存到文件中。</p><p><code>tee</code> 命令被用来将输出同时打印到终端屏幕和一个文件中。通过使用 <code>--append</code> 参数，它会将输出追加到文件的末尾，而不是覆盖文件内容。</p><p><code>docker stats --no-stream</code>命令会获取容器的统计信息，但不会持续输出实时数据流，而是获取一次性的统计信息，然后将其写入文件。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个脚本是不值得单写一篇文章的，但是我怕哪一天脑子一抽就忘了，还是记录一下吧&lt;/p&gt;
&lt;p&gt;反正周末在家闲着没事，也算是终于有时间写写文档和书评了&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#Docker%E5%A4%9A%E5%AE%9E%E4%BE%8B%E4%B8%80%E9%94%AE%E6%8D%A2%E5%8C%85&quot;&gt;Docker多实例一键换包&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#Docker%E7%9B%91%E6%8E%A7%E5%AE%B9%E5%99%A8%E5%B9%B6%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6&quot;&gt;Docker监控容器并输出到文件&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    
    <category term="shell" scheme="http://example.com/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>YAML语法</title>
    <link href="http://example.com/2024/03/06/YAML%E8%AF%AD%E6%B3%95/"/>
    <id>http://example.com/2024/03/06/YAML%E8%AF%AD%E6%B3%95/</id>
    <published>2024-03-06T13:25:26.000Z</published>
    <updated>2024-03-10T11:59:13.810Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>YAML 是 “YAML Ain’t a Markup Language”（YAML 不是一种标记语言）的递归缩写</p><p>YAML 的配置文件后缀为 <strong>.yml</strong>，如：<strong>runoob.yml</strong> 。</p><h4><span id="yaml基本语法">YAML基本语法</span></h4><ul><li><p>大小写敏感</p></li><li><p>使用缩进表示层级关系</p></li><li><p>缩进不允许使用tab，只允许空格</p></li><li><p>缩进的空格数不重要，只要相同层级的元素左对齐即可</p></li><li><p>‘#’表示注释</p></li></ul><span id="more"></span><h4><span id="数据类型">数据类型</span></h4><p>YAML 支持以下几种数据类型：</p><ul><li>对象：键值对的集合</li><li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li><li>纯量（scalars）：单个的、不可再分的值</li></ul><h4><span id="yaml-对象">YAML 对象</span></h4><p>对象键值对使用冒号结构表示 <strong>key: value</strong>，冒号后面要加一个空格。</p><p>也可以使用 **key:{key1: value1, key2: value2, …}**。</p><p>还可以使用缩进表示层级关系；</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> </span><br><span class="line">    <span class="attr">child-key:</span> <span class="string">value</span></span><br><span class="line">    <span class="attr">child-key2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure><p>较为复杂的对象格式，可以使用问号加一个空格代表一个复杂的 key，配合一个冒号加一个空格代表一个 value：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">?</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">complexkey1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">complexkey2</span></span><br><span class="line"><span class="string">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">complexvalue1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">complexvalue2</span></span><br></pre></td></tr></table></figure><p>意思即对象的属性是一个数组 [complexkey1,complexkey2]，对应的值也是一个数组 [complexvalue1,complexvalue2]</p><h4><span id="yaml-数组">YAML 数组</span></h4><p>以 <strong>-</strong> 开头的行表示构成一个数组：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">A</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">B</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">C</span></span><br></pre></td></tr></table></figure><p>YAML 支持多维数组，可以使用行内表示：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> [<span class="string">value1</span>, <span class="string">value2</span>, <span class="string">...</span>]</span><br></pre></td></tr></table></figure><p>数据结构的子成员是一个数组，则可以在该项下面缩进一个空格。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"></span></span><br><span class="line"><span class="ruby"></span> -<span class="ruby"> A</span></span><br><span class="line"><span class="ruby"></span> -<span class="ruby"> B</span></span><br><span class="line"><span class="ruby"></span> -<span class="ruby"> C</span></span><br></pre></td></tr></table></figure><p>一个相对复杂的例子：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">companies:</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">company1</span></span><br><span class="line">        <span class="attr">price:</span> <span class="string">200W</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">company2</span></span><br><span class="line">        <span class="attr">price:</span> <span class="string">500W</span></span><br></pre></td></tr></table></figure><p>意思是 companies 属性是一个数组，每一个数组元素又是由 id、name、price 三个属性构成。</p><p>数组也可以使用流式(flow)的方式表示：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">companies:</span> [&#123;<span class="attr">id:</span> <span class="number">1</span>,<span class="attr">name:</span> <span class="string">company1</span>,<span class="attr">price:</span> <span class="string">200W</span>&#125;,&#123;<span class="attr">id:</span> <span class="number">2</span>,<span class="attr">name:</span> <span class="string">company2</span>,<span class="attr">price:</span> <span class="string">500W</span>&#125;]</span><br></pre></td></tr></table></figure><h4><span id="复合结构">复合结构</span></h4><p>数组和对象可以构成复合结构，例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">languages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ruby</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Perl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Python</span> </span><br><span class="line"><span class="attr">websites:</span></span><br><span class="line">  <span class="attr">YAML:</span> <span class="string">yaml.org</span> </span><br><span class="line">  <span class="attr">Ruby:</span> <span class="string">ruby-lang.org</span> </span><br><span class="line">  <span class="attr">Python:</span> <span class="string">python.org</span> </span><br><span class="line">  <span class="attr">Perl:</span> <span class="string">use.perl.org</span></span><br></pre></td></tr></table></figure><p>转换为 json 为：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="attr">languages:</span> [ <span class="string">&#x27;Ruby&#x27;</span>, <span class="string">&#x27;Perl&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>],</span><br><span class="line">  <span class="attr">websites:</span> &#123;</span><br><span class="line">    <span class="attr">YAML:</span> <span class="string">&#x27;yaml.org&#x27;</span>,</span><br><span class="line">    <span class="attr">Ruby:</span> <span class="string">&#x27;ruby-lang.org&#x27;</span>,</span><br><span class="line">    <span class="attr">Python:</span> <span class="string">&#x27;python.org&#x27;</span>,</span><br><span class="line">    <span class="attr">Perl:</span> <span class="string">&#x27;use.perl.org&#x27;</span> </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="纯量">纯量</span></h4><p>纯量是最基本的，不可再分的值，包括：</p><ul><li>字符串</li><li>布尔值</li><li>整数</li><li>浮点数</li><li>Null</li><li>时间</li><li>日期</li></ul><p>使用一个例子来快速了解纯量的基本使用：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">boolean:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="literal">TRUE</span>  <span class="comment">#true,True都可以</span></span><br><span class="line">    <span class="bullet">-</span> <span class="literal">FALSE</span>  <span class="comment">#false，False都可以</span></span><br><span class="line"><span class="attr">float:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3.14</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">6.8523015e+5</span>  <span class="comment">#可以使用科学计数法</span></span><br><span class="line"><span class="attr">int:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">123</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">0b1010_0111_0100_1010_1110</span>    <span class="comment">#二进制表示</span></span><br><span class="line"><span class="attr">null:</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">parent:</span> <span class="string">~</span>  <span class="comment">#使用~表示null</span></span><br><span class="line"><span class="attr">string:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">哈哈</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;Hello world&#x27;</span>  <span class="comment">#可以使用双引号或者单引号包裹特殊字符</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">newline</span></span><br><span class="line">      <span class="string">newline2</span>    <span class="comment">#字符串可以拆成多行，每一行会被转化成一个空格</span></span><br><span class="line"><span class="attr">date:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2018-02-17</span>    <span class="comment">#日期必须使用ISO 8601格式，即yyyy-MM-dd</span></span><br><span class="line"><span class="attr">datetime:</span> </span><br><span class="line">    <span class="bullet">-</span>  <span class="number">2018-02-17T15:02:31+08:00</span>    <span class="comment">#时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span></span><br></pre></td></tr></table></figure><p>yaml_until.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">msxy:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mengxun</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">age:</span> <span class="number">25</span></span><br></pre></td></tr></table></figure><p>yaml_until.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YamlUtil</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,yaml_file</span>):</span></span><br><span class="line">        self.yaml_file = yaml_file</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取yaml文件</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_yaml</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.yaml_file,encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            value = yaml.load(f,Loader=yaml.FullLoader)</span><br><span class="line">            <span class="built_in">print</span>(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    YamlUtil(<span class="string">&#x27;test_api.yaml&#x27;</span>).read_yaml()</span><br></pre></td></tr></table></figure><h4><span id="reference">Reference</span></h4><p>[1] <a href="https://www.runoob.com/w3cnote/yaml-intro.html">runoob YAML 入门教程</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;YAML 是 “YAML Ain’t a Markup Language”（YAML 不是一种标记语言）的递归缩写&lt;/p&gt;
&lt;p&gt;YAML 的配置文件后缀为 &lt;strong&gt;.yml&lt;/strong&gt;，如：&lt;strong&gt;runoob.yml&lt;/strong&gt; 。&lt;/p&gt;
&lt;h4 id=&quot;YAML基本语法&quot;&gt;&lt;a href=&quot;#YAML基本语法&quot; class=&quot;headerlink&quot; title=&quot;YAML基本语法&quot;&gt;&lt;/a&gt;YAML基本语法&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;大小写敏感&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用缩进表示层级关系&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;缩进不允许使用tab，只允许空格&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;缩进的空格数不重要，只要相同层级的元素左对齐即可&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;‘#’表示注释&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    
    <category term="YAML" scheme="http://example.com/tags/YAML/"/>
    
  </entry>
  
  <entry>
    <title>Kafka集群搭建</title>
    <link href="http://example.com/2024/01/06/Kafka%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>http://example.com/2024/01/06/Kafka%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</id>
    <published>2024-01-06T13:10:42.000Z</published>
    <updated>2024-03-18T09:54:12.114Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h3><span id="目录">目录</span></h3><ul><li><a href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE">环境搭建机器配置</a></li><li><a href="#xsync%E4%B8%8Ersync%E6%96%87%E4%BB%B6%E5%88%86%E5%8F%91">xsync与rsync文件分发</a></li><li><a href="#ZooKeeper%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">ZooKeeper环境搭建</a></li><li><a href="#Kafka%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">Kafka环境搭建</a></li><li><a href="#Hadoop%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">Hadoop环境搭建</a></li></ul><h3><span id="环境搭建机器配置">环境搭建机器配置</span></h3><ol><li><p>3台机器默认都是 java 1.8.0_321</p></li><li><p>3台服务器配置如下：( 练手不需要这么高的配置，我只是刚好有 : )</p><table><thead><tr><th>IP</th><th>OS</th><th>CPU</th><th>MEM</th></tr></thead><tbody><tr><td>192.168.128.93</td><td>CentOS 7.9</td><td>8C/8T Intel(R) Xeon(R) Silver 4110 CPU @ 2.10GHz 虚拟机</td><td>16G</td></tr><tr><td>10.54.0.28</td><td>CentOS 7.9</td><td>32C/64T Intel(R) Xeon(R) Silver 4314 CPU @ 2.40GHz 物理机</td><td>256G</td></tr><tr><td>10.54.0.32</td><td>CentOS 7.9</td><td>32C/64T Intel(R) Xeon(R) Silver 4314 CPU @ 2.40GHz 物理机</td><td>256G</td></tr></tbody></table></li></ol><span id="more"></span><h3><span id="xsync与rsync文件分发">xsync与rsync文件分发</span></h3><h4><span id="rsync-简介">rsync 简介</span></h4><p>rsync 是一个常用的 Linux 应用程序，用于文件同步。</p><p>它可以在本地计算机与远程计算机之间，或者两个本地目录之间同步文件（但不支持两台远程计算机之间的同步）。它也可以当作文件复制工具，替代<code>cp</code>和<code>mv</code>命令。</p><p>它名称里面的<code>r</code>指的是 remote，rsync 其实就是”远程同步”（remote sync）的意思。与其他文件传输工具（如 FTP 或 scp）不同，rsync 的最大特点是会检查发送方和接收方已有的文件，仅传输有变动的部分（默认规则是文件大小或修改时间有变动）。</p><p><em>rsync的基本用法详见 附录 <a href="#1.rsync%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">1.rsync基本用法</a></em></p><h4><span id="rsync-安装">rsync 安装</span></h4><p>在使用 xsync 之前，需要先安装 rsync，因为 xsync 是对 rsync 的二次封装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian</span></span><br><span class="line">$ sudo apt-get install rsync</span><br><span class="line"></span><br><span class="line"><span class="comment"># Red Hat</span></span><br><span class="line">$ sudo yum install rsync</span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch Linux</span></span><br><span class="line">$ sudo pacman -S rsync</span><br></pre></td></tr></table></figure><h4><span id="xsync-简介">xsync 简介</span></h4><p>在集群机器配置时，经常需要将一个文件或目录copy到同样的多台集群上，如果一个一个机器去复制，比较麻烦。如果有一个办法，通过一条命令就可以实现这个目的，就简单多了。xsync就是这样一个同步脚本。xsync其实是对<a href="https://so.csdn.net/so/search?q=rsync&spm=1001.2101.3001.7020">rsync</a>脚本的二次封装，脚本内容可以根据自己需要进行修改。</p><h4><span id="xsync-基本使用">xsync 基本使用</span></h4><ol><li><p>配置集群 hostname</p><p><strong>1.1 修改主机名称，配置 hostname 文件</strong></p><p><strong>我们需要将这3台机器依次修改服务器名称</strong></p><p>方法1：（需要 reboot 重启）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> hostname1 &gt; /etc/hostname</span><br></pre></td></tr></table></figure><p>方法2：（ reboot 重启后会失效）个人使用的是方法2，因为懒。但推荐永久修改方案</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改192.168.128.93</span></span><br><span class="line">[root@kafka93 data]<span class="comment"># hostnamectl hostname kafka93</span></span><br><span class="line">[root@kafka93 data]<span class="comment"># bash</span></span><br><span class="line"><span class="comment"># 修改10.54.0.28</span></span><br><span class="line">[root@kafka28 data]<span class="comment"># hostnamectl hostname kafka28</span></span><br><span class="line">[root@kafka28 data]<span class="comment"># bash</span></span><br><span class="line"><span class="comment"># 修改10.54.0.32</span></span><br><span class="line">[root@kafka29 data]<span class="comment"># hostnamectl hostname kafka29</span></span><br><span class="line">[root@kafka29 data]<span class="comment"># bash</span></span><br></pre></td></tr></table></figure><p><strong>1.2 配置 hosts 文件</strong></p><p>修改完 hostname后，将集群名称写入到 192.168.128.93 /etc/hosts 文件中（我将使用93这台机器做文件分发），以后登录不同机器，直接使用 hostname 而不用 IP。</p><p><code>vim /etc/hosts</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.128.93 kafka93</span><br><span class="line">10.54.0.28 kafka28</span><br><span class="line">10.54.0.32 kafka29</span><br></pre></td></tr></table></figure></li><li><p>配置免密登录</p><p><strong>2.1 生成 rsa 密钥</strong></p><p>使用命令<code>ssh-keygen</code> 生成rsa密钥，配置信息直接回车即可, 生成的密钥默认在当前用户主目录的.ssh目录下</p><p>密钥文件有两个：</p><ul><li>id_rsa 存放着私钥</li><li>id_rsa.pub 存放着公钥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka28 ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:kXclvgbcNBCbW9Z88eP1brP1TtPOc+YAuWTw0xi4QrU root@zkos1</span><br><span class="line">The key’s randomart image is:</span><br><span class="line">±–[RSA 2048]----+</span><br><span class="line">| +o+ … |</span><br><span class="line">| + O * o|</span><br><span class="line">| + E B o.+|</span><br><span class="line">| . o X …+|</span><br><span class="line">| S o @ …|</span><br><span class="line">| . + + …|</span><br><span class="line">| . .o|</span><br><span class="line">| BO|</span><br><span class="line">| =O|</span><br><span class="line">±—[SHA256]-----+</span><br></pre></td></tr></table></figure><p><strong>2.2 copy 机器自身公钥到目标机器</strong></p><p>在本地先将<code>id_rsa_pub</code> 一份名为 <code>authorized_keys</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp id_rsa.pub authorized_keys</span><br></pre></td></tr></table></figure><p>使用rsync 命令同步到对方目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rsync authorized_keys root@kafka28:/root/.ssh/</span><br><span class="line">rsync authorized_keys root@kafka29:/root/.ssh/</span><br></pre></td></tr></table></figure><p>备注：该方法需要本地暂时没有<code>authorized_keys</code>，有的话先改名也可以，并且本地机器安装有rsync脚本。操作完记得删除本地的<code>authorized_keys</code>。</p></li><li><p>xsync 脚本使用</p><p><strong>3.1 xsync 是对 rsync 脚本的二次封装，所以需要先下载rsync命令</strong></p><blockquote><p>yum install -y rsync</p></blockquote><p><strong>3.2 添加 xsync 脚本</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取输入参数个数，如果没有参数，直接退出</span></span><br><span class="line">pcount=$#</span><br><span class="line">if((pcount!=4)); then</span><br><span class="line">    echo Usage: $0 filename servername startno endno</span><br><span class="line">    exit;</span><br><span class="line">fi</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取文件名称</span></span><br><span class="line">p1=$1</span><br><span class="line">fname=`basename $p1`</span><br><span class="line">echo fname=$fname</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取上级目录到绝对路径</span></span><br><span class="line">pdir=`cd -P $(dirname $p1); pwd`</span><br><span class="line">echo pdir=$pdir</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取当前用户名称</span></span><br><span class="line">user=`whoami`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取hostname及起止号</span></span><br><span class="line">slave=$2</span><br><span class="line">startline=$3</span><br><span class="line">endline=$4</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 循环</span></span><br><span class="line">for((host=$startline; host&lt;=$endline; host++)); do</span><br><span class="line">    echo $pdir/$fname $user@$slave$host:$pdir</span><br><span class="line">    echo ==================$slave$host==================</span><br><span class="line">    rsync -rvl $pdir/$fname $user@$slave$host:$pdir</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>该脚本经过修改，需要携带4个参数，分别是</p><ul><li><p>filename 待发送的文件或目录名</p></li><li><p>servername 服务器前缀名</p></li><li><p>startno 服务器编号起始编号</p></li><li><p>endno 服务器编号终止编号</p></li></ul><p><strong>3.3 将 xsync 设置执行权限并加入环境变量</strong></p><p>i. 将脚本复制到系统的可执行目录下。</p><p>首先，找到系统的可执行目录之一，例如 <code>/usr/local/bin</code>、<code>/usr/bin</code> 或 <code>~/bin</code> （如果不存在可以创建）。然后将你的脚本复制到这个目录下。这个目录通常在系统的环境变量 <code>PATH</code> 中，这样系统就可以在这些目录下找到可执行文件。</p><blockquote><p>cp ./xsync /bin/</p></blockquote><p>ii. 赋予执行权限</p><blockquote><p>chmod +x /bin/xsync</p></blockquote><p>iii. 添加到 PATH 环境变量</p><p>你可以通过修改 <code>~/.bashrc</code>（或 <code>~/.bash_profile</code>、<code>~/.zshrc</code> 等，具体文件根据你的 shell 而定）文件来永久性地添加路径。打开这个文件并在其中添加一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /root/.bashrc</span><br><span class="line"><span class="comment"># 在最后一行添加该命令</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PATH</span>:/bin/xsync&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存并退出 .bashrc 文件后，更新环境变量</span></span><br><span class="line"><span class="built_in">source</span> /root/.bashrc</span><br></pre></td></tr></table></figure><p><strong>3.4 测试</strong></p><p>将 1.txt 文件同步到 hostname 是 kafka 的主机，编号是 28 到 29。同步的路径为该文件的所在路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个文件 1.txt</span></span><br><span class="line">[root@kafka93 data]<span class="comment"># touch 1.txt</span></span><br><span class="line"><span class="comment"># 将 1.txt 文件同步到 hostname 是 kafka 的主机，编号是 28 到 29。同步的路径为该文件的所在路径</span></span><br><span class="line">[root@kafka93 data]<span class="comment"># xsync 1.txt kafka 28 29</span></span><br><span class="line">fname=1.txt</span><br><span class="line">pdir=/data</span><br><span class="line">/data/1.txt root@kafka28:/data</span><br><span class="line">==================kafka28==================</span><br><span class="line">sending incremental file list</span><br><span class="line">1.txt</span><br><span class="line"></span><br><span class="line">sent 85 bytes  received 35 bytes  240.00 bytes/sec</span><br><span class="line">total size is 0  speedup is 0.00</span><br><span class="line">/data/1.txt root@kafka29:/data</span><br><span class="line">==================kafka29==================</span><br><span class="line"></span><br><span class="line">Authorized users only. All activities may be monitored and reported.</span><br><span class="line">sending incremental file list</span><br><span class="line">1.txt</span><br><span class="line"></span><br><span class="line">sent 85 bytes  received 35 bytes  240.00 bytes/sec</span><br><span class="line">total size is 0  speedup is 0.00</span><br></pre></td></tr></table></figure></li></ol><h3><span id="zookeeper环境搭建">ZooKeeper环境搭建</span></h3><h4><span id="zookeeper-简介">ZooKeeper 简介</span></h4><p>顾名思义 zookeeper 就是动物园管理员，他是用来管 hadoop（大象）、Hive(蜜蜂)、pig(小 猪)的管理员， Apache Hbase 和 Apache Solr 的分布式集群都用到了 zookeeper；Zookeeper: 是一个分布式的、开源的程序协调服务，是 hadoop 项目下的一个子项目。他提供的主要功能包括：配置管理、名字服务、分布式锁、集群管理。</p><h4><span id="zookeeper-作用">ZooKeeper 作用</span></h4><p>1.1 配置管理</p><p>在我们的应用中除了代码外，还有一些就是各种配置。比如数据库连接等。一般我们都 是使用配置文件的方式，在代码中引入这些配置文件。当我们只有一种配置，只有一台服务 器，并且不经常修改的时候，使用配置文件是一个很好的做法，但是如果我们配置非常多， 有很多服务器都需要这个配置，这时使用配置文件就不是个好主意了。这个时候往往需要寻 找一种集中管理配置的方法，我们在这个集中的地方修改了配置，所有对这个配置感兴趣的 都可以获得变更。Zookeeper 就是这种服务，它使用 Zab 这种一致性协议来提供一致性。现 在有很多开源项目使用 Zookeeper 来维护配置，比如在 HBase 中，客户端就是连接一个 Zookeeper，获得必要的 HBase 集群的配置信息，然后才可以进一步操作。还有在开源的消 息队列 Kafka 中，也使用 Zookeeper来维护broker的信息。在 Alibaba开源的 SOA 框架Dubbo 中也广泛的使用 Zookeeper 管理一些配置来实现服务治理。</p><p>1.2 名字服务</p><p>名字服务这个就很好理解了。比如为了通过网络访问一个系统，我们得知道对方的 IP 地址，但是 IP 地址对人非常不友好，这个时候我们就需要使用域名来访问。但是计算机是 不能是域名的。怎么办呢？如果我们每台机器里都备有一份域名到 IP 地址的映射，这个倒 是能解决一部分问题，但是如果域名对应的 IP 发生变化了又该怎么办呢？于是我们有了 DNS 这个东西。我们只需要访问一个大家熟知的(known)的点，它就会告诉你这个域名对应 的 IP 是什么。在我们的应用中也会存在很多这类问题，特别是在我们的服务特别多的时候， 如果我们在本地保存服务的地址的时候将非常不方便，但是如果我们只需要访问一个大家都 熟知的访问点，这里提供统一的入口，那么维护起来将方便得多了。</p><p>1.3 分布式锁</p><p>其实在第一篇文章中已经介绍了 Zookeeper 是一个分布式协调服务。这样我们就可以利 用 Zookeeper 来协调多个分布式进程之间的活动。比如在一个分布式环境中，为了提高可靠 性，我们的集群的每台服务器上都部署着同样的服务。但是，一件事情如果集群中的每个服 务器都进行的话，那相互之间就要协调，编程起来将非常复杂。而如果我们只让一个服务进 行操作，那又存在单点。通常还有一种做法就是使用分布式锁，在某个时刻只让一个服务去</p><p>干活，当这台服务出问题的时候锁释放，立即 fail over 到另外的服务。这在很多分布式系统 中都是这么做，这种设计有一个更好听的名字叫 Leader Election(leader 选举)。比如 HBase 的 Master 就是采用这种机制。但要注意的是分布式锁跟同一个进程的锁还是有区别的，所 以使用的时候要比同一个进程里的锁更谨慎的使用。</p><p>1.4 集群管理</p><p>在分布式的集群中，经常会由于各种原因，比如硬件故障，软件故障，网络问题，有些 节点会进进出出。有新的节点加入进来，也有老的节点退出集群。这个时候，集群中其他机 器需要感知到这种变化，然后根据这种变化做出对应的决策。比如我们是一个分布式存储系 统，有一个中央控制节点负责存储的分配，当有新的存储进来的时候我们要根据现在集群目 前的状态来分配存储节点。这个时候我们就需要动态感知到集群目前的状态。还有，比如一 个分布式的 SOA 架构中，服务是一个集群提供的，当消费者访问某个服务时，就需要采用 某种机制发现现在有哪些节点可以提供该服务(这也称之为服务发现，比如 Alibaba 开源的 SOA 框架 Dubbo 就采用了 Zookeeper 作为服务发现的底层机制)。还有开源的 Kafka 队列就 采用了 Zookeeper 作为 Cosnumer 的上下线管理。</p><h4><span id="zookeeper-目录结构">ZooKeeper 目录结构</span></h4><ol><li>bin：放置运行脚本和工具脚本，如果是 Linux 环境还会有有 zookeeper 的运 行日志 zookeeper.out</li><li>conf：zookeeper 默认读取配置的目录，里面会有默认的配置文件</li><li>contrib：zookeeper 的拓展功能</li><li>dist-maven：zookeeper的 maven 打包目录</li><li>docs：zookeeper 相关的文档</li><li>lib：zookeeper 核心的 jar</li><li>recipes：zookeeper 分布式相关的 jar 包</li><li>src：zookeeper 源码</li></ol><h4><span id="修改-zookeeper-配置文件单机版">修改 ZooKeeper 配置文件(单机版)</span></h4><p><code>cd /data/apache-zookeeper-3.7.2/conf</code></p><p>复制一个 zoo_sample.cfg 重命名为 zoo.cfg</p><p><code>cp zoo_sample.cfg ./zoo.cfg</code></p><p>zookeeper 默认会读 zoo.cfg 的配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> zookeeper集群互相通信的心跳时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 10个心跳时间,节点之间用于数据同步的周期时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that the initial</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收请求和获取响应的5个周期</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that can pass between</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper数据保存目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> example sakes.</span></span><br><span class="line">dataDir=/data/apache-zookeeper-3.7.2/data</span><br><span class="line"><span class="meta">#</span><span class="bash"> the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zookeeper端口</span></span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure><h4><span id="zookeeper-命令">ZooKeeper 命令</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 zookeeper</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># cd /data/apache-zookeeper-3.7.2/bin</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># ./zkServer.sh start</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /data/apache-zookeeper-3.7.2/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 zookeeper 状态</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># ./zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /data/apache-zookeeper-3.7.2/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: standalone</span><br><span class="line"></span><br><span class="line">standalone 说明启动的是单机版的 zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 zookeeper</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># ./zkServer.sh stop</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /data/apache-zookeeper-3.7.2/bin/../conf/zoo.cfg</span><br><span class="line">Stopping zookeeper ... STOPPED</span><br></pre></td></tr></table></figure><h4><span id="修改-zookeeper-配置文件集群版">修改 ZooKeeper 配置文件(集群版)</span></h4><p>修改 zookeeper conf/zoo.cfg</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zookeeper集群互相通信的心跳时间</span></span><br><span class="line"><span class="comment"># The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># 10个心跳时间,节点之间用于数据同步的周期时间</span></span><br><span class="line"><span class="comment"># The number of ticks that the initial </span></span><br><span class="line"><span class="comment"># synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="comment"># 接收请求和获取响应的5个周期</span></span><br><span class="line"><span class="comment"># The number of ticks that can pass between </span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="comment"># zookeeper数据保存目录</span></span><br><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just </span></span><br><span class="line"><span class="comment"># example sakes.</span></span><br><span class="line">dataDir=/data/apache-zookeeper-3.7.2/data</span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment"># the maximum number of client connections.</span></span><br><span class="line"><span class="comment"># increase this if you need to handle more clients</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Be sure to read the maintenance section of the </span></span><br><span class="line"><span class="comment"># administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The number of snapshots to retain in dataDir</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"># Purge task interval in hours</span></span><br><span class="line"><span class="comment"># Set to &quot;0&quot; to disable auto purge feature</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Metrics Providers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://prometheus.io Metrics Exporter</span></span><br><span class="line"><span class="comment">#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span></span><br><span class="line"><span class="comment">#metricsProvider.httpPort=7000</span></span><br><span class="line"><span class="comment">#metricsProvider.exportJvmInfo=true</span></span><br><span class="line"><span class="comment"># 选举端口2888,投票端口3888</span></span><br><span class="line">server.1=kafka93:2888:3888</span><br><span class="line">server.2=kafka28:2888:3888</span><br><span class="line">server.3=kafka29:2888:3888</span><br></pre></td></tr></table></figure><p>为创建的 <code>/data/apache-zookeeper-3.7.2/data</code> 添加 <code>myid</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/apache-zookeeper-3.7.2/data</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; myid</span><br></pre></td></tr></table></figure><p>将 zookeeper 分发至另外两台服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data</span><br><span class="line">xsync apache-zookeeper-3.7.2 kafka 28 29</span><br></pre></td></tr></table></figure><p><strong>接着修改另外两台机器的 myid，分别为2、3</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在kafka28上，即10.54.0.28机器上修改 /data/apache-zookeeper-3.7.2/data 的 myid</span></span><br><span class="line"><span class="built_in">echo</span> 2 &gt; myid</span><br><span class="line"><span class="comment"># 在kafka29上，即10.54.0.32机器上修改 /data/apache-zookeeper-3.7.2/data 的 myid</span></span><br><span class="line"><span class="built_in">echo</span> 3 &gt; myid</span><br></pre></td></tr></table></figure><p>分别启动三台机器的 zookeeper</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kafka93, 192.168.128.93</span></span><br><span class="line">[root@kafka93 apache-zookeeper-3.7.2]<span class="comment"># cd /data/apache-zookeeper-3.7.2/bin</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># ./zkServer.sh start</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># jps</span></span><br><span class="line">2163 QuorumPeerMain</span><br><span class="line">2216 Jps</span><br><span class="line">[root@kafka93 bin]<span class="comment"># ./zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /data/apache-zookeeper-3.7.2/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower（从）</span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka28, 10.54.0.28</span></span><br><span class="line">[root@kafka28 apache-zookeeper-3.7.2]<span class="comment"># cd /data/apache-zookeeper-3.7.2/bin</span></span><br><span class="line">[root@kafka28 bin]<span class="comment"># ./zkServer.sh start</span></span><br><span class="line">[root@kafka28 bin]<span class="comment"># jps</span></span><br><span class="line">6550 Jps</span><br><span class="line">919 QuorumPeerMain</span><br><span class="line">2221 Bootstrap</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br><span class="line">[root@kafka28 bin]<span class="comment"># ./zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /data/apache-zookeeper-3.7.2/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader (主，自动选举) </span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka29, 10.54.0.32</span></span><br><span class="line">[root@kafka29 apache-zookeeper-3.7.2]<span class="comment"># cd /data/apache-zookeeper-3.7.2/bin</span></span><br><span class="line">[root@kafka29 bin]<span class="comment"># ./zkServer.sh start</span></span><br><span class="line">[root@kafka29 bin]<span class="comment"># ./zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /data/apache-zookeeper-3.7.2/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><h3><span id="kafka环境搭建">Kafka环境搭建</span></h3><h4><span id="kafka-简介">kafka 简介</span></h4><p>Kafka 是一种分布式的，基于发布 / 订阅的消息系统。主要设计目标如下：</p><ul><li>以时间复杂度为 O(1) 的方式提供消息持久化能力，即使对 TB 级以上数据也能保证常数时间复杂度的访问性能。</li><li>高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒 100K 条以上消息的传输。</li><li>支持 Kafka Server 间的消息分区，及分布式消费，同时保证每个 Partition 内的消息顺序传输。</li><li>同时支持离线数据处理和实时数据处理。</li><li>Scale out：支持在线水平扩展。</li></ul><h4><span id="kafka-概念">kafka 概念</span></h4><p><strong>概念一：生产者与消费者</strong></p><p><img src="%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85.png" alt="生产者与消费者.png"></p><p>对于 Kafka 来说客户端有两种基本类型：<strong>生产者（Producer）</strong>和<strong>消费者（Consumer）</strong>。除此之外，还有用来做数据集成的 Kafka Connect API 和流式处理的 Kafka Streams 等高阶客户端，但这些高阶客户端底层仍然是生产者和消费者API，它们只不过是在上层做了封装。</p><p>这很容易理解，生产者（也称为发布者）创建消息，而消费者（也称为订阅者）负责消费or读取消息。</p><p><strong>概念二：主题（Topic）与分区（Partition）</strong></p><p><img src="%E4%B8%BB%E9%A2%98%E4%B8%8E%E5%88%86%E5%8C%BA.png" alt="主题与分区.png"></p><p>在 Kafka 中，消息以<strong>主题（Topic）</strong>来分类，每一个主题都对应一个「消息队列」，这有点儿类似于数据库中的表。但是如果我们把所有同类的消息都塞入到一个“中心”队列中，势必缺少可伸缩性，无论是生产者/消费者数目的增加，还是消息数量的增加，都可能耗尽系统的性能或存储。</p><p>我们使用一个生活中的例子来说明：现在 A 城市生产的某商品需要运输到 B 城市，走的是公路，那么单通道的高速公路不论是在「A 城市商品增多」还是「现在 C 城市也要往 B 城市运输东西」这样的情况下都会出现「吞吐量不足」的问题。所以我们现在引入<strong>分区（Partition）</strong>的概念，类似“允许多修几条道”的方式对我们的主题完成了水平扩展。</p><p><strong>概念三：Broker 和集群（Cluster）</strong></p><p>一个 Kafka 服务器也称为 Broker，它接受生产者发送的消息并存入磁盘；Broker 同时服务消费者拉取分区消息的请求，返回目前已经提交的消息。使用特定的机器硬件，一个 Broker 每秒可以处理成千上万的分区和百万量级的消息。（现在动不动就百万量级..我特地去查了一把，好像确实集群的情况下吞吐量挺高的..摁..）</p><p>若干个 Broker 组成一个集群（Cluster），其中集群内某个 Broker 会成为集群控制器（Cluster Controller），它负责管理集群，包括分配分区到 Broker、监控 Broker 故障等。在集群内，一个分区由一个 Broker 负责，这个 Broker 也称为这个分区的 Leader；当然一个分区可以被复制到多个 Broker 上来实现冗余，这样当存在 Broker 故障时可以将其分区重新分配到其他 Broker 来负责。下图是一个样例：</p><p><img src="broker%E5%92%8C%E9%9B%86%E7%BE%A4.png"></p><p>Kafka 的一个关键性质是日志保留（retention），我们可以配置主题的消息保留策略，譬如只保留一段时间的日志或者只保留特定大小的日志。当超过这些限制时，老的消息会被删除。我们也可以针对某个主题单独设置消息过期策略，这样对于不同应用可以实现个性化。</p><p><strong>概念四：多集群</strong></p><p>随着业务发展，我们往往需要多集群，通常处于下面几个原因：</p><ul><li>基于数据的隔离；</li><li>基于安全的隔离；</li><li>多数据中心（容灾）</li></ul><p>当构建多个数据中心时，往往需要实现消息互通。举个例子，假如用户修改了个人资料，那么后续的请求无论被哪个数据中心处理，这个更新需要反映出来。又或者，多个数据中心的数据需要汇总到一个总控中心来做数据分析。</p><p>上面说的分区复制冗余机制只适用于同一个 Kafka 集群内部，对于多个 Kafka 集群消息同步可以使用 Kafka 提供的 MirrorMaker 工具。本质上来说，MirrorMaker 只是一个 Kafka 消费者和生产者，并使用一个队列连接起来而已。它从一个集群中消费消息，然后往另一个集群生产消息。</p><h4><span id="kakfa-集群环境搭建">kakfa 集群环境搭建</span></h4><p><strong><font color="red">注：三台机器记得关闭防火墙</font></strong></p><p>kafka 下载地址：<a href="https://kafka.apache.org/downloads">https://kafka.apache.org/downloads</a></p><p><img src="kafka-bin%E7%9B%AE%E5%BD%95.png" alt="kafka bin目录.png"></p><p><img src="kafka-config%E7%9B%AE%E5%BD%95.png" alt="kafka config目录.png"></p><ol><li><p>修改192.168.128.93机器 Kafka <code>server.properties</code> 配置\</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kafka 集群唯一标识，不能重复。10.54.0.28 和 10.54.0.32 两台机器此处分别改成 1 和 2</span></span><br><span class="line"><span class="meta">broker.id</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># kafka 暴漏的IP:POST。10.54.0.28 和 10.54.0.32 两台机器此处分别改成 PLAINTEXT://10.54.0.28:9092 和 PLAINTEXT://10.54.0.32:9092</span></span><br><span class="line"><span class="meta">advertised.listeners</span>=<span class="string">PLAINTEXT://192.168.128.93:9092</span></span><br><span class="line"><span class="comment"># 修改kafka存储数据的路径，默认放在/tmp目录会被定时清理</span></span><br><span class="line"><span class="meta">log.dirs</span>=<span class="string">/opt/kafka/datas</span></span><br><span class="line"><span class="comment"># 修改默认的本地连接，改为集群。在集群后面加/kafka，在根目录下创建kafka文件夹存储数据，而非直接把所有数据全部存储在根目录下，利于后续管理</span></span><br><span class="line"><span class="meta">zookeeper.connect</span>=<span class="string">kafka93:2181,kafka28:2181,kafka29:2181/kafka</span></span><br></pre></td></tr></table></figure></li><li><p>分发kafka到其他两台机器上，并按步骤1修改28、29两台机器的 kafka server.properties</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka93 data]<span class="comment"># xsync kafka_2.12-3.0.0 kafka 28 29</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka28</span></span><br><span class="line">[root@kafka28 ~]<span class="comment"># vim /data/kafka_2.12-3.0.0/config/server.properties</span></span><br><span class="line"><span class="comment"># kafka 集群唯一标识，不能重复。10.54.0.28 和 10.54.0.32 两台机器此处分别改成 1 和 2</span></span><br><span class="line">broker.id=1</span><br><span class="line"><span class="comment"># kafka 暴漏的IP:POST。10.54.0.28 和 10.54.0.32 两台机器此处分别改成 PLAINTEXT://10.54.0.28:9092 和 PLAINTEXT://10.54.0.32:9092</span></span><br><span class="line">advertised.listeners=PLAINTEXT://10.54.0.28:9092</span><br><span class="line"><span class="comment"># 修改kafka存储数据的路径，默认放在/tmp目录会被定时清理</span></span><br><span class="line">log.dirs=/opt/kafka/datas</span><br><span class="line"><span class="comment"># 修改默认的本地连接，改为集群。在集群后面加/kafka，在根目录下创建kafka文件夹存储数据，而非直接把所有数据全部存储在根目录下，利于后续管理</span></span><br><span class="line">zookeeper.connect=kafka93:2181,kafka28:2181,kafka29:2181/kafka</span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka29</span></span><br><span class="line">[root@kafka29 ~]<span class="comment"># vim /data/kafka_2.12-3.0.0/config/server.properties</span></span><br><span class="line"><span class="comment"># kafka 集群唯一标识，不能重复。10.54.0.28 和 10.54.0.32 两台机器此处分别改成 1 和 2</span></span><br><span class="line">broker.id=1</span><br><span class="line"><span class="comment"># kafka 暴漏的IP:POST。10.54.0.28 和 10.54.0.32 两台机器此处分别改成 PLAINTEXT://10.54.0.28:9092 和 PLAINTEXT://10.54.0.32:9092</span></span><br><span class="line">advertised.listeners=PLAINTEXT://10.54.0.32:9092</span><br><span class="line"><span class="comment"># 修改kafka存储数据的路径，默认放在/tmp目录会被定时清理</span></span><br><span class="line">log.dirs=/opt/kafka/datas</span><br><span class="line"><span class="comment"># 修改默认的本地连接，改为集群。在集群后面加/kafka，在根目录下创建kafka文件夹存储数据，而非直接把所有数据全部存储在根目录下，利于后续管理</span></span><br><span class="line">zookeeper.connect=kafka93:2181,kafka28:2181,kafka29:2181/kafka</span><br></pre></td></tr></table></figure></li><li><p>修改kafka运行内存(可跳过)</p><p>在执行大并发的时候，可以适当的修改运行的内存（当然是在你机器内存条件允许的情况下）</p><p><img src="./xmx.jpg"></p></li><li><p>启动 kafka 集群，并查看启动状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka93 kafka_2.12-3.0.0]<span class="comment"># ./bin/kafka-server-start.sh -daemon ./config/server.properties</span></span><br><span class="line">[root@kafka93 kafka_2.12-3.0.0]<span class="comment"># jps</span></span><br><span class="line">2163 QuorumPeerMain</span><br><span class="line">30692 Jps</span><br><span class="line">26348 Kafka</span><br><span class="line"></span><br><span class="line">[root@kafka28 kafka_2.12-3.0.0]<span class="comment"># ./bin/kafka-server-start.sh -daemon ./config/server.properties</span></span><br><span class="line">[root@kafka28 kafka_2.12-3.0.0]<span class="comment"># jps</span></span><br><span class="line">7488 Kafka</span><br><span class="line">41990 Jps</span><br><span class="line">919 QuorumPeerMain</span><br><span class="line">2221 Bootstrap</span><br><span class="line"></span><br><span class="line">[root@kafka29 kafka_2.12-3.0.0]<span class="comment"># ./bin/kafka-server-start.sh -daemon ./config/server.properties</span></span><br><span class="line">[root@kafka29 ~]<span class="comment"># jps</span></span><br><span class="line">259024 QuorumPeerMain</span><br><span class="line">265692 Kafka</span><br><span class="line">271389 Jps</span><br></pre></td></tr></table></figure></li></ol><h4><span id="创建-topic-目录">创建 topic 目录</span></h4><p>创建 topic 目录命令为：<code>bin/kafka-topics.sh --create --topic my_topic --bootstrap-server localhost:9092 --replication-factor 1 --partitions 3</code></p><p>查看 topic 目录命令为：<code>bin/kafka-topics.sh --list --bootstrap-server kafka93:9092</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka93 /]<span class="comment"># cd /data/kafka_2.12-3.0.0/</span></span><br><span class="line"></span><br><span class="line">[root@kafka93 kafka_2.12-3.0.0]<span class="comment"># ./kafka-topics.sh --create --topic audiolistening_push --bootstrap-server kafka93:9092 --replication-factor 1 --partitions 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 kafka93 机器的 topic 目录</span></span><br><span class="line">[root@kafka93 bin]<span class="comment"># ./kafka-topics.sh --list --bootstrap-server kafka93:9092</span></span><br><span class="line">audiolistening_push</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看其他机器的 topic 目录</span></span><br><span class="line">[root@kafka28 bin]<span class="comment"># ./kafka-topics.sh --list --bootstrap-server kafka28:9092</span></span><br><span class="line">audiolistening_push</span><br><span class="line">[root@kafka29 bin]<span class="comment"># ./kafka-topics.sh --list --bootstrap-server kafka29:9092</span></span><br><span class="line">audiolistening_push</span><br></pre></td></tr></table></figure><ul><li><p>kafka93:9092，写成 192.168.128.93:9092 也是一样的</p></li><li><p>集群中一个创建了 topic 目录，其他集群也就都有了该 topic</p></li></ul><h3><span id="附录">附录</span></h3><h4><span id="1rsync基本用法">1.rsync基本用法</span></h4><p>目前没有使用到，先贴一个地址吧…</p><p><a href="https://www.ruanyifeng.com/blog/2020/08/rsync.html">https://www.ruanyifeng.com/blog/2020/08/rsync.html</a></p><blockquote><p>rsync 引用：<a href="https://www.ruanyifeng.com/blog/2020/08/rsync.html">https://www.ruanyifeng.com/blog/2020/08/rsync.html</a></p><p>xsync 引用：<a href="https://blog.csdn.net/nalw2012/article/details/98322637">https://blog.csdn.net/nalw2012/article/details/98322637</a></p><p>ZooKeeper 简介、作用、结构引用：<a href="https://zhuanlan.zhihu.com/p/72902467">https://zhuanlan.zhihu.com/p/72902467</a></p><p>kafka引用：<a href="https://zhuanlan.zhihu.com/p/74063251">https://zhuanlan.zhihu.com/p/74063251</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; title=&quot;目录&quot;&gt;&lt;/a&gt;目录&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE&quot;&gt;环境搭建机器配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#xsync%E4%B8%8Ersync%E6%96%87%E4%BB%B6%E5%88%86%E5%8F%91&quot;&gt;xsync与rsync文件分发&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ZooKeeper%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA&quot;&gt;ZooKeeper环境搭建&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#Kafka%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA&quot;&gt;Kafka环境搭建&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#Hadoop%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA&quot;&gt;Hadoop环境搭建&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;环境搭建机器配置&quot;&gt;&lt;a href=&quot;#环境搭建机器配置&quot; class=&quot;headerlink&quot; title=&quot;环境搭建机器配置&quot;&gt;&lt;/a&gt;环境搭建机器配置&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;3台机器默认都是 java 1.8.0_321&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;3台服务器配置如下：( 练手不需要这么高的配置，我只是刚好有 : )&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;OS&lt;/th&gt;
&lt;th&gt;CPU&lt;/th&gt;
&lt;th&gt;MEM&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;192.168.128.93&lt;/td&gt;
&lt;td&gt;CentOS 7.9&lt;/td&gt;
&lt;td&gt;8C/8T Intel(R) Xeon(R) Silver 4110 CPU @ 2.10GHz 虚拟机&lt;/td&gt;
&lt;td&gt;16G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;10.54.0.28&lt;/td&gt;
&lt;td&gt;CentOS 7.9&lt;/td&gt;
&lt;td&gt;32C/64T Intel(R) Xeon(R) Silver 4314 CPU @ 2.40GHz 物理机&lt;/td&gt;
&lt;td&gt;256G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;10.54.0.32&lt;/td&gt;
&lt;td&gt;CentOS 7.9&lt;/td&gt;
&lt;td&gt;32C/64T Intel(R) Xeon(R) Silver 4314 CPU @ 2.40GHz 物理机&lt;/td&gt;
&lt;td&gt;256G&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    
    <category term="kafka" scheme="http://example.com/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>Linux获取系统版本信息</title>
    <link href="http://example.com/2023/11/09/Linux%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF/"/>
    <id>http://example.com/2023/11/09/Linux%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF/</id>
    <published>2023-11-09T08:56:06.000Z</published>
    <updated>2023-11-09T08:57:05.561Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p><strong><code>cat /proc/verison</code></strong></p><p>获取内核信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-nodes1 ~]<span class="comment"># cat /proc/version</span></span><br><span class="line">Linux version 3.10.0-1160.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) <span class="comment">#1 SMP Mon Oct 19 16:18:59 UTC 2020</span></span><br></pre></td></tr></table></figure><br><p><strong><code>uname -a</code></strong></p><p>获取内核信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-nodes1 ~]<span class="comment"># uname -a</span></span><br><span class="line">Linux k8s-nodes1 3.10.0-1160.el7.x86_64 <span class="comment">#1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><span id="more"></span><br><p><strong><code>lsb_release -a</code></strong></p><ul><li>获取系统信息</li><li>有些系统会没有 lsb_release 命令  <code>yum install -y redhat-lsb</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-nodes1 ~]<span class="comment"># lsb_release -a</span></span><br><span class="line">LSB Version::core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch</span><br><span class="line">Distributor ID:CentOS</span><br><span class="line">Description:CentOS Linux release 7.9.2009 (Core)</span><br><span class="line">Release:7.9.2009</span><br><span class="line">Codename:Core</span><br></pre></td></tr></table></figure><br><p><strong><code>cat /etc/os-release</code></strong></p><p>获取系统信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-nodes1 ~]<span class="comment"># cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">&quot;CentOS Linux&quot;</span></span><br><span class="line">VERSION=<span class="string">&quot;7 (Core)&quot;</span></span><br><span class="line">ID=<span class="string">&quot;centos&quot;</span></span><br><span class="line">ID_LIKE=<span class="string">&quot;rhel fedora&quot;</span></span><br><span class="line">VERSION_ID=<span class="string">&quot;7&quot;</span></span><br><span class="line">PRETTY_NAME=<span class="string">&quot;CentOS Linux 7 (Core)&quot;</span></span><br><span class="line">ANSI_COLOR=<span class="string">&quot;0;31&quot;</span></span><br><span class="line">CPE_NAME=<span class="string">&quot;cpe:/o:centos:centos:7&quot;</span></span><br><span class="line">HOME_URL=<span class="string">&quot;https://www.centos.org/&quot;</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">&quot;https://bugs.centos.org/&quot;</span></span><br><span class="line"></span><br><span class="line">CENTOS_MANTISBT_PROJECT=<span class="string">&quot;CentOS-7&quot;</span></span><br><span class="line">CENTOS_MANTISBT_PROJECT_VERSION=<span class="string">&quot;7&quot;</span></span><br><span class="line">REDHAT_SUPPORT_PRODUCT=<span class="string">&quot;centos&quot;</span></span><br><span class="line">REDHAT_SUPPORT_PRODUCT_VERSION=<span class="string">&quot;7&quot;</span></span><br></pre></td></tr></table></figure><br><p><strong><code>cat /etc/redhat-release</code></strong></p><p>仅适用于 Readhat 系的 Linux</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-nodes1 ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.9.2009 (Core)</span><br></pre></td></tr></table></figure><br><p><strong><code>hostnamectl</code></strong></p><p>获取系统信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-nodes1 ~]<span class="comment"># hostnamectl</span></span><br><span class="line">   Static hostname: k8s-nodes1</span><br><span class="line">         Icon name: computer-server</span><br><span class="line">           Chassis: server</span><br><span class="line">        Machine ID: ab3142cf29f34983b5f55182b177a3e8</span><br><span class="line">           Boot ID: e3964313f7f741678d8a0c3f93998be3</span><br><span class="line">  Operating System: CentOS Linux 7 (Core)</span><br><span class="line">       CPE OS Name: cpe:/o:centos:centos:7</span><br><span class="line">            Kernel: Linux 3.10.0-1160.el7.x86_64</span><br><span class="line">      Architecture: x86-64</span><br></pre></td></tr></table></figure><br><p><strong>准确获取系统版本号</strong></p><p><strong>方式一</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/redhat-release|sed -r <span class="string">&#x27;s/.* ([0-9]+)\..*/\1/&#x27;</span></span><br></pre></td></tr></table></figure><br><p><strong>方式二</strong></p><p>有些系统会没有 lsb_release 命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a|grep -e Release|awk -F <span class="string">&quot;:&quot;</span> <span class="string">&#x27;&#123; print $2 &#125;&#x27;</span> | awk -F <span class="string">&quot;.&quot;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | sed <span class="string">&#x27;s/[[:space:]]//g&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>转自：<a href="https://www.cnblogs.com/poloyy/p/15489803.html">小菠萝测试笔记</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;&lt;code&gt;cat /proc/verison&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;获取内核信息&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@k8s-nodes1 ~]&lt;span class=&quot;comment&quot;&gt;# cat /proc/version&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Linux version 3.10.0-1160.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) &lt;span class=&quot;comment&quot;&gt;#1 SMP Mon Oct 19 16:18:59 UTC 2020&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;br&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;uname -a&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;获取内核信息&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@k8s-nodes1 ~]&lt;span class=&quot;comment&quot;&gt;# uname -a&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Linux k8s-nodes1 3.10.0-1160.el7.x86_64 &lt;span class=&quot;comment&quot;&gt;#1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="测试" scheme="http://example.com/tags/%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
</feed>
